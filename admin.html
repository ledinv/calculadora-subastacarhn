<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text) }
    header { background:var(--blue); color:#fff; padding:1rem }
    header .logo { font-size:1.5rem; font-weight:bold }
    header nav ul { list-style:none; display:flex; gap:1rem }
    header nav a { color:#fff; text-decoration:none }
    #adminApp { display:none; max-width:var(--max-width); margin:1rem auto }
    .tabs { display:flex; border-bottom:2px solid var(--blue2) }
    .tab { flex:1; padding:.75rem; background:var(--blue2); color:#fff; text-align:center; cursor:pointer; font-weight:600 }
    .tab.active { background:var(--blue) }
    .section { display:none; background:#fff; border-radius:8px; box-shadow:0 2px 10px var(--shadow); margin-top:1rem; padding:1rem }
    .section.active { display:block }

    /* Pedidos */
    #orderFormContainer { margin-bottom:1rem; }
    #orderFormContainer .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    #orderFormContainer input,
    #orderFormContainer select,
    #orderFormContainer textarea,
    #orderFormContainer button { width:100%; margin:.5rem 0; padding:.75rem; border:1px solid #ccc; border-radius:4px; font-size:1rem }
    #orderFormContainer button { background:var(--yellow); color:var(--blue); border:none; font-weight:600; cursor:pointer }
    #orderFormContainer h3 { margin-bottom:.5rem }

    footer { background:var(--blue); color:#fff; padding:1rem; text-align:center; margin-top:2rem }
  </style>
</head>
<body>

  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <div id="adminApp">

    <div class="tabs">
      <div class="tab active" data-sec="ped">Pedidos</div>
      <!-- ...puedes agregar otras pestañas aquí -->
    </div>

    <!-- SECCIÓN PEDIDOS -->
    <div id="section-ped" class="section active">

      <!-- Botón Nuevo / Editar Pedido -->
      <button id="btnNewOrder" style="background:var(--blue);color:#fff;padding:.5rem 1rem;border:none;border-radius:4px;cursor:pointer;">
        + Nuevo Pedido
      </button>

      <!-- Formulario Pedido -->
      <div id="orderFormContainer" style="display:none;">
        <h3 id="orderFormTitle">Nuevo Pedido</h3>
        <form id="formularioOrder">

          <div class="form-grid">
            <!-- Cliente + Teléfono -->
            <select id="orderClient" required>
              <option value="">Selecciona cliente…</option>
            </select>
            <input id="orderClientPhone" placeholder="Teléfono" readonly/>

            <!-- Copart URL -->
            <input id="orderVehicleURL" type="url" placeholder="Copart URL" required/>

            <!-- Fotos del Carro -->
            <input id="orderCopartPhotos" type="file" multiple accept="image/*"/>
          </div>

          <div class="form-grid">
            <!-- Factura -->
            <input id="orderCopartInvoice" type="file" accept="application/pdf"/>
            <!-- Estado Inicial -->
            <select id="orderStatus">
              <option>Inicio</option>
              <option>Pago Pendiente</option>
            </select>
          </div>

          <!-- 1) Recogida -->
          <div style="margin-top:1rem;">
            <label><input type="checkbox" id="chkRecogida"/> Gestión de recogida completada</label>
            <div class="form-grid">
              <input id="valorGrua" type="number" placeholder="Costo grúa (USD)" disabled/>
              <input id="valorBarco" type="number" placeholder="Costo barco (USD)" disabled/>
            </div>
          </div>

          <!-- 2) Envío a Honduras -->
          <div style="margin-top:1rem;">
            <label><input type="checkbox" id="chkHndArrived"/> Llegada a Honduras completada</label>
            <textarea id="textoEnvioHnd" rows="2" placeholder="Detalles de envío" disabled></textarea>
          </div>

          <!-- 3) Nacionalización -->
          <div style="margin-top:1rem;">
            <label><input type="checkbox" id="chkAduana"/> Pago aduana completado</label>
            <textarea id="textoAduana" rows="2" placeholder="Detalles aduana" disabled></textarea>
          </div>

          <!-- 4) Entrega Final -->
          <div style="margin-top:1rem;">
            <label><input type="checkbox" id="chkEntrega"/> Entrega final completada</label>
            <div class="form-grid">
              <input id="fotosEntrega" type="file" multiple accept="image/*" disabled/>
              <input id="precioFinal" type="number" placeholder="Precio final (LPS)" disabled/>
            </div>
          </div>

          <!-- Botones -->
          <div style="margin-top:1rem; display:flex; gap:10px;">
            <button type="submit">Guardar Pedido</button>
            <button id="btnCancelOrder" type="button" style="background:#e74c3c;color:#fff;">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- Filtros -->
      <div style="display:flex; gap:10px; margin:1rem 0;">
        <select id="statusFilter">
          <option value="">Todos</option>
          <option value="Inicio">Inicio</option>
          <option value="Pago Pendiente">Pago Pendiente</option>
          <option value="Pagado">Pagado</option>
          <option value="Finalizado">Finalizado</option>
        </select>
        <select id="clientFilter">
          <option value="">Todos los clientes</option>
        </select>
      </div>

      <!-- Tabla de Pedidos -->
      <table style="width:100%;border-collapse:collapse;font-size:.9rem;">
        <thead>
          <tr style="background:var(--blue2);color:#fff;">
            <th style="padding:.5rem;border:1px solid #ddd;">Cliente</th>
            <th style="padding:.5rem;border:1px solid #ddd;">Email</th>
            <th style="padding:.5rem;border:1px solid #ddd;">Teléfono</th>
            <th style="padding:.5rem;border:1px solid #ddd;">Vehículo</th>
            <th style="padding:.5rem;border:1px solid #ddd;">Estado</th>
            <th style="padding:.5rem;border:1px solid #ddd;">Acciones</th>
          </tr>
        </thead>
        <tbody id="ordersTableBody"></tbody>
      </table>

    </div>
  </div>

  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage().ref();

    let clientsCache = [], ordersCache = [], editingOrderId = null;

    // UI elements
    const orderFormContainer = document.getElementById('orderFormContainer');
    const formularioOrder    = document.getElementById('formularioOrder');
    const orderClient        = document.getElementById('orderClient');
    const orderClientPhone   = document.getElementById('orderClientPhone');
    const orderVehicleURL    = document.getElementById('orderVehicleURL');
    const orderCopartPhotos  = document.getElementById('orderCopartPhotos');
    const orderCopartInvoice = document.getElementById('orderCopartInvoice');
    const orderStatus        = document.getElementById('orderStatus');
    const chkRecogida        = document.getElementById('chkRecogida');
    const valorGrua          = document.getElementById('valorGrua');
    const valorBarco         = document.getElementById('valorBarco');
    const chkHndArrived      = document.getElementById('chkHndArrived');
    const textoEnvioHnd      = document.getElementById('textoEnvioHnd');
    const chkAduana          = document.getElementById('chkAduana');
    const textoAduana        = document.getElementById('textoAduana');
    const chkEntrega         = document.getElementById('chkEntrega');
    const fotosEntrega       = document.getElementById('fotosEntrega');
    const precioFinal        = document.getElementById('precioFinal');
    const ordersTableBody    = document.getElementById('ordersTableBody');
    const statusFilter       = document.getElementById('statusFilter');
    const clientFilter       = document.getElementById('clientFilter');

    // pestañas (solo Pedidos aquí)
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick = ()=> {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-'+tab.dataset.sec).classList.add('active');
      };
    });

    firebase.auth().onAuthStateChanged(user=>{
      if(!user) return location='login.html';
      const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
      if(!admins.includes(user.email)) return location='/';
      document.getElementById('adminApp').style.display = 'block';
      initApp();
    });

    function initApp(){
      // cargar clientes
      db.collection('clients').orderBy('fullName').get().then(snap=>{
        clientsCache = [];
        snap.forEach(d=>{
          const u = d.data();
          clientsCache.push(u);
        });
        // llena selects
        orderClient.innerHTML = '<option value="">Selecciona cliente…</option>';
        clientFilter.innerHTML = '<option value="">Todos los clientes</option>';
        clientsCache.forEach(c=>{
          orderClient.innerHTML += `<option value="${c.email}">${c.fullName}</option>`;
          clientFilter.innerHTML += `<option value="${c.fullName}">${c.fullName}</option>`;
        });
      });

      // evento selección cliente
      orderClient.onchange = ()=> {
        const c = clientsCache.find(x=>x.email===orderClient.value);
        orderClientPhone.value = c? c.phone : '';
      };

      // mostrar formulario
      document.getElementById('btnNewOrder').onclick = ()=>{
        editingOrderId = null;
        resetOrderForm();
        orderFormContainer.style.display = 'block';
      };
      document.getElementById('btnCancelOrder').onclick = ()=>{
        orderFormContainer.style.display = 'none';
      };

      // habilitar etapas
      orderCopartInvoice.onchange = ()=> valorGrua.parentNode.parentNode.style.display = 'block';
      chkRecogida.onchange = ()=> {
        valorGrua.disabled = valorBarco.disabled = !chkRecogida.checked;
        if(chkRecogida.checked) chkHndArrived.parentNode.style.display = 'block';
      };
      chkHndArrived.onchange = ()=> {
        textoEnvioHnd.disabled = !chkHndArrived.checked;
        if(chkHndArrived.checked) chkAduana.parentNode.style.display = 'block';
      };
      chkAduana.onchange = ()=> {
        textoAduana.disabled = !chkAduana.checked;
        if(chkAduana.checked) chkEntrega.parentNode.style.display = 'block';
      };
      chkEntrega.onchange = ()=> {
        fotosEntrega.disabled = precioFinal.disabled = !chkEntrega.checked;
      };

      formularioOrder.onsubmit = saveOrder;
      statusFilter.onchange = renderOrders;
      clientFilter.onchange = renderOrders;

      fetchOrders();
    }

    function resetOrderForm(){
      formularioOrder.reset();
      valorGrua.parentNode.parentNode.style.display = 'none';
      chkHndArrived.parentNode.style.display = 'none';
      chkAduana.parentNode.style.display = 'none';
      chkEntrega.parentNode.style.display = 'none';
      [valorGrua,valorBarco,textoEnvioHnd,textoAduana,fotosEntrega,precioFinal]
        .forEach(el=>el.disabled=true);
      document.getElementById('orderFormTitle').innerText = 'Nuevo Pedido';
    }

    function fetchOrders(){
      db.collection('orders').orderBy('createdAt','desc').get().then(snap=>{
        ordersCache = [];
        snap.forEach(d=> ordersCache.push({id:d.id,data:d.data()}));
        renderOrders();
      });
    }

    function renderOrders(){
      ordersTableBody.innerHTML = '';
      const sf = statusFilter.value, cf = clientFilter.value;
      ordersCache.forEach(o=>{
        const d = o.data;
        if(sf && d.status!==sf) return;
        if(cf && d.clientName!==cf) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:.5rem;border:1px solid #ddd;">${d.clientName}</td>
          <td style="padding:.5rem;border:1px solid #ddd;">${d.clientEmail}</td>
          <td style="padding:.5rem;border:1px solid #ddd;">${d.clientPhone}</td>
          <td style="padding:.5rem;border:1px solid #ddd;"><a href="${d.vehicleURL}" target="_blank">Ver</a></td>
          <td style="padding:.5rem;border:1px solid #ddd;">${d.status}</td>
          <td style="padding:.5rem;border:1px solid #ddd;">
            <button style="background:var(--blue);color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;"
              onclick="editOrder('${o.id}')">E</button>
            <button style="background:#e74c3c;color:#fff;padding:4px 8px;border:none;border-radius:4px;cursor:pointer;"
              onclick="deleteOrder('${o.id}')">X</button>
          </td>`;
        ordersTableBody.appendChild(tr);
      });
    }

    function editOrder(id){
      const o = ordersCache.find(x=>x.id===id);
      if(!o) return;
      const d = o.data;
      editingOrderId = id;
      resetOrderForm();
      orderFormContainer.style.display = 'block';
      document.getElementById('orderFormTitle').innerText = 'Editar Pedido';

      // cargar valores
      orderClient.value      = d.clientEmail;
      orderClient.onchange();
      orderVehicleURL.value  = d.vehicleURL;
      orderStatus.value      = d.status;

      // etapas ya completadas
      if(d.copartInvoiceUrl){
        valorGrua.parentNode.parentNode.style.display = 'block';
      }
      if(d.recogida?.done){
        chkRecogida.checked = true;
        chkRecogida.onchange();
        valorGrua.value  = d.recogida.valorGrua;
        valorBarco.value = d.recogida.valorBarco;
      }
      if(d.envioHnd?.done){
        chkHndArrived.checked = true;
        chkHndArrived.onchange();
        textoEnvioHnd.value = d.envioHnd.detail;
      }
      if(d.aduana?.done){
        chkAduana.checked = true;
        chkAduana.onchange();
        textoAduana.value = d.aduana.detail;
      }
      if(d.entrega?.done){
        chkEntrega.checked = true;
        chkEntrega.onchange();
        precioFinal.value = d.entrega.precioFinal;
        // fotosEntrega no se precarga
      }
    }

    function deleteOrder(id){
      if(!confirm('Eliminar este pedido?')) return;
      db.collection('orders').doc(id).delete().then(fetchOrders);
    }

    async function saveOrder(e){
      e.preventDefault();
      const client = clientsCache.find(c=>c.email===orderClient.value);
      const payload = {
        clientName: client.fullName,
        clientEmail: client.email,
        clientPhone: client.phone,
        vehicleURL: orderVehicleURL.value,
        status: orderStatus.value,
        copartPhotos: [],
        copartInvoiceUrl: null,
        recogida:{done:false,valorGrua:0,valorBarco:0},
        envioHnd:{done:false,detail:''},
        aduana:{done:false,detail:''},
        entrega:{done:false,precioFinal:0,deliveryPhotos:[]},
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // subir fotos Copart
      for(let f of orderCopartPhotos.files){
        const snap = await storage.child(`orders/${editingOrderId||'new'}/copart/${f.name}`).put(f);
        payload.copartPhotos.push(await snap.ref.getDownloadURL());
      }
      // subir factura
      if(orderCopartInvoice.files[0]){
        const snap = await storage.child(`orders/${editingOrderId||'new'}/copart/receipt.pdf`).put(orderCopartInvoice.files[0]);
        payload.copartInvoiceUrl = await snap.ref.getDownloadURL();
      }
      // recogida
      if(chkRecogida.checked){
        payload.recogida = {
          done:true,
          valorGrua: +valorGrua.value,
          valorBarco:+valorBarco.value
        };
      }
      // envío HND
      if(chkHndArrived.checked){
        payload.envioHnd = { done:true, detail:textoEnvioHnd.value };
      }
      // aduana
      if(chkAduana.checked){
        payload.aduana = { done:true, detail:textoAduana.value };
      }
      // entrega final
      if(chkEntrega.checked){
        payload.entrega.done = true;
        payload.entrega.precioFinal = +precioFinal.value;
        for(let f of fotosEntrega.files){
          const snap = await storage.child(`orders/${editingOrderId||'new'}/delivery/${f.name}`).put(f);
          payload.entrega.deliveryPhotos.push(await snap.ref.getDownloadURL());
        }
      }

      if(editingOrderId){
        await db.collection('orders').doc(editingOrderId).update(payload);
      } else {
        await db.collection('orders').add(payload);
      }

      orderFormContainer.style.display = 'none';
      fetchOrders();
    }
  </script>
</body>
</html>
