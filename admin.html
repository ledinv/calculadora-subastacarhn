<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--light);
      color: var(--text);
    }
    header, footer {
      background: var(--blue);
      color: #fff;
      padding: 1rem;
    }
    header .logo, footer .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 1rem;
    }
    nav a {
      color: #fff;
      text-decoration: none;
    }
    .container {
      max-width: var(--max-width);
      margin: 2rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
    }
    h1, h2 {
      margin-bottom: 1rem;
      color: var(--blue2);
    }
    /* Formulario */
    input, select, textarea, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background: var(--yellow);
      color: var(--blue);
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .preview img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .progress {
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }
    /* Tablas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.75rem;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: var(--blue2);
      color: #fff;
    }
    img.thumb {
      width: 80px;
      border-radius: 4px;
    }
    .actions button {
      width: auto;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .btn-sold { background: var(--yellow); color: var(--text); }
    .btn-edit { background: var(--blue2); color: #fff; }
    .btn-delete { background: #e74c3c; color: #fff; }
    .btn-copy { background: var(--blue2); color: #fff; }
    #btnCopyAll { width: auto; margin-bottom: 1rem; }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <!-- App solo tras login -->
  <div id="adminApp" style="display:none;">

    <!-- Formulario Agregar / Editar Vehículo -->
    <div class="container">
      <h1 id="formTitle">Agregar Nuevo Vehículo</h1>
      <form id="formularioAuto">
        <label>Marca</label><input type="text" id="marca" required>
        <label>Modelo</label><input type="text" id="modelo" required>
        <label>Motor</label><input type="text" id="motor" required>
        <label>Año</label><input type="number" id="anio" required>
        <label>Precio (Lempiras)</label><input type="number" id="precio" required>
        <label>Kilometraje</label><input type="number" id="kilometraje" required>
        <label>Color</label><input type="text" id="color" required>
        <label>Tipo de Vehículo</label>
        <select id="tipo" required>
          <option value="">Seleccionar...</option>
          <option value="Sedán">Sedán</option>
          <option value="SUV">SUV</option>
          <option value="Pickup">Pickup</option>
          <option value="Camioneta">Camioneta</option>
          <option value="Eléctrico">Eléctrico</option>
        </select>
        <label>Descripción</label><textarea id="descripcion" rows="4" required></textarea>
        <label>Imágenes del Vehículo</label><input type="file" id="imagenes" multiple accept="image/*">
        <div id="preview" class="preview"></div>
        <div id="progresoCarga" class="progress"></div>

        <button id="btnAgregar" type="submit">Agregar al Inventario</button>
        <button id="btnCancelarEdicion" type="button" style="display:none; background:#e74c3c; color:#fff;">
          Cancelar Edición
        </button>
      </form>
      <div id="mensajeExito" style="display:none; text-align:center; color:green; font-weight:bold; margin-top:1rem;">
        ¡Operación completada con éxito!
      </div>
    </div>

    <!-- Gestión de Inventario -->
    <div class="container">
      <h2>Gestión de Inventario</h2>
      <table id="inventory-table">
        <thead>
          <tr>
            <th>Foto</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Año</th>
            <th>Precio</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Usuarios Registrados -->
    <div class="container">
      <h2>Usuarios Registrados</h2>
      <button id="btnCopyAll" class="btn-copy">Copiar todos los teléfonos</button>
      <table id="users-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Teléfono</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- Footer -->
  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Tu Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storageRef = firebase.storage().ref();
    let editingId = null;
    let allPhones = [];

    // Comprueba sesión y permisos
    firebase.auth().onAuthStateChanged(user => {
      if (!user) return window.location.href = 'login.html';
      const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
      if (!admins.includes(user.email)) return window.location.href = '/';
      document.getElementById('adminApp').style.display = 'block';
      initApp();
    });

    function initApp() {
      // Formulario
      document.getElementById('imagenes')
        .addEventListener('change', mostrarPreview);
      document.getElementById('formularioAuto')
        .addEventListener('submit', onSubmit);
      document.getElementById('btnCancelarEdicion')
        .addEventListener('click', resetForm);

      // Botón copiar todos
      document.getElementById('btnCopyAll')
        .addEventListener('click', () => {
          if (!allPhones.length) return alert('No hay números para copiar');
          navigator.clipboard.writeText(allPhones.join(', '))
            .then(()=> alert('Todos los teléfonos copiados'))
            .catch(()=> alert('Error al copiar'));
        });

      // Carga inicial
      fetchVehicles();
      fetchUsers();
    }

    // Muestra miniaturas
    function mostrarPreview() {
      const archivos = document.getElementById('imagenes').files;
      const prev = document.getElementById('preview');
      prev.innerHTML = '';
      for (let f of archivos) {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          prev.appendChild(img);
        };
        reader.readAsDataURL(f);
      }
    }

    // Agregar/Editar
    async function onSubmit(e) {
      e.preventDefault();
      const form = document.getElementById('formularioAuto');
      const data = {
        marca: form.marca.value,
        modelo: form.modelo.value,
        motor: form.motor.value,
        anio: parseInt(form.anio.value,10),
        precio: parseInt(form.precio.value,10),
        kilometraje: parseInt(form.kilometraje.value,10),
        color: form.color.value,
        tipo: form.tipo.value,
        descripcion: form.descripcion.value,
      };
      try {
        if (editingId) {
          await db.collection('inventario').doc(editingId).update(data);
          mensaje('¡Vehículo actualizado!');
        } else {
          const id = `${data.modelo.toLowerCase()}${data.anio}-${Date.now()}`;
          const imgs = document.getElementById('imagenes').files;
          const urls = [];
          for (let f of imgs) {
            const up = await storageRef.child(`inventario/${id}/${f.name}`).put(f);
            urls.push(await up.ref.getDownloadURL());
          }
          Object.assign(data, {
            id, imagenes: urls,
            vendido: false,
            fecha: firebase.firestore.FieldValue.serverTimestamp()
          });
          await db.collection('inventario').doc(id).set(data);
          mensaje('¡Vehículo agregado!');
        }
      } catch(err) {
        return alert(err.message);
      }
      resetForm();
      fetchVehicles();
    }

    // Reset formulario
    function resetForm() {
      const form = document.getElementById('formularioAuto');
      form.reset();
      document.getElementById('preview').innerHTML = '';
      document.getElementById('progresoCarga').textContent = '';
      document.getElementById('formTitle').textContent = 'Agregar Nuevo Vehículo';
      document.getElementById('btnAgregar').textContent = 'Agregar al Inventario';
      document.getElementById('btnCancelarEdicion').style.display = 'none';
      document.getElementById('imagenes').disabled = false;
      editingId = null;
    }

    // Mensaje éxito
    function mensaje(txt) {
      const m = document.getElementById('mensajeExito');
      m.textContent = txt;
      m.style.display = 'block';
      setTimeout(()=> m.style.display='none', 3500);
    }

    // Cargar vehículos
    function fetchVehicles() {
      db.collection('inventario').orderBy('fecha','desc').get()
        .then(snap => {
          const tbody = document.querySelector('#inventory-table tbody');
          tbody.innerHTML = '';
          snap.forEach(doc => {
            const v = doc.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${v.imagenes?.[0]||'Img/default-car.jpg'}" class="thumb"></td>
              <td>${v.marca}</td>
              <td>${v.modelo}</td>
              <td>${v.anio}</td>
              <td>${v.precio.toLocaleString('es-HN')} LPS</td>
              <td>${v.vendido?'Vendido':'Disponible'}</td>
              <td class="actions">
                ${!v.vendido
                  ? `<button class="btn-sold" onclick="markAsSold('${doc.id}')">Marcar vendido</button>`
                  : `<button class="btn-sold" disabled>Vendido</button>`}
                <button class="btn-edit"   onclick="editVehicle('${doc.id}')">Editar</button>
                <button class="btn-delete" onclick="deleteVehicle('${doc.id}')">Eliminar</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }

    function markAsSold(id) {
      if (!confirm('¿Marcar como vendido?')) return;
      db.collection('inventario').doc(id).update({vendido:true})
        .then(fetchVehicles);
    }
    function deleteVehicle(id) {
      if (!confirm('¿Eliminar vehículo?')) return;
      db.collection('inventario').doc(id).delete()
        .then(fetchVehicles);
    }
    function editVehicle(id) {
      db.collection('inventario').doc(id).get()
        .then(doc => {
          const v = doc.data();
          const f = document.getElementById('formularioAuto');
          f.marca.value = v.marca;
          f.modelo.value = v.modelo;
          f.motor.value = v.motor;
          f.anio.value = v.anio;
          f.precio.value = v.precio;
          f.kilometraje.value = v.kilometraje;
          f.color.value = v.color;
          f.tipo.value = v.tipo;
          f.descripcion.value = v.descripcion;
          document.getElementById('formTitle').textContent = 'Editar Vehículo';
          document.getElementById('btnAgregar').textContent = 'Guardar Cambios';
          document.getElementById('btnCancelarEdicion').style.display = 'block';
          document.getElementById('imagenes').disabled = true;
          editingId = id;
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    // Cargar usuarios y popular allPhones
    function fetchUsers() {
      db.collection('clients').orderBy('fullName').get()
        .then(snap => {
          const tbody = document.querySelector('#users-table tbody');
          tbody.innerHTML = '';
          allPhones = [];
          snap.forEach(doc => {
            const u = doc.data();
            allPhones.push(u.phone);
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${u.fullName}</td>
              <td>${u.phone}</td>
              <td>
                <button class="btn-copy" onclick="copyPhone('${u.phone}')">
                  Copiar
                </button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }
    function copyPhone(num) {
      navigator.clipboard.writeText(num)
        .then(()=> alert('Número copiado: '+num))
        .catch(()=> alert('Error al copiar'));
    }

  </script>
</body>
</html>
