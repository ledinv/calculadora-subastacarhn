<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); }
    header { background:var(--blue); color:#fff; padding:1rem; }
    header .logo { font-size:1.5rem; font-weight:bold; }
    header nav ul { list-style:none; display:flex; gap:1rem; }
    header nav a { color:#fff; text-decoration:none; }
    #adminApp { display:none; max-width:var(--max-width); margin:1rem auto; }

    .tabs { display:flex; border-bottom:2px solid var(--blue2); }
    .tab { flex:1; padding:.75rem; background:var(--blue2); color:#fff; text-align:center; cursor:pointer; font-weight:600; }
    .tab.active { background:var(--blue); }
    .section { display:none; background:#fff; border-radius:8px; box-shadow:0 2px 10px var(--shadow); margin-top:1rem; padding:1rem; }
    .section.active { display:block; }

    /* Formulario Añadir/Inventario/Usuarios */
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:1rem; }
    form input, form select, form textarea, form button {
      width:100%; margin:.5rem 0; padding:.75rem; border:1px solid #ccc; border-radius:4px; font-size:1rem;
    }
    form button { background:var(--yellow); color:var(--blue); border:none; font-weight:600; cursor:pointer; }
    .preview img { width:60px; height:60px; object-fit:cover; margin:4px; border:1px solid #ccc; border-radius:4px; }
    .btn-sold { background:var(--yellow); color:var(--text); }
    .btn-edit { background:var(--blue); color:#fff; }
    .btn-delete { background:#e74c3c; color:#fff; }
    .btn-copy { background:var(--blue); color:#fff; padding:4px 8px; border:none; border-radius:4px; cursor:pointer; }

    table { width:100%; border-collapse:collapse; font-size:.9rem; margin-top:.5rem; }
    th, td { padding:.5rem; border:1px solid #ddd; text-align:left; vertical-align:middle; }
    th { background:var(--blue2); color:#fff; }

    /* Tracker de Pedidos */
    .orders-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
    }
    .order-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
      padding: 1rem;
    }
    .order-card h4 { margin-bottom: .5rem; font-size:1.1rem; }
    .tracker {
      list-style: none;
      display: flex;
      gap: .5rem;
      padding: 0;
      margin-bottom: .5rem;
      flex-wrap: wrap;
    }
    .tracker li {
      position: relative;
      padding-left: 1.2rem;
      font-size: .9rem;
    }
    .tracker li::before {
      content: '';
      position: absolute;
      left: 0; top: .1rem;
      width: .8rem; height: .8rem;
      border-radius: 50%;
      background: #ccc;
    }
    .tracker li.done::before { background: var(--yellow); }
    .tracker li.active::before { background: var(--blue); }
    .order-meta { font-size:.8rem; color:#666; margin-top:.5rem; }

    footer { background:var(--blue); color:#fff; padding:1rem; text-align:center; margin-top:2rem; }
  </style>
</head>
<body>
  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <div id="adminApp">
    <div class="tabs">
      <div class="tab active" data-sec="add">Añadir</div>
      <div class="tab" data-sec="inv">Inventario</div>
      <div class="tab" data-sec="usr">Usuarios</div>
      <div class="tab" data-sec="ped">Pedidos</div>
    </div>

    <!-- SECCIÓN AÑADIR -->
    <div id="section-add" class="section active">
      <form id="formularioAuto">
        <div class="form-grid">
          <input id="marca" name="marca" placeholder="Marca" required/>
          <input id="modelo" name="modelo" placeholder="Modelo" required/>
          <input id="motor" name="motor" placeholder="Motor" required/>
          <input id="anio" name="anio" type="number" placeholder="Año" required/>
          <input id="precio" name="precio" type="number" placeholder="Precio (LPS)" required/>
          <input id="kilometraje" name="kilometraje" type="number" placeholder="Kilometraje" required/>
          <input id="color" name="color" placeholder="Color" required/>
          <select id="tipo" name="tipo" required>
            <option value="">Tipo de Vehículo…</option>
            <option>Sedán</option><option>SUV</option><option>Pickup</option><option>Camioneta</option><option>Eléctrico</option>
          </select>
          <textarea id="descripcion" name="descripcion" rows="2" placeholder="Descripción"></textarea>
          <input id="imagenes" name="imagenes" type="file" multiple accept="image/*"/>
        </div>
        <div id="preview" class="preview"></div>
        <button id="btnAgregar" type="submit">Guardar Vehículo</button>
        <button id="btnCancelarEdicion" type="button" style="background:#e74c3c;color:#fff;display:none;">Cancelar</button>
      </form>
    </div>

    <!-- SECCIÓN INVENTARIO -->
    <div id="section-inv" class="section">
      <table id="inventory-table">
        <thead>
          <tr><th>Foto</th><th>Marca</th><th>Modelo</th><th>Año</th><th>Precio</th><th>Est.</th><th>Acc.</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN USUARIOS -->
    <div id="section-usr" class="section">
      <button id="btnCopyAll" class="btn-copy">Copiar todos</button>
      <table id="users-table">
        <thead><tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Acción</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN PEDIDOS -->
    <div id="section-ped" class="section">
      <button id="btnNewOrder" class="btn-copy">+ Nuevo Pedido</button>
      <div id="orderFormContainer" style="display:none;">
        <h3 id="orderFormTitle">Nuevo Pedido</h3>
        <form id="formularioOrder">
          <div class="form-grid">
            <select id="orderClient" required>
              <option value="">Selecciona cliente…</option>
            </select>
            <input id="orderClientPhone" placeholder="Teléfono" readonly/>
            <input id="orderVehicleURL" type="url" placeholder="URL Copart" required/>
          </div>
          <div class="form-grid">
            <label for="orderCopartInvoice">Subir factura (PDF)</label>
            <input id="orderCopartInvoice" type="file" accept="application/pdf" />
            <label for="orderCopartPhotos">Subir fotos del vehículo</label>
            <input id="orderCopartPhotos" type="file" multiple accept="image/*" />
          </div>
          <div class="form-grid">
            <input id="valorGrua" type="number" placeholder="Costo grúa (USD)" required/>
            <input id="valorBarco" type="number" placeholder="Costo barco (USD)" required/>
          </div>
          <div class="form-grid">
            <textarea id="textoEnvioHnd" rows="2" placeholder="Detalles de llegada a HND" required></textarea>
            <textarea id="textoAduana" rows="2" placeholder="Detalles de aduana" required></textarea>
          </div>
          <div class="form-grid">
            <textarea id="textoEntrega" rows="2" placeholder="Detalles de entrega final" required></textarea>
            <input id="precioFinal" type="number" placeholder="Precio final (LPS)" required/>
          </div>
          <div style="margin-top:1rem; display:flex; gap:10px;">
            <button type="submit">Guardar Pedido</button>
            <button id="btnCancelOrder" type="button" style="background:#e74c3c;color:#fff;">Cancelar</button>
          </div>
        </form>
      </div>
      <div style="display:flex; gap:10px; margin:1rem 0;">
        <select id="statusFilter">
          <option value="">Todos los estados</option>
          <option value="Inicio">Inicio</option>
          <option value="Pago Pendiente">Pago Pendiente</option>
          <option value="Pagado">Pagado</option>
          <option value="Finalizado">Finalizado</option>
        </select>
        <select id="clientFilter">
          <option value="">Todos los clientes</option>
        </select>
      </div>
      <div id="ordersContainer" class="orders-grid"></div>
    </div>
  </div>

  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage().ref();

    let clientsCache = [], ordersCache = [], editingOrderId = null, editingVehicleId = null;

    // Pestañas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-'+tab.dataset.sec).classList.add('active');
      };
    });

    // Autenticación
    firebase.auth().onAuthStateChanged(user => {
      if (!user) return location='login.html';
      const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
      if (!admins.includes(user.email)) return location='/';
      document.getElementById('adminApp').style.display='block';
      initApp();
    });

    function initApp() {
      // Vehículos
      document.getElementById('imagenes').onchange = showVehPreview;
      document.getElementById('formularioAuto').onsubmit = saveVehicle;
      document.getElementById('btnCancelarEdicion').onclick = resetVehicleForm;
      fetchVehicles();

      // Usuarios
      document.getElementById('btnCopyAll').onclick = ()=>{
        const all = clientsCache.map(c=>c.phone).join(', ');
        navigator.clipboard.writeText(all).then(()=>alert('Teléfonos copiados'));
      };
      fetchClients();

      // Pedidos
      document.getElementById('btnNewOrder').onclick = ()=>{
        editingOrderId = null;
        resetOrderForm();
        document.getElementById('orderFormContainer').style.display='block';
      };
      document.getElementById('btnCancelOrder').onclick = ()=>{
        document.getElementById('orderFormContainer').style.display='none';
      };
      document.getElementById('orderClient').onchange = ()=>{
        const c = clientsCache.find(x=>x.email===orderClient.value);
        orderClientPhone.value = c? c.phone : '';
      };
      document.getElementById('statusFilter').onchange = renderOrders;
      document.getElementById('clientFilter').onchange = renderOrders;
      document.getElementById('formularioOrder').onsubmit = saveOrder;
      fetchOrders();
    }

    /* ——— Vehículos ——— */
    function showVehPreview() {
      const pr = document.getElementById('preview'); pr.innerHTML='';
      Array.from(imagenes.files).forEach(f=>{
        const r=new FileReader();
        r.onload=e=>pr.innerHTML+=`<img src="${e.target.result}"/>`;
        r.readAsDataURL(f);
      });
    }
    async function saveVehicle(e){
      e.preventDefault();
      const f=e.target;
      const data = {
        marca:f.marca.value, modelo:f.modelo.value, motor:f.motor.value,
        anio:+f.anio.value, precio:+f.precio.value,
        kilometraje:+f.kilometraje.value, color:f.color.value,
        tipo:f.tipo.value, descripcion:f.descripcion.value
      };
      if(editingVehicleId){
        await db.collection('inventario').doc(editingVehicleId).update(data);
      } else {
        const id=`${data.modelo.toLowerCase()}${data.anio}-${Date.now()}`;
        const urls=[];
        for(let file of imagenes.files){
          const up=await storage.child(`inventario/${id}/${file.name}`).put(file);
          urls.push(await up.ref.getDownloadURL());
        }
        Object.assign(data,{
          id, imagenes:urls, vendido:false,
          fecha:firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('inventario').doc(id).set(data);
      }
      resetVehicleForm();
      fetchVehicles();
    }
    function resetVehicleForm(){
      editingVehicleId=null;
      formularioAuto.reset();
      preview.innerHTML='';
      btnCancelarEdicion.style.display='none';
      btnAgregar.textContent='Guardar Vehículo';
    }
    function fetchVehicles(){
      db.collection('inventario').orderBy('fecha','desc').get().then(snap=>{
        const tb=document.querySelector('#inventory-table tbody');
        tb.innerHTML='';
        snap.forEach(async d=>{
          const v=d.data();
          let imgUrl='';
          if(v.imagenes?.[0]){
            try{ imgUrl=await firebase.storage().refFromURL(v.imagenes[0]).getDownloadURL(); }
            catch(e){ console.warn('IMG:',e); }
          }
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><img src="${imgUrl}" class="thumb"/></td>
            <td>${v.marca}</td><td>${v.modelo}</td><td>${v.anio}</td>
            <td>${v.precio} LPS</td><td>${v.vendido? 'Vendido':'Disp.'}</td>
            <td class="actions">
              ${!v.vendido
                ? `<button class="btn-sold" onclick="markSold('${d.id}')">V</button>`
                : `<button class="btn-sold" disabled>V</button>`}
              <button class="btn-edit" onclick="editVehicle('${d.id}')">E</button>
              <button class="btn-delete" onclick="deleteVehicle('${d.id}')">X</button>
            </td>`;
          tb.appendChild(tr);
        });
      });
    }
    function markSold(id){
      if(confirm('¿Marcar vendido?')){
        db.collection('inventario').doc(id).update({vendido:true}).then(fetchVehicles);
      }
    }
    function deleteVehicle(id){
      if(confirm('¿Eliminar este vehículo?')){
        db.collection('inventario').doc(id).delete().then(fetchVehicles);
      }
    }
    function editVehicle(id){
      db.collection('inventario').doc(id).get().then(doc=>{
        const v=doc.data();
        ['marca','modelo','motor','anio','precio','kilometraje','color','tipo','descripcion']
          .forEach(k=>document.getElementById(k).value=v[k]||'');
        editingVehicleId=id;
        btnAgregar.textContent='Guardar Cambios';
        btnCancelarEdicion.style.display='inline-block';
        window.scrollTo({top:0,behavior:'smooth'});
      });
    }

    /* ——— Usuarios ——— */
    function fetchClients(){
      db.collection('clients').orderBy('fullName').get().then(snap=>{
        clientsCache=[];
        const tb=document.querySelector('#users-table tbody');
        tb.innerHTML='';
        snap.forEach(d=>{
          const u=d.data(); clientsCache.push(u);
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${u.fullName}</td>
            <td>${u.email}</td>
            <td>${u.phone}</td>
            <td><button class="btn-copy" onclick="navigator.clipboard.writeText('${u.phone}')">Copiar</button></td>`;
          tb.appendChild(tr);
        });
      });
    }

    /* ——— Pedidos en tiempo real ——— */
    function resetOrderForm(){
      formularioOrder.reset();
      orderFormTitle.innerText='Nuevo Pedido';
    }
    function fetchOrders(){
      db.collection('orders')
        .orderBy('updatedAt','desc')
        .onSnapshot(snap=>{
          ordersCache=[];
          snap.forEach(doc=>ordersCache.push({id:doc.id,data:doc.data()}));
          // filtro clientes
          const clientSel=document.getElementById('clientFilter');
          const names=[...new Set(ordersCache.map(o=>o.data.clientName))];
          clientSel.innerHTML='<option value="">Todos los clientes</option>';
          names.forEach(n=>clientSel.innerHTML+=`<option value="${n}">${n}</option>`);
          renderOrders();
        });
    }
    function renderOrders(){
      const sf=statusFilter.value, cf=clientFilter.value;
      const cont=document.getElementById('ordersContainer');
      cont.innerHTML='';
      const steps=['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];
      ordersCache.forEach(o=>{
        const d=o.data;
        if(sf && d.status!==sf) return;
        if(cf && d.clientName!==cf) return;
        const trackerItems=steps.map(step=>{
          const idxStep=steps.indexOf(step), idxSt=steps.indexOf(d.status);
          const cls= idxStep<idxSt? 'done': idxStep===idxSt? 'active':'' ;
          return `<li class="${cls}">${step}</li>`;
        }).join('');
        const updated=d.updatedAt?.toDate().toLocaleString('es-HN')||'';
        const card=document.createElement('div');
        card.className='order-card';
        card.innerHTML=`
          <h4>${d.clientName}</h4>
          <ul class="tracker">${trackerItems}</ul>
          <p><strong>Factura:</strong> ${d.copartInvoiceUrl? `<a href="${d.copartInvoiceUrl}" target="_blank">Ver</a>`:'-'}</p>
          <p><strong>Fotos:</strong> ${d.copartPhotos?.length? `<a href="${d.copartPhotos[0]}" target="_blank">Ver</a>`:'-'}</p>
          <p><strong>Grua:</strong> ${d.recogida?.valorGrua||'-'} USD</p>
          <p><strong>Barco:</strong> ${d.recogida?.valorBarco||'-'} USD</p>
          <p><strong>Llegada HND:</strong> ${d.envioHnd?.detail||'-'}</p>
          <p><strong>Aduana:</strong> ${d.aduana?.detail||'-'}</p>
          <p><strong>Entrega:</strong> ${d.entrega?.detail||'-'}</p>
          <p><strong>Precio final:</strong> ${d.entrega?.precioFinal||'-'} LPS</p>
          <p class="order-meta">Última actualización: ${updated}</p>
          <div style="margin-top:.5rem;">
            <button class="btn-edit" onclick="editOrder('${o.id}')">Editar</button>
            <button class="btn-delete" onclick="deleteOrder('${o.id}')">Eliminar</button>
          </div>`;
        cont.appendChild(card);
      });
    }
    async function saveOrder(e){
      e.preventDefault();
      const client=clientsCache.find(c=>c.email===orderClient.value);
      const payload={
        clientName:client.fullName, clientEmail:client.email, clientPhone:client.phone,
        vehicleURL:orderVehicleURL.value, status:'Inicio',
        copartPhotos:[], copartInvoiceUrl:null,
        recogida:{valorGrua:+valorGrua.value,valorBarco:+valorBarco.value},
        envioHnd:{detail:textoEnvioHnd.value},
        aduana:{detail:textoAduana.value},
        entrega:{detail:textoEntrega.value,precioFinal:+precioFinal.value},
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      };
      for(let f of orderCopartPhotos.files){
        const snap=await storage.child(`orders/${editingOrderId||'new'}/copart/${f.name}`).put(f);
        payload.copartPhotos.push(await snap.ref.getDownloadURL());
      }
      if(orderCopartInvoice.files[0]){
        const snap=await storage.child(`orders/${editingOrderId||'new'}/receipt.pdf`).put(orderCopartInvoice.files[0]);
        payload.copartInvoiceUrl=await snap.ref.getDownloadURL();
      }
      if(editingOrderId){
        payload.updatedAt=firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('orders').doc(editingOrderId).update(payload);
      } else {
        await db.collection('orders').add(payload);
      }
      document.getElementById('orderFormContainer').style.display='none';
    }
    function editOrder(id){
      const o=ordersCache.find(x=>x.id===id);
      if(!o) return;
      editingOrderId=id; resetOrderForm(); orderFormContainer.style.display='block';
      orderFormTitle.innerText='Editar Pedido';
      const d=o.data;
      orderClient.value=d.clientEmail; orderClient.onchange();
      orderVehicleURL.value=d.vehicleURL;
      valorGrua.value=d.recogida?.valorGrua||'';
      valorBarco.value=d.recogida?.valorBarco||'';
      textoEnvioHnd.value=d.envioHnd?.detail||'';
      textoAduana.value=d.aduana?.detail||'';
      textoEntrega.value=d.entrega?.detail||'';
      precioFinal.value=d.entrega?.precioFinal||'';
    }
    function deleteOrder(id){
      if(!confirm('¿Eliminar este pedido?')) return;
      db.collection('orders').doc(id).delete();
    }
  </script>
</body>
</html>
