<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administrador de Inventario | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    input, select, textarea { width: 100%; padding: 10px; margin-top: 8px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; }
    label { font-weight: bold; }
    button { padding: 10px 20px; background: #ffc20e; color: #002f6c; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .preview img { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ccc; }
    .progress { text-align: center; margin-top: 10px; font-weight: bold; color: green; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center;">Agregar Nuevo Vehículo</h1>
  <form id="formularioAuto">
    <label>Marca</label>
    <input type="text" id="marca" required>
    <label>Modelo</label>
    <input type="text" id="modelo" required>
    <label>Motor</label>
    <input type="text" id="motor" required>
    <label>Año</label>
    <input type="number" id="anio" required>
    <label>Precio (Lempiras)</label>
    <input type="number" id="precio" required>
    <label>Kilometraje</label>
    <input type="number" id="kilometraje" required>
    <label>Color</label>
    <input type="text" id="color" required>
    <label>Tipo de Vehículo</label>
    <select id="tipo" required>
      <option value="">Seleccionar...</option>
      <option value="Sedán">Sedán</option>
      <option value="SUV">SUV</option>
      <option value="Pickup">Pickup</option>
      <option value="Camioneta">Camioneta</option>
      <option value="Eléctrico">Eléctrico</option>
    </select>
    <label>Descripción</label>
    <textarea id="descripcion" rows="4" required></textarea>
    <label>Imágenes del Vehículo</label>
    <input type="file" id="imagenes" multiple accept="image/*" required>
    <div id="preview" class="preview"></div>
    <div class="progress" id="progresoCarga"></div>
    <button id="btnAgregar" type="submit" disabled>Agregar al Inventario</button>
  </form>
  <div id="mensajeExito" style="display:none; text-align:center; color:green; margin-top:20px; font-weight:bold;">
    ¡Vehículo agregado exitosamente!
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
    authDomain: "subastacarhn-40554.firebaseapp.com",
    projectId: "subastacarhn-40554",
    storageBucket: "subastacarhn-40554.appspot.com",
    messagingSenderId: "536785797974",
    appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
    measurementId: "G-QM5N60K8C0"
  };
  firebase.initializeApp(firebaseConfig);

  // Autenticación anónima para desarrollo
  firebase.auth().signInAnonymously()
    .catch(err => console.error("Error de Auth:", err));

  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      console.log("Usuario autenticado (anon):", user.uid);
      initApp();
    }
  });

  function initApp() {
    const db = firebase.firestore();
    const storageRef = firebase.storage().ref();
    const formulario = document.getElementById('formularioAuto');
    const imagenesInput = document.getElementById('imagenes');
    const preview = document.getElementById('preview');
    const progresoCarga = document.getElementById('progresoCarga');
    const btnAgregar = document.getElementById('btnAgregar');

    // Preview de miniaturas
    imagenesInput.addEventListener('change', () => {
      preview.innerHTML = '';
      btnAgregar.disabled = true;
      const archivos = imagenesInput.files;
      for (const f of archivos) {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement('img');
          img.src = e.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(f);
      }
      if (archivos.length) {
        progresoCarga.textContent = "Listo para subir imágenes";
        btnAgregar.disabled = false;
      }
    });

    // Manejo del submit
    formulario.addEventListener('submit', async e => {
      e.preventDefault();
      btnAgregar.disabled = true;
      progresoCarga.textContent = "Subiendo imágenes...";

      try {
        const archivos = imagenesInput.files;
        console.log("Archivos a subir:", archivos);
        if (!archivos.length) throw new Error("Selecciona al menos una imagen.");

        const id = `${document.getElementById('modelo').value.toLowerCase()}${document.getElementById('anio').value}-${Date.now()}`;
        const imagenesURLs = [];

        // Subida de cada archivo
        for (const archivo of archivos) {
          console.log("Subiendo:", archivo.name);
          const fileRef = storageRef.child(`inventario/${id}/${archivo.name}`);
          const snap = await fileRef.put(archivo);
          const url = await snap.ref.getDownloadURL();
          imagenesURLs.push(url);
        }
        console.log("URLs obtenidas:", imagenesURLs);

        progresoCarga.textContent = "Guardando en Firestore...";

        // Documento a guardar
        const nuevoAuto = {
          id,
          marca: document.getElementById('marca').value,
          modelo: document.getElementById('modelo').value,
          motor: document.getElementById('motor').value,
          anio: parseInt(document.getElementById('anio').value, 10),
          precio: parseInt(document.getElementById('precio').value, 10),
          kilometraje: parseInt(document.getElementById('kilometraje').value, 10),
          color: document.getElementById('color').value,
          tipo: document.getElementById('tipo').value,
          descripcion: document.getElementById('descripcion').value,
          imagenes: imagenesURLs,
          vendido: false,
          fecha: firebase.firestore.FieldValue.serverTimestamp()
        };
        console.log("Guardando documento:", nuevoAuto);

        await db.collection('inventario').doc(id).set(nuevoAuto);

        // Reset y mensaje de éxito
        formulario.reset();
        preview.innerHTML = '';
        progresoCarga.textContent = '';
        document.getElementById('mensajeExito').style.display = 'block';
        setTimeout(() => {
          document.getElementById('mensajeExito').style.display = 'none';
        }, 4000);

      } catch (error) {
        console.error("Error al agregar vehículo:", error);
        alert(error.message || 'Ocurrió un error al agregar el vehículo.');
      } finally {
        btnAgregar.disabled = false;
      }
    });
  }
</script>

</body>
</html>
