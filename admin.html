<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); }

    /* Header (idéntico a index.html) */
    header {
      background: var(--blue);
      color: #fff;
      padding: 1rem;
    }
    header .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }
    header nav ul {
      list-style: none;
      display: flex;
      gap: 1rem;
    }
    header nav a {
      color: #fff;
      text-decoration: none;
    }

    /* Contenedor general */
    #adminApp {
      max-width: var(--max-width);
      margin: 1rem auto;
    }

    /* Pestañas */
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--blue2);
    }
    .tab {
      flex: 1;
      padding: 0.75rem;
      background: var(--blue2);
      color: #fff;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active {
      background: var(--blue);
    }

    /* Secciones */
    .section {
      display: none;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px var(--shadow);
      margin-top: 1rem;
    }
    .section.active {
      display: block;
    }

    /* Formulario compacto */
    form input, form select, form textarea, form button {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.75rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    form button {
      background: var(--yellow);
      color: var(--blue);
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .preview img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      margin: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    /* Tablas compactas */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.5rem;
      border: 1px solid #ddd;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: var(--blue2);
      color: #fff;
    }
    img.thumb {
      width: 50px;
      border-radius: 4px;
    }
    .actions button {
      margin-right: 4px;
      padding: 0.25rem 0.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .btn-sold { background: var(--yellow); color: var(--text); }
    .btn-edit { background: var(--blue); color: #fff; }
    .btn-delete { background: #e74c3c; color: #fff; }
    .btn-copy, #btnCopyAll {
      background: var(--blue);
      color: #fff;
      padding: 0.5rem;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    /* Footer (idéntico a index.html) */
    footer {
      background: var(--blue);
      color: #fff;
      padding: 1rem;
      text-align: center;
      margin-top: 2rem;
    }
    footer .logo {
      font-size: 1.5rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <!-- HEADER idéntico -->
  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <!-- ADMIN APP -->
  <div id="adminApp" style="display:none;">

    <!-- PESTAÑAS -->
    <div class="tabs">
      <div class="tab active" data-sec="add">Añadir</div>
      <div class="tab" data-sec="inv">Inventario</div>
      <div class="tab" data-sec="usr">Usuarios (<span id="userCount">0</span>)</div>
    </div>

    <!-- SECCIÓN AÑADIR -->
    <div id="section-add" class="section active">
      <form id="formularioAuto">
        <input id="marca" placeholder="Marca" required/>
        <input id="modelo" placeholder="Modelo" required/>
        <input id="motor" placeholder="Motor" required/>
        <input id="anio" type="number" placeholder="Año" required/>
        <input id="precio" type="number" placeholder="Precio (LPS)" required/>
        <input id="kilometraje" type="number" placeholder="Kilometraje" required/>
        <input id="color" placeholder="Color" required/>
        <select id="tipo" required>
          <option value="">Tipo de Vehículo…</option>
          <option>Sedán</option>
          <option>SUV</option>
          <option>Pickup</option>
          <option>Camioneta</option>
          <option>Eléctrico</option>
        </select>
        <textarea id="descripcion" rows="2" placeholder="Descripción"></textarea>
        <input id="imagenes" type="file" multiple accept="image/*"/>
        <div class="preview" id="preview"></div>
        <button id="btnAgregar" type="submit">Guardar Vehículo</button>
        <div id="mensajeExito" style="display:none;color:green;text-align:center;margin-top:5px;">
          ¡Éxito!
        </div>
      </form>
    </div>

    <!-- SECCIÓN INVENTARIO -->
    <div id="section-inv" class="section">
      <table id="inventory-table">
        <thead>
          <tr>
            <th>Foto</th><th>Marca</th><th>Modelo</th>
            <th>Año</th><th>Precio</th><th>Est.</th><th>Acc.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN USUARIOS -->
    <div id="section-usr" class="section">
      <button id="btnCopyAll">Copiar todos</button>
      <table id="users-table">
        <thead>
          <tr><th>Nombre</th><th>Teléfono</th><th>Acción</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- FOOTER idéntico -->
  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs & Lógica JS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Tu configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storageRef = firebase.storage().ref();
    let editingId = null, allPhones = [];

    // Manejo de pestañas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-'+tab.dataset.sec).classList.add('active');
      };
    });

    // Autenticación + carga inicial
    firebase.auth().onAuthStateChanged(u => {
      if (!u) return location='login.html';
      const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
      if (!admins.includes(u.email)) return location='/';
      document.getElementById('adminApp').style.display='block';
      initApp();
    });

    function initApp() {
      fetchUsers();
      fetchVehicles();
      document.getElementById('btnCopyAll').onclick = () => {
        if (!allPhones.length) return alert('No hay números');
        navigator.clipboard.writeText(allPhones.join(', '))
          .then(()=>alert('Copiado'))
          .catch(()=>alert('Error'));
      };
      document.getElementById('imagenes').onchange = previewImgs;
      document.getElementById('formularioAuto').onsubmit = onSubmit;
    }

    function previewImgs() {
      const files=this.files, pr=document.getElementById('preview');
      pr.innerHTML='';
      Array.from(files).forEach(f=>{
        const r=new FileReader();
        r.onload=e=>pr.innerHTML+=`<img src="${e.target.result}"/>`;
        r.readAsDataURL(f);
      });
    }

    async function onSubmit(e) {
      e.preventDefault();
      const f=e.target;
      const data = {
        marca:f.marca.value,
        modelo:f.modelo.value,
        motor:f.motor.value,
        anio:+f.anio.value,
        precio:+f.precio.value,
        kilometraje:+f.kilometraje.value,
        color:f.color.value,
        tipo:f.tipo.value,
        descripcion:f.descripcion.value
      };
      try {
        if (editingId) {
          await db.collection('inventario').doc(editingId).update(data);
        } else {
          const id=`${data.modelo.toLowerCase()}${data.anio}-${Date.now()}`;
          const urls=[];
          for (let file of f.imagenes.files) {
            const up = await storageRef.child(`inventario/${id}/${file.name}`).put(file);
            urls.push(await up.ref.getDownloadURL());
          }
          Object.assign(data, {
            id, imagenes:urls,
            vendido:false,
            fecha:firebase.firestore.FieldValue.serverTimestamp()
          });
          await db.collection('inventario').doc(id).set(data);
        }
        document.getElementById('mensajeExito').style.display='block';
        setTimeout(()=>document.getElementById('mensajeExito').style.display='none',2000);
        f.reset(); document.getElementById('preview').innerHTML='';
        fetchVehicles();
      } catch(err) {
        alert(err.message);
      }
    }

    function fetchVehicles() {
      db.collection('inventario').orderBy('fecha','desc').get().then(snap=>{
        const tb=document.querySelector('#inventory-table tbody');
        tb.innerHTML='';
        snap.forEach(d=>{
          const v=d.data();
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td><img src="${v.imagenes?.[0]||''}" class="thumb"/></td>
            <td>${v.marca}</td><td>${v.modelo}</td>
            <td>${v.anio}</td><td>${v.precio} LPS</td>
            <td>${v.vendido?'Vendido':'Disp.'}</td>
            <td class="actions">
              ${!v.vendido
                ?`<button class="btn-sold" onclick="markSold('${d.id}')">V</button>`
                :`<button class="btn-sold" disabled>V</button>`}
              <button class="btn-edit" onclick="edit('${d.id}')">E</button>
              <button class="btn-delete" onclick="del('${d.id}')">X</button>
            </td>`;
          tb.appendChild(tr);
        });
      });
    }
    function markSold(id){ if(confirm('Vendido?')) db.collection('inventario').doc(id).update({vendido:true}).then(fetchVehicles); }
    function del(id){ if(confirm('Eliminar?')) db.collection('inventario').doc(id).delete().then(fetchVehicles); }
    function edit(id){
      db.collection('inventario').doc(id).get().then(doc=>{
        const v=doc.data(), f=document.getElementById('formularioAuto');
        Object.keys(v).forEach(k=>{ if(f[k]) f[k].value=v[k]; });
        editingId=id;
      });
    }

    function fetchUsers() {
      db.collection('clients').orderBy('fullName').get().then(snap=>{
        const tb=document.querySelector('#users-table tbody');
        tb.innerHTML=''; allPhones=[];
        snap.forEach(d=>{
          const u=d.data(); allPhones.push(u.phone);
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${u.fullName}</td>
            <td>${u.phone}</td>
            <td><button class="btn-copy" onclick="navigator.clipboard.writeText('${u.phone}')">C</button></td>`;
          tb.appendChild(tr);
        });
        document.getElementById('userCount').textContent = allPhones.length;
      });
    }
  </script>
</body>
</html>
