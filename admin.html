<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root { /*…misma definición…*/ }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { /*…mismos estilos…*/ }
    /*…resto de estilos intactos…*/
  </style>
</head>
<body>

<header>
  <div class="logo">SubastaCarHN</div>
  <nav>
    <ul>
      <li><a href="index.html">Inicio</a></li>
      <li><a href="inventario.html">Inventario</a></li>
      <li><a href="admin.html">Admin</a></li>
      <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
    </ul>
  </nav>
</header>

<div id="adminApp">
  <div class="tabs">
    <div class="tab active" data-sec="add">Añadir</div>
    <div class="tab" data-sec="inv">Inventario</div>
    <div class="tab" data-sec="usr">Usuarios (<span id="userCount">0</span>)</div>
    <div class="tab" data-sec="ped">Pedidos</div>
  </div>

  <!-- SECCIÓN AÑADIR VEHÍCULO -->
  <div id="section-add" class="section active">
    <!-- …tu formulario de vehículos original sin cambios… -->
  </div>

  <!-- SECCIÓN INVENTARIO -->
  <div id="section-inv" class="section">
    <!-- …tu tabla de inventario original… -->
  </div>

  <!-- SECCIÓN USUARIOS -->
  <div id="section-usr" class="section">
    <!-- …tu tabla de usuarios original… -->
  </div>

  <!-- SECCIÓN PEDIDOS -->
  <div id="section-ped" class="section">
    <button id="btnNewOrder" class="btn-copy">+ Nuevo Pedido</button>

    <div id="orderFormContainer" style="display:none;">
      <h3 id="orderFormTitle">Nuevo Pedido</h3>
      <form id="formularioOrder" novalidate>
        <!-- Cliente -->
        <div class="form-grid">
          <select id="orderClient">
            <option value="">Selecciona cliente…</option>
          </select>
          <input id="orderClientPhone" placeholder="Teléfono" readonly/>
        </div>

        <!-- *** NUEVO: Comprobante de depósito *** -->
        <div class="form-grid">
          <label for="orderDepositReceipt">Subir comprobante de depósito (LPS)</label>
          <input id="orderDepositReceipt"
                 name="orderDepositReceipt"
                 type="file"
                 accept="application/pdf,image/*"/>
        </div>

        <!-- URL Copart y Precio estimado -->
        <div class="form-grid">
          <input id="orderVehicleURL" type="url" placeholder="URL Copart"/>
          <input id="precioEstimado" type="number" placeholder="Precio estimado (USD)"/>
        </div>

        <!-- …el resto de tu formulario va aquí (factura Copart, fotos, grúa, barco, etc.)… -->
        <!-- Factura Copart y Fotos Copart -->
        <div class="form-grid">
          <label for="orderCopartInvoice">Subir factura (PDF)</label>
          <input id="orderCopartInvoice"
                 name="orderCopartInvoice"
                 type="file"
                 accept="application/pdf"/>
          <label for="orderCopartPhotos">Subir fotos Copart</label>
          <input id="orderCopartPhotos"
                 name="orderCopartPhotos"
                 type="file"
                 multiple
                 accept="image/*"/>
        </div>

        <!-- Costos de grúa y barco -->
        <div class="form-grid">
          <input id="valorGrua"
                 name="valorGrua"
                 type="number"
                 placeholder="Costo grúa (USD)"/>
          <input id="valorBarco"
                 name="valorBarco"
                 type="number"
                 placeholder="Costo barco (USD)"/>
        </div>

        <!-- Detalles de llegada y aduana -->
        <div class="form-grid">
          <textarea id="textoEnvioHnd"
                    name="textoEnvioHnd"
                    rows="2"
                    placeholder="Detalles de llegada a HND"></textarea>
          <textarea id="textoAduana"
                    name="textoAduana"
                    rows="2"
                    placeholder="Detalles de aduana"></textarea>
        </div>

        <!-- Detalles de entrega y precio final -->
        <div class="form-grid">
          <textarea id="textoEntrega"
                    name="textoEntrega"
                    rows="2"
                    placeholder="Detalles de entrega final"></textarea>
          <input id="precioFinal"
                 name="precioFinal"
                 type="number"
                 placeholder="Precio final (LPS)"/>
        </div>

        <!-- Fotos de entrega final -->
        <div class="form-grid">
          <label for="fotosEntregaFinal">Fotos entrega final</label>
          <input id="fotosEntregaFinal"
                 name="fotosEntregaFinal"
                 type="file"
                 multiple
                 accept="image/*"/>
          <div></div>
        </div>

        <!-- Botones -->
        <div style="margin-top:1rem; display:flex; gap:10px;">
          <button type="submit">Guardar Pedido</button>
          <button id="btnCancelOrder"
                  type="button"
                  style="background:#e74c3c;color:#fff;">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <!-- Filtros -->
    <div class="orders-filters">
      <select id="statusFilter">
        <option value="">Todos los estados</option>
        <option>Inicio</option>
        <option>Pago Pendiente</option>
        <option>Pagado</option>
        <option>Enviado</option>
        <option>Aduana</option>
        <option>Finalizado</option>
      </select>
      <select id="clientFilter">
        <option value="">Todos los clientes</option>
      </select>
    </div>

    <!-- Contenedor de tarjetas -->
    <div id="ordersContainer" class="orders-grid"></div>
  </div>
</div>

<!-- Lightbox Modal -->
<div id="lightbox" class="lightbox">
  <span class="lightbox-close">&times;</span>
  <img class="lightbox-img" src="" />
  <div class="lightbox-nav">
    <button id="lightbox-prev">&larr;</button>
    <button id="lightbox-next">&rarr;</button>
  </div>
</div>

<footer>
  <div class="logo">SubastaCarHN</div>
  <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
</footer>
<!-- Parte 3: Scripts y lógica de Pedidos (subida y visualización de depósito) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
  // Inicializar Firebase
  firebase.initializeApp({
    apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
    authDomain: "subastacarhn-40554.firebaseapp.com",
    projectId: "subastacarhn-40554",
    storageBucket: "subastacarhn-40554.firebasestorage.app",
    messagingSenderId: "536785797974",
    appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7"
  });
  const db = firebase.firestore();
  const storage = firebase.storage().ref();

  let clientsCache = [], ordersCache = [], editingOrderId = null;
  const STEPS = ['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];

  // Pestañas
  document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('section-' + tab.dataset.sec).classList.add('active');
    };
  });

  // Autenticación y arranque
  firebase.auth().onAuthStateChanged(user => {
    if (!user) return location = 'login.html';
    const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
    if (!admins.includes(user.email)) return location = '/';
    document.getElementById('adminApp').style.display = 'block';
    initApp();
  });

  function initApp() {
    document.getElementById('btnNewOrder').onclick = () => {
      editingOrderId = null;
      resetOrderForm();
      fetchClients().then(() => {
        document.getElementById('orderFormContainer').style.display = 'block';
      });
    };
    document.getElementById('btnCancelOrder').onclick = () => {
      document.getElementById('orderFormContainer').style.display = 'none';
    };
    document.getElementById('orderClient').onchange = () => {
      const c = clientsCache.find(x => x.email === orderClient.value);
      orderClientPhone.value = c ? c.phone : '';
    };
    document.getElementById('statusFilter').onchange = renderOrders;
    document.getElementById('clientFilter').onchange = renderOrders;
    document.getElementById('formularioOrder').onsubmit = saveOrder;
    fetchClients();
    fetchOrders();
  }

  // — Clientes —
  async function fetchClients() {
    const snap = await db.collection('clients').orderBy('fullName').get();
    clientsCache = snap.docs.map(d => d.data());
    const sel = document.getElementById('orderClient');
    sel.innerHTML = '<option value="">Selecciona cliente…</option>';
    clientsCache.forEach(u => {
      sel.innerHTML += `<option value="${u.email}">${u.fullName}</option>`;
    });
    document.getElementById('userCount').textContent = clientsCache.length;
  }

  // — Pedidos —
  function getDisplayStatus(d) {
    if (d.entrega?.deliveryPhotos?.length) return 'Finalizado';
    if (d.aduana?.detail) return 'Aduana';
    if (d.recogida?.valorGrua || d.recogida?.valorBarco) return 'Enviado';
    if (d.copartInvoiceUrl) return 'Pagado';
    if (d.depositReceiptUrl) return 'Pago Pendiente';
    if (d.vehicleURL) return 'Pago Pendiente';
    return 'Inicio';
  }

  function fetchOrders() {
    db.collection('orders').orderBy('createdAt','desc')
      .onSnapshot(snap => {
        ordersCache = snap.docs.map(d => ({ id: d.id, data: d.data() }));
        renderOrders();
      });
  }

  function renderOrders() {
    const sf = statusFilter.value, cf = clientFilter.value;
    ordersContainer.innerHTML = '';
    ordersCache.forEach(o => {
      const d = o.data, disp = getDisplayStatus(d);
      if (sf && disp !== sf) return;
      if (cf && d.clientName !== cf) return;

      // Cabecera
      const header = `
        <div class="accordion-header" data-acc="${o.id}">
          <div><strong>#${o.id.slice(0,6)}</strong> ${d.clientName}</div>
          <div>
            <span class="status-badge">${disp}</span>
            <button class="btn-edit-inline" onclick="editOrder('${o.id}')">Editar</button>
            <button class="btn-delete-inline" onclick="deleteOrder('${o.id}')">Eliminar</button>
          </div>
        </div>`;

      // Galerías Copart y Entrega
      const copartG = d.copartPhotos?.length
        ? `<a href="#" class="toggle-detail" data-detail="cp-${o.id}">Fotos Copart</a>
           <div id="cp-${o.id}" class="gallery" style="display:none;">
             ${d.copartPhotos.map(u=>`<img src="${u}" class="thumb"/>`).join('')}
           </div>` : '-';
      const delivG = d.entrega?.deliveryPhotos?.length
        ? `<a href="#" class="toggle-detail" data-detail="dp-${o.id}">Fotos Entrega</a>
           <div id="dp-${o.id}" class="gallery" style="display:none;">
             ${d.entrega.deliveryPhotos.map(u=>`<img src="${u}" class="thumb"/>`).join('')}
           </div>` : '-';

      // Resumen con comprobante de depósito
      const summary = `
        <ul class="summary">
          <li><strong>Depósito:</strong> ${d.depositAmount||'-'} LPS</li>
          <li><strong>Comprobante Depósito:</strong>
            ${d.depositReceiptUrl
              ? `<a href="#" class="toggle-detail" data-detail="dep-${o.id}">Ver Comprobante</a>
                 <div id="dep-${o.id}" style="display:none;margin:.5rem 0;">
                   <a href="${d.depositReceiptUrl}" target="_blank">Abrir PDF/Imagen</a>
                 </div>`
              : '-'}
          </li>
          <li><strong>Estimado:</strong> ${d.precioEstimado||'-'} USD</li>
          <li><strong>Factura Copart:</strong>
            ${d.copartInvoiceUrl
              ? `<a href="#" class="toggle-detail" data-detail="inv-${o.id}">Ver Factura</a>
                 <div id="inv-${o.id}" style="display:none;margin:.5rem 0;">
                   <iframe src="${d.copartInvoiceUrl}" width="100%" height="200px"></iframe>
                 </div>`
              : '-'}
          </li>
          <li><strong>Fotos Copart:</strong> ${copartG}</li>
          <li><strong>Grúa:</strong> ${d.recogida?.valorGrua||'-'} USD</li>
          <li><strong>Barco:</strong> ${d.recogida?.valorBarco||'-'} USD</li>
          <li><strong>Fotos Entrega:</strong> ${delivG}</li>
          <li><strong>Precio Final:</strong> ${d.entrega?.precioFinal||'-'} LPS</li>
        </ul>`;

      // Armar tarjeta
      const card = document.createElement('div');
      card.className = 'order-card';
      card.innerHTML = header + `
        <div id="acc-${o.id}" class="accordion-content">
          <ul class="tracker">
            ${STEPS.map((s,i)=>{
              const cls = i < STEPS.indexOf(disp) ? 'done'
                        : i===STEPS.indexOf(disp)? 'active' : '';
              return `<li class="${cls}">${s}</li>`;
            }).join('')}
          </ul>
          ${summary}
          <p class="order-meta">
            Última actualización: ${d.updatedAt?.toDate().toLocaleString('es-HN')||'-'}
          </p>
        </div>`;
      ordersContainer.appendChild(card);
    });

    // Hooks acordeón y toggles
    document.querySelectorAll('.accordion-header').forEach(h => {
      h.onclick = () =>
        document.getElementById('acc-' + h.dataset.acc).classList.toggle('open');
    });
    document.querySelectorAll('.toggle-detail').forEach(a => {
      a.onclick = e => {
        e.preventDefault();
        const tgt = document.getElementById(a.dataset.detail);
        tgt.style.display = tgt.style.display==='none'?'block':'none';
      };
    });
    initLightboxHooks();
  }

  // Guardar Pedido con depósito
  async function saveOrder(e) {
    e.preventDefault();
    const c = clientsCache.find(x=>x.email===orderClient.value) || {};
    let payload = {
      clientName: c.fullName||'',
      clientEmail: c.email||'',
      clientPhone: c.phone||'',
      vehicleURL: orderVehicleURL.value||'',
      precioEstimado: +precioEstimado.value||0,
      depositAmount: 5000,
      depositReceiptUrl: null,
      copartPhotos: [], copartInvoiceUrl: null,
      recogida: { valorGrua:+valorGrua.value||0, valorBarco:+valorBarco.value||0 },
      envioHnd: { detail:textoEnvioHnd.value||'' },
      aduana: { detail:textoAduana.value||'' },
      entrega: { detail:textoEntrega.value||'', precioFinal:+precioFinal.value||0, deliveryPhotos:[] },
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Subir comprobante de depósito
    if (orderDepositReceipt.files[0]) {
      const f = orderDepositReceipt.files[0];
      const snapDep = await storage
        .child(`orders/${editingOrderId||'new'}/deposit/${f.name}`)
        .put(f);
      payload.depositReceiptUrl = await snapDep.ref.getDownloadURL();
    }

    // Subir fotos Copart
    for (let f of orderCopartPhotos.files) {
      const snap = await storage
        .child(`orders/${editingOrderId||'new'}/copart/${f.name}`)
        .put(f);
      payload.copartPhotos.push(await snap.ref.getDownloadURL());
    }
    // Subir factura Copart
    if (orderCopartInvoice.files[0]) {
      const snapInv = await storage
        .child(`orders/${editingOrderId||'new'}/receipt.pdf`)
        .put(orderCopartInvoice.files[0]);
      payload.copartInvoiceUrl = await snapInv.ref.getDownloadURL();
    }
    // Subir fotos entrega
    for (let f of fotosEntregaFinal.files) {
      const snap = await storage
        .child(`orders/${editingOrderId||'new'}/delivery/${f.name}`)
        .put(f);
      payload.entrega.deliveryPhotos.push(await snap.ref.getDownloadURL());
    }

    if (editingOrderId)
      await db.collection('orders').doc(editingOrderId).update(payload);
    else
      await db.collection('orders').add(payload);

    document.getElementById('orderFormContainer').style.display = 'none';
  }

  function editOrder(id) {
    /* …igual a tu original… */
  }
  function resetOrderForm() {
    formularioOrder.reset();
    orderFormTitle.innerText = 'Nuevo Pedido';
  }
  function deleteOrder(id) {
    if (confirm('¿Eliminar este pedido?'))
      db.collection('orders').doc(id).delete();
  }
</script>
<!-- Parte 4: Lightbox y cierre del documento -->
<script>
  // Lightbox para galería de imágenes
  let lbGallery = [], lbIndex = 0;
  const lbEl = document.getElementById('lightbox');
  const lbImg = document.querySelector('.lightbox-img');
  const btnPrev = document.getElementById('lightbox-prev');
  const btnNext = document.getElementById('lightbox-next');
  const btnClose = document.querySelector('.lightbox-close');

  function initLightboxHooks() {
    document.querySelectorAll('.gallery img').forEach(img => {
      img.style.cursor = 'pointer';
      img.onclick = () => {
        const container = img.parentNode;
        lbGallery = Array.from(container.querySelectorAll('img')).map(i => i.src);
        lbIndex = lbGallery.indexOf(img.src);
        lbEl.style.display = 'flex';
        lbImg.src = lbGallery[lbIndex];
      };
    });
  }

  btnPrev.onclick = () => {
    lbIndex = (lbIndex - 1 + lbGallery.length) % lbGallery.length;
    lbImg.src = lbGallery[lbIndex];
  };
  btnNext.onclick = () => {
    lbIndex = (lbIndex + 1) % lbGallery.length;
    lbImg.src = lbGallery[lbIndex];
  };
  btnClose.onclick = () => {
    lbEl.style.display = 'none';
  };
  lbEl.onclick = e => {
    if (e.target === lbEl) btnClose.onclick();
  };

  // Inicializa hooks al cargar las tarjetas
  document.addEventListener('DOMContentLoaded', () => {
    initLightboxHooks();
  });
</script>
</body>
</html>
