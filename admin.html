<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text) }
    header { background:var(--blue); color:#fff; padding:1rem }
    header .logo { font-size:1.5rem; font-weight:bold }
    header nav ul { list-style:none; display:flex; gap:1rem }
    header nav a { color:#fff; text-decoration:none }
    #adminApp { display:none; max-width:var(--max-width); margin:1rem auto }
    .tabs { display:flex; border-bottom:2px solid var(--blue2) }
    .tab { flex:1; padding:.75rem; background:var(--blue2); color:#fff; text-align:center; cursor:pointer; font-weight:600 }
    .tab.active { background:var(--blue) }
    .section { display:none; background:#fff; border-radius:8px; box-shadow:0 2px 10px var(--shadow); margin-top:1rem; padding:1rem }
    .section.active { display:block }
    /* Inventario/Formulario común */
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:1rem }
    form input, form select, form textarea, form button {
      width:100%; margin:.5rem 0; padding:.75rem; border:1px solid #ccc; border-radius:4px; font-size:1rem
    }
    form button { background:var(--yellow); color:var(--blue); border:none; font-weight:600; cursor:pointer }
    .preview { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .preview img { width:100px; height:100px; object-fit:cover; border-radius:8px; border:1px solid #ccc }
    .progress { text-align:center; margin-top:10px; font-weight:bold; color:green }
    /* Tablas */
    table { width:100%; border-collapse:collapse; font-size:.9rem; margin-top:.5rem }
    th, td { padding:.5rem; border:1px solid #ddd; text-align:left; vertical-align:middle }
    th { background:var(--blue2); color:#fff }
    img.thumb { width:50px; border-radius:4px }
    .actions button { margin-right:4px; padding:4px 8px; border:none; border-radius:4px; cursor:pointer }
    .btn-edit { background:var(--blue); color:#fff }
    .btn-delete { background:#e74c3c; color:#fff }
    .btn-copy { background:var(--blue); color:#fff; padding:4px 8px; margin-bottom:.5rem }
    /* Pedido */
    #orderFormContainer { background:#f9f9f9; padding:1rem; border-radius:6px; margin-bottom:1rem }
    #orderFormContainer h3 { margin-bottom:.5rem }
    .preview-order { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px }
    .preview-order img { width:60px; height:60px; object-fit:cover; border-radius:4px; border:1px solid #ccc }
    .progress-order { text-align:center; margin-top:8px; font-weight:bold; color:green }
    footer { background:var(--blue); color:#fff; padding:1rem; text-align:center; margin-top:2rem }
  </style>
</head>
<body>

  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <div id="adminApp">

    <!-- Pestañas -->
    <div class="tabs">
      <div class="tab active" data-sec="inv">Inventario</div>
      <div class="tab" data-sec="usr">Usuarios (<span id="userCount">0</span>)</div>
      <div class="tab" data-sec="ped">Pedidos</div>
    </div>

    <!-- Inventario -->
    <div id="section-inv" class="section active">
      <h2>Agregar / Editar Vehículo</h2>
      <form id="formularioAuto">
        <div class="form-grid">
          <input id="marca" placeholder="Marca" required/>
          <input id="modelo" placeholder="Modelo" required/>
          <input id="motor" placeholder="Motor" required/>
          <input id="anio" type="number" placeholder="Año" required/>
          <input id="precio" type="number" placeholder="Precio (LPS)" required/>
          <input id="kilometraje" type="number" placeholder="Kilometraje" required/>
          <input id="color" placeholder="Color" required/>
          <select id="tipo" required>
            <option value="">Tipo…</option>
            <option>Sedán</option><option>SUV</option><option>Pickup</option><option>Camioneta</option><option>Eléctrico</option>
          </select>
          <textarea id="descripcion" rows="2" placeholder="Descripción"></textarea>
          <input id="imagenes" type="file" multiple accept="image/*"/>
        </div>
        <div id="preview" class="preview"></div>
        <div id="progresoInv" class="progress"></div>
        <button id="btnAgregar" type="submit">Guardar Vehículo</button>
      </form>

      <table id="inventory-table">
        <thead>
          <tr><th>Foto</th><th>Marca</th><th>Modelo</th><th>Año</th><th>Precio</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Usuarios -->
    <div id="section-usr" class="section">
      <button id="btnCopyAll" class="btn-copy">Copiar todos los teléfonos</button>
      <table id="users-table">
        <thead><tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Acción</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Pedidos -->
    <div id="section-ped" class="section">
      <button id="btnNewOrder" class="btn-copy">+ Nuevo Pedido</button>

      <!-- Formulario Pedido -->
      <div id="orderFormContainer" style="display:none;">
        <h3 id="orderFormTitle">Nuevo Pedido</h3>
        <form id="formularioOrder">
          <div class="form-grid">
            <select id="orderClient" required>
              <option value="">Selecciona cliente…</option>
            </select>
            <input id="orderClientPhone" placeholder="Teléfono" readonly/>

            <input id="orderVehicleURL" type="url" placeholder="Copart URL" required/>

            <input id="orderCopartPhotos" type="file" multiple accept="image/*"/>
            <div id="previewOrderCopart" class="preview-order"></div>
            <div id="progressOrderCopart" class="progress-order"></div>

            <input id="orderCopartInvoice" type="file" accept="application/pdf"/>

            <select id="orderStatus">
              <option>Inicio</option>
              <option>Pago Pendiente</option>
              <option>Pagado</option>
            </select>
          </div>

          <!-- Recogida -->
          <div id="recogidaSection" style="display:none; margin-top:1rem;">
            <label><input type="checkbox" id="chkRecogida"/> Gestión de recogida completada</label>
            <div class="form-grid">
              <input id="valorGrua" type="number" placeholder="Costo grúa (USD)" disabled/>
              <input id="valorBarco" type="number" placeholder="Costo barco (USD)" disabled/>
            </div>
          </div>

          <!-- Envío Honduras -->
          <div id="hndSection" style="display:none; margin-top:1rem;">
            <label><input type="checkbox" id="chkHndArrived"/> Llegada a Honduras completada</label>
            <textarea id="textoEnvioHnd" rows="2" placeholder="Detalles de envío" disabled style="width:100%;margin-top:8px;"></textarea>
          </div>

          <!-- Aduana -->
          <div id="aduanaSection" style="display:none; margin-top:1rem;">
            <label><input type="checkbox" id="chkAduana"/> Pago aduana completado</label>
            <textarea id="textoAduana" rows="2" placeholder="Detalles aduana" disabled style="width:100%;margin-top:8px;"></textarea>
          </div>

          <!-- Entrega Final -->
          <div id="entregaSection" style="display:none; margin-top:1rem;">
            <label><input type="checkbox" id="chkEntrega"/> Entrega final completada</label>
            <div class="form-grid">
              <input id="fotosEntrega" type="file" multiple accept="image/*" disabled/>
              <div id="previewEntrega" class="preview-order"></div>
              <div id="progressEntrega" class="progress-order"></div>
              <input id="precioFinal" type="number" placeholder="Precio final (LPS)" disabled/>
            </div>
          </div>

          <div style="margin-top:1rem; display:flex; gap:10px;">
            <button id="btnSaveOrder" type="submit">Guardar Pedido</button>
            <button id="btnCancelOrder" type="button" style="background:#e74c3c;color:#fff;">Cancelar</button>
          </div>
        </form>
      </div>

      <!-- Filtros -->
      <div style="display:flex; gap:10px; margin:1rem 0;">
        <select id="statusFilter">
          <option value="">Todos</option>
          <option value="Inicio">Inicio</option>
          <option value="Pago Pendiente">Pago Pendiente</option>
          <option value="Pagado">Pagado</option>
          <option value="Finalizado">Finalizado</option>
        </select>
        <select id="clientFilter">
          <option value="">Todos los clientes</option>
        </select>
      </div>

      <table id="orders-table">
        <thead>
          <tr><th>Cliente</th><th>Email</th><th>Teléfono</th><th>Vehículo</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Configurar Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web=e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);

    const db      = firebase.firestore();
    const storage = firebase.storage().ref();
    let editingVehicleId = null, editingOrderId = null;
    const clientsCache = [], ordersCache = [];

    // Manejo de pestañas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-'+tab.dataset.sec).classList.add('active');
      };
    });

    // Autenticación
    firebase.auth().onAuthStateChanged(u => {
      if (!u) return location='login.html';
      const admins = ['ledinvvv@gmail.com','ledinvvv1995@yopmail.com'];
      if (!admins.includes(u.email)) return location='/';
      document.getElementById('adminApp').style.display='block';
      initApp();
    });

    function initApp(){
      /*** INVENTARIO ***/
      document.getElementById('imagenes').addEventListener('change', ()=>{
        const pr = document.getElementById('preview');
        pr.innerHTML = '';
        Array.from(imagenes.files).forEach(f=>{
          const r = new FileReader();
          r.onload = e=>{
            const img = document.createElement('img');
            img.src = e.target.result;
            pr.appendChild(img);
          };
          r.readAsDataURL(f);
        });
      });
      document.getElementById('formularioAuto').addEventListener('submit', async e=>{
        e.preventDefault();
        const f = e.target;
        const data = {
          marca: f.marca.value,
          modelo: f.modelo.value,
          motor: f.motor.value,
          anio: +f.anio.value,
          precio: +f.precio.value,
          kilometraje: +f.kilometraje.value,
          color: f.color.value,
          tipo: f.tipo.value,
          descripcion: f.descripcion.value
        };
        const id = editingVehicleId || `${data.modelo.toLowerCase()}${data.anio}-${Date.now()}`;
        if (!editingVehicleId){
          document.getElementById('progresoInv').textContent = 'Subiendo imágenes…';
          const urls = [];
          for (let file of f.imagenes.files){
            const snap = await storage.child(`inventario/${id}/${file.name}`).put(file);
            urls.push(await snap.ref.getDownloadURL());
          }
          Object.assign(data,{ id, imagenes: urls, vendido:false, fecha: firebase.firestore.FieldValue.serverTimestamp() });
          await db.collection('inventario').doc(id).set(data);
        } else {
          await db.collection('inventario').doc(id).update(data);
        }
        f.reset();
        document.getElementById('preview').innerHTML='';
        document.getElementById('progresoInv').textContent='';
        editingVehicleId = null;
        fetchVehicles();
      });
      function fetchVehicles(){
        db.collection('inventario').orderBy('fecha','desc').get().then(snap=>{
          const tb = document.querySelector('#inventory-table tbody');
          tb.innerHTML = '';
          snap.forEach(d=>{
            const v = d.data();
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td><img src="${v.imagenes[0]||''}" class="thumb"/></td>
              <td>${v.marca}</td>
              <td>${v.modelo}</td>
              <td>${v.anio}</td>
              <td>${v.precio} LPS</td>
              <td class="actions">
                <button class="btn-edit" onclick="editVehicle('${d.id}')">E</button>
                <button class="btn-delete" onclick="deleteVehicle('${d.id}')">X</button>
              </td>`;
            tb.appendChild(tr);
          });
        });
      }
      window.editVehicle = id => {
        db.collection('inventario').doc(id).get().then(doc=>{
          const v = doc.data(), f = document.getElementById('formularioAuto');
          ['marca','modelo','motor','anio','precio','kilometraje','color','tipo','descripcion']
            .forEach(k=> f[k].value = v[k]||'');
          editingVehicleId = id;
          tabClick('inv'); // cambiar a pestaña Inventario/Formulario
        });
      };
      window.deleteVehicle = id => {
        if (confirm('Eliminar?')) db.collection('inventario').doc(id).delete().then(fetchVehicles);
      };
      fetchVehicles();

      /*** CLIENTES ***/
      db.collection('clients').orderBy('fullName').get().then(snap=>{
        const tb = document.querySelector('#users-table tbody'),
              sel = document.getElementById('orderClient'),
              filt = document.getElementById('clientFilter');
        tb.innerHTML = '';
        sel.innerHTML = '<option value="">Selecciona cliente…</option>';
        filt.innerHTML = '<option value="">Todos los clientes</option>';
        snap.forEach(d=>{
          const u = d.data();
          clientsCache.push(u);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.fullName}</td>
            <td>${u.email}</td>
            <td>${u.phone}</td>
            <td><button class="btn-copy" onclick="navigator.clipboard.writeText('${u.phone}')">Copiar</button></td>`;
          tb.appendChild(tr);
          sel.innerHTML += `<option value="${u.email}">${u.fullName}</option>`;
          filt.innerHTML += `<option value="${u.fullName}">${u.fullName}</option>`;
        });
        document.getElementById('userCount').textContent = clientsCache.length;
      });

      /*** PEDIDOS ***/
      document.getElementById('btnNewOrder').onclick = ()=>{ editingOrderId=null; showOrderForm(); };
      document.getElementById('btnCancelOrder').onclick = hideOrderForm;
      document.getElementById('orderClient').onchange = e=>{
        const c = clientsCache.find(x=>x.email===e.target.value);
        document.getElementById('orderClientPhone').value = c? c.phone:'';
      };
      document.getElementById('orderCopartPhotos').onchange = ()=>{
        const pr = document.getElementById('previewOrderCopart');
        pr.innerHTML='';
        Array.from(orderCopartPhotos.files).forEach(f=>{
          const r=new FileReader();
          r.onload=e=>{
            const img=document.createElement('img');
            img.src=e.target.result;
            pr.appendChild(img);
          };
          r.readAsDataURL(f);
        });
      };
      document.getElementById('fotosEntrega').onchange = ()=>{
        const pr = document.getElementById('previewEntrega');
        pr.innerHTML='';
        Array.from(fotosEntrega.files).forEach(f=>{
          const r=new FileReader();
          r.onload=e=>{
            const img=document.createElement('img');
            img.src=e.target.result;
            pr.appendChild(img);
          };
          r.readAsDataURL(f);
        });
      };
      orderCopartInvoice.onchange = ()=> document.getElementById('recogidaSection').style.display='block';
      chkRecogida.onchange = e=>{
        valorGrua.disabled = !e.target.checked;
        valorBarco.disabled = !e.target.checked;
        if(e.target.checked) document.getElementById('hndSection').style.display='block';
      };
      chkHndArrived.onchange = e=>{
        textoEnvioHnd.disabled = !e.target.checked;
        if(e.target.checked) document.getElementById('aduanaSection').style.display='block';
      };
      chkAduana.onchange = e=>{
        textoAduana.disabled = !e.target.checked;
        if(e.target.checked) document.getElementById('entregaSection').style.display='block';
      };
      chkEntrega.onchange = e=>{
        fotosEntrega.disabled = !e.target.checked;
        precioFinal.disabled = !e.target.checked;
      };
      document.getElementById('formularioOrder').addEventListener('submit', async e=>{
        e.preventDefault();
        const f = e.target;
        const client = clientsCache.find(c=>c.email===f.orderClient.value);
        const id = editingOrderId || db.collection('orders').doc().id;
        const payload = {
          clientName: client.fullName,
          clientEmail: client.email,
          clientPhone: client.phone,
          vehicleURL: f.orderVehicleURL.value,
          status: f.orderStatus.value,
          copartPhotos: [], copartInvoiceUrl:null,
          recogida:{done:false,valorGrua:0,valorBarco:0},
          envioHnd:{done:false,detail:''},
          aduana:{done:false,detail:''},
          entrega:{done:false,precioFinal:0,deliveryPhotos:[]},
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        // subir Copart photos
        if(orderCopartPhotos.files.length){
          document.getElementById('progressOrderCopart').textContent='Subiendo fotos Copart…';
          for(let file of orderCopartPhotos.files){
            const snap = await storage.child(`orders/${id}/copart/${file.name}`).put(file);
            payload.copartPhotos.push(await snap.ref.getDownloadURL());
          }
        }
        // factura Copart
        if(orderCopartInvoice.files[0]){
          const snap = await storage.child(`orders/${id}/copart/receipt.pdf`).put(orderCopartInvoice.files[0]);
          payload.copartInvoiceUrl = await snap.ref.getDownloadURL();
        }
        // recogida
        if(chkRecogida.checked){
          payload.recogida = {
            done:true,
            valorGrua:Number(valorGrua.value),
            valorBarco:Number(valorBarco.value)
          };
        }
        // envío HND
        if(chkHndArrived.checked){
          payload.envioHnd = { done:true, detail:textoEnvioHnd.value };
        }
        // aduana
        if(chkAduana.checked){
          payload.aduana = { done:true, detail:textoAduana.value };
        }
        // entrega final
        if(chkEntrega.checked){
          payload.entrega.done = true;
          payload.entrega.precioFinal = Number(precioFinal.value);
          if(fotosEntrega.files.length){
            document.getElementById('progressEntrega').textContent='Subiendo fotos Entrega…';
            for(let file of fotosEntrega.files){
              const snap = await storage.child(`orders/${id}/delivery/${file.name}`).put(file);
              payload.entrega.deliveryPhotos.push(await snap.ref.getDownloadURL());
            }
          }
        }
        // guardar
        if(editingOrderId){
          await db.collection('orders').doc(id).update(payload);
        } else {
          payload.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('orders').doc(id).set(payload);
        }
        hideOrderForm();
        fetchOrders();
      });
      // filtros y tabla
      document.getElementById('btnCopyAll').onclick = ()=>{
        navigator.clipboard.writeText(clientsCache.map(c=>c.phone).join(', '));
        alert('Teléfonos copiados');
      };
      document.getElementById('statusFilter').onchange = renderOrders;
      document.getElementById('clientFilter').onchange = renderOrders;

      fetchOrders();

      function fetchOrders(){
        db.collection('orders').orderBy('createdAt','desc').get().then(snap=>{
          ordersCache.length=0;
          snap.forEach(d=>ordersCache.push({id:d.id,data:d.data()}));
          renderOrders();
        });
      }
      window.editOrder = id=>{
        const o = ordersCache.find(x=>x.id===id);
        if(!o) return;
        const d = o.data, f = document.getElementById('formularioOrder');
        f.orderClient.value = d.clientEmail;
        document.getElementById('orderClientPhone').value = d.clientPhone;
        f.orderVehicleURL.value = d.vehicleURL;
        f.orderStatus.value = d.status;
        // recarga previews si existen
        if(d.copartPhotos?.length){
          const pr = document.getElementById('previewOrderCopart');
          pr.innerHTML = '';
          d.copartPhotos.forEach(u=>{
            const img=document.createElement('img');
            img.src=u; pr.appendChild(img);
          });
        }
        if(d.recogida?.done){
          chkRecogida.checked=true;
          valorGrua.disabled=false; valorGrua.value=d.recogida.valorGrua||'';
          valorBarco.disabled=false; valorBarco.value=d.recogida.valorBarco||'';
          document.getElementById('hndSection').style.display='block';
        }
        if(d.envioHnd?.done){
          chkHndArrived.checked=true;
          textoEnvioHnd.disabled=false; textoEnvioHnd.value=d.envioHnd.detail||'';
          document.getElementById('aduanaSection').style.display='block';
        }
        if(d.aduana?.done){
          chkAduana.checked=true;
          textoAduana.disabled=false; textoAduana.value=d.aduana.detail||'';
          document.getElementById('entregaSection').style.display='block';
        }
        if(d.entrega?.done){
          chkEntrega.checked=true;
          precioFinal.disabled=false; precioFinal.value=d.entrega.precioFinal||'';
          fotosEntrega.disabled=false;
          const pr2=document.getElementById('previewEntrega');
          pr2.innerHTML='';
          d.entrega.deliveryPhotos.forEach(u=>{
            const img=document.createElement('img');
            img.src=u; pr2.appendChild(img);
          });
        }
        editingOrderId = id;
        showOrderForm();
      };
      window.deleteOrder = id=>{
        if(confirm('Eliminar este pedido?')) db.collection('orders').doc(id).delete().then(fetchOrders);
      };
      function renderOrders(){
        const sf = document.getElementById('statusFilter').value,
              cf = document.getElementById('clientFilter').value,
              tb = document.querySelector('#orders-table tbody');
        tb.innerHTML = '';
        ordersCache.forEach(o=>{
          const d = o.data;
          if(sf && d.status!==sf) return;
          if(cf && d.clientName!==cf) return;
          const tr=document.createElement('tr');
          tr.innerHTML=`
            <td>${d.clientName}</td>
            <td>${d.clientEmail}</td>
            <td>${d.clientPhone}</td>
            <td><a href="${d.vehicleURL}" target="_blank">Ver</a></td>
            <td>${d.status}</td>
            <td class="actions">
              <button class="btn-edit" onclick="editOrder('${o.id}')">E</button>
              <button class="btn-delete" onclick="deleteOrder('${o.id}')">X</button>
            </td>`;
          tb.appendChild(tr);
        });
      }
      function showOrderForm(){ document.getElementById('orderFormContainer').style.display='block'; }
      function hideOrderForm(){ document.getElementById('orderFormContainer').style.display='none'; }
    }
  </script>
</body>
</html>
