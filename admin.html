<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', sans-serif; background: var(--light); color: var(--text); }
    header { background: var(--blue); color: #fff; padding: 1rem; }
    header .logo { font-size: 1.5rem; font-weight: bold; }
    header nav ul { list-style: none; display: flex; gap: 1rem; }
    header nav a { color: #fff; text-decoration: none; }
    #adminApp { display: none; max-width: var(--max-width); margin: 1rem auto; }
    .tabs { display: flex; border-bottom: 2px solid var(--blue2); }
    .tab { flex: 1; padding: .75rem; background: var(--blue2); color: #fff; text-align: center; cursor: pointer; font-weight: 600; }
    .tab.active { background: var(--blue); }
    .section { display: none; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow); margin-top: 1rem; padding: 1rem; }
    .section.active { display: block; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 1rem; }
    form input, form select, form textarea, form button { width: 100%; margin: .5rem 0; padding: .75rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    form button { background: var(--yellow); color: var(--blue); border: none; font-weight: 600; cursor: pointer; }
    .preview img { width: 60px; height: 60px; object-fit: cover; margin: 4px; border: 1px solid #ccc; border-radius: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: .9rem; margin-top: .5rem; }
    th, td { padding: .5rem; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
    th { background: var(--blue2); color: #fff; }
    img.thumb { width: 50px; border-radius: 4px; }
    .actions button { margin-right: 4px; padding: 2px 6px; font-size: .8rem; border: none; border-radius: 4px; cursor: pointer; }
    .btn-copy { background: var(--blue); color: #fff; padding: 4px 8px; margin-bottom: .5rem; }
    #orderFormContainer { background: #f9f9f9; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
    #orderFormContainer h3 { margin-bottom: .5rem; }
    #orderFormContainer .form-grid { grid-template-columns: 1fr 1fr; }
    footer { background: var(--blue); color: #fff; padding: 1rem; text-align: center; margin-top: 2rem; }
  </style>
</head>
<body>

  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <div id="adminApp">

    <div class="tabs">
      <div class="tab active" data-sec="add">Añadir</div>
      <div class="tab" data-sec="inv">Inventario</div>
      <div class="tab" data-sec="usr">Usuarios (<span id="userCount">0</span>)</div>
      <div class="tab" data-sec="ped">Pedidos</div>
    </div>

    <!-- SECCIÓN AÑADIR VEHÍCULO -->
    <div id="section-add" class="section active">
      <form id="formularioAuto">
        <div class="form-grid">
          <input id="marca" name="marca" placeholder="Marca" required/>
          <input id="modelo" name="modelo" placeholder="Modelo" required/>
          <input id="motor" name="motor" placeholder="Motor" required/>
          <input id="anio" name="anio" type="number" placeholder="Año" required/>
          <input id="precio" name="precio" type="number" placeholder="Precio (LPS)" required/>
          <input id="kilometraje" name="kilometraje" type="number" placeholder="Kilometraje" required/>
          <input id="color" name="color" placeholder="Color" required/>
          <select id="tipo" name="tipo" required>
            <option value="">Tipo…</option>
            <option>Sedán</option><option>SUV</option><option>Pickup</option><option>Camioneta</option><option>Eléctrico</option>
          </select>
          <textarea id="descripcion" name="descripcion" rows="2" placeholder="Descripción"></textarea>
          <input id="imagenes" name="imagenes" type="file" multiple accept="image/*"/>
        </div>
        <div id="preview" class="preview"></div>
        <button id="btnAgregar" type="submit">Guardar Vehículo</button>
        <button id="btnCancelarEdicion" type="button" style="background:#e74c3c;color:#fff;display:none;">Cancelar</button>
      </form>
    </div>

    <!-- SECCIÓN INVENTARIO -->
    <div id="section-inv" class="section">
      <table id="inventory-table">
        <thead>
          <tr><th>Foto</th><th>Marca</th><th>Modelo</th><th>Año</th><th>Precio</th><th>Est.</th><th>Acc.</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN USUARIOS -->
    <div id="section-usr" class="section">
      <button id="btnCopyAll" class="btn-copy">Copiar todos</button>
      <table id="users-table">
        <thead><tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Acción</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN PEDIDOS -->
    <div id="section-ped" class="section">

      <button id="btnNewOrder" class="btn-copy">+ Nuevo Pedido</button>

      <div id="orderFormContainer" style="display:none;">
        <h3 id="orderFormTitle">Nuevo Pedido</h3>
        <form id="formularioOrder">
          <div class="form-grid">
            <select id="orderClient" required><option value="">Selecciona cliente…</option></select>
            <input id="orderClientPhone" placeholder="Teléfono" readonly/>
            <input id="orderVehicleURL" type="url" placeholder="Copart URL" required/>
            <input id="orderCopartPhotos" type="file" multiple accept="image/*"/>
            <input id="orderCopartInvoice" type="file" accept="application/pdf"/>
            <select id="orderStatus">
              <option>Inicio</option><option>Pago Pendiente</option><option>Pagado</option><option>Finalizado</option>
            </select>
          </div>
          <div id="recogidaSection" style="margin-top:1rem;display:none;">
            <label><input type="checkbox" id="chkRecogida"/> Recogida completada</label>
            <div class="form-grid">
              <input id="valorGrua" type="number" placeholder="Costo grúa (USD)" disabled/>
              <input id="valorBarco" type="number" placeholder="Costo barco (USD)" disabled/>
            </div>
          </div>
          <div id="hndSection" style="margin-top:1rem;display:none;">
            <label><input type="checkbox" id="chkHndArrived"/> Llegada HND completada</label>
            <textarea id="textoEnvioHnd" rows="2" placeholder="Detalles envío" disabled style="width:100%;"></textarea>
          </div>
          <div id="aduanaSection" style="margin-top:1rem;display:none;">
            <label><input type="checkbox" id="chkAduana"/> Pago aduana completado</label>
            <textarea id="textoAduana" rows="2" placeholder="Detalles aduana" disabled style="width:100%;"></textarea>
          </div>
          <div id="entregaSection" style="margin-top:1rem;display:none;">
            <label><input type="checkbox" id="chkEntrega"/> Entrega final completada</label>
            <div class="form-grid">
              <input id="fotosEntrega" type="file" multiple accept="image/*" disabled/>
              <input id="precioFinal" type="number" placeholder="Precio final (LPS)" disabled/>
            </div>
          </div>
          <div style="margin-top:1rem;display:flex;gap:10px;">
            <button type="submit">Guardar Pedido</button>
            <button id="btnCancelOrder" type="button" style="background:#e74c3c;color:#fff;">Cancelar</button>
          </div>
        </form>
      </div>

      <div style="display:flex;gap:10px;margin:1rem 0;">
        <select id="statusFilter">
          <option value="">Todos</option>
          <option value="Inicio">Inicio</option>
          <option value="Pago Pendiente">Pago Pendiente</option>
          <option value="Pagado">Pagado</option>
          <option value="Finalizado">Finalizado</option>
        </select>
        <select id="clientFilter"><option value="">Todos los clientes</option></select>
      </div>

      <table id="orders-table">
        <thead><tr><th>Cliente</th><th>Email</th><th>Teléfono</th><th>Vehículo</th><th>Estado</th><th>Acciones</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs & Lógica JS -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    const storage = firebase.storage().ref();
    const admins = ['ledinvvv@gmail.com', 'ledinvvv1995@yopmail.com'];
    let editingVehicleId = null, editingOrderId = null;
    const clientsCache = [], ordersCache = [];

    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-' + tab.dataset.sec).classList.add('active');
      };
    });

    firebase.auth().onAuthStateChanged(u => {
      if (!u) return location = 'login.html';
      if (!admins.includes(u.email)) return location = '/';
      document.getElementById('adminApp').style.display = 'block';
      initApp();
    });

    function initApp() {
      // Vehículos
      document.getElementById('imagenes').onchange = showVehPreview;
      document.getElementById('formularioAuto').onsubmit = saveVehicle;
      document.getElementById('btnCancelarEdicion').onclick = resetVehicleForm;
      fetchVehicles();

      // Clientes
      fetchClients();

      // Pedidos
      document.getElementById('btnNewOrder').onclick = () => { editingOrderId = null; showOrderForm(); };
      document.getElementById('btnCancelOrder').onclick = hideOrderForm;
      document.getElementById('formularioOrder').onsubmit = saveOrder;
      document.getElementById('orderClient').onchange = e => {
        const c = clientsCache.find(x => x.email === e.target.value);
        document.getElementById('orderClientPhone').value = c ? c.phone : '';
      };
      document.getElementById('orderCopartInvoice').onchange = () => document.getElementById('recogidaSection').style.display = 'block';
      document.getElementById('chkRecogida').onchange = e => {
        const ok = e.target.checked;
        document.getElementById('valorGrua').disabled = !ok;
        document.getElementById('valorBarco').disabled = !ok;
        if (ok) document.getElementById('hndSection').style.display = 'block';
      };
      document.getElementById('chkHndArrived').onchange = e => {
        document.getElementById('textoEnvioHnd').disabled = !e.target.checked;
        if (e.target.checked) document.getElementById('aduanaSection').style.display = 'block';
      };
      document.getElementById('chkAduana').onchange = e => {
        document.getElementById('textoAduana').disabled = !e.target.checked;
        if (e.target.checked) document.getElementById('entregaSection').style.display = 'block';
      };
      document.getElementById('chkEntrega').onchange = e => {
        document.getElementById('fotosEntrega').disabled = !e.target.checked;
        document.getElementById('precioFinal').disabled = !e.target.checked;
      };
      document.getElementById('statusFilter').onchange = renderOrders;
      document.getElementById('clientFilter').onchange = renderOrders;
      document.getElementById('btnCopyAll').onclick = () => {
        navigator.clipboard.writeText(clientsCache.map(c => c.phone).join(', '));
      };
      fetchOrders();
    }

    // Vehículos
    function showVehPreview() {
      const pr = document.getElementById('preview'); pr.innerHTML = '';
      Array.from(this.files).forEach(f => {
        const r = new FileReader(); r.onload = e => pr.innerHTML += `<img src="${e.target.result}"/>`;
        r.readAsDataURL(f);
      });
    }
    async function saveVehicle(e) {
      e.preventDefault();
      const f = e.target;
      const data = {
        marca: f.marca.value,
        modelo: f.modelo.value,
        motor: f.motor.value,
        anio: +f.anio.value,
        precio: +f.precio.value,
        kilometraje: +f.kilometraje.value,
        color: f.color.value,
        tipo: f.tipo.value,
        descripcion: f.descripcion.value
      };
      if (editingVehicleId) {
        await db.collection('inventario').doc(editingVehicleId).update(data);
      } else {
        const id = `${data.modelo.toLowerCase()}${data.anio}-${Date.now()}`;
        const urls = [];
        for (let file of f.imagenes.files) {
          const snap = await storage.child(`inventario/${id}/${file.name}`).put(file);
          urls.push(await snap.ref.getDownloadURL());
        }
        Object.assign(data, { id, imagenes: urls, vendido: false, fecha: firebase.firestore.FieldValue.serverTimestamp() });
        await db.collection('inventario').doc(id).set(data);
      }
      resetVehicleForm(); fetchVehicles();
    }
    function resetVehicleForm() {
      editingVehicleId = null;
      const f = document.getElementById('formularioAuto');
      f.reset(); document.getElementById('preview').innerHTML = '';
      document.getElementById('btnCancelarEdicion').style.display = 'none';
    }
    function fetchVehicles() {
      db.collection('inventario').orderBy('fecha','desc').get().then(snap => {
        const tb = document.querySelector('#inventory-table tbody'); tb.innerHTML = '';
        snap.forEach(d => {
          const v = d.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><img src="${v.imagenes[0]||''}" class="thumb"/></td>
            <td>${v.marca}</td><td>${v.modelo}</td><td>${v.anio}</td>
            <td>${v.precio} LPS</td><td>${v.vendido?'Vendido':'Disp.'}</td>
            <td class="actions">
              ${!v.vendido?`<button onclick="markSold('${d.id}')">V</button>`:`<button disabled>V</button>`}
              <button onclick="editVehicle('${d.id}')">E</button>
              <button onclick="deleteVehicle('${d.id}')">X</button>
            </td>`;
          tb.appendChild(tr);
        });
      });
    }
    function markSold(id) { db.collection('inventario').doc(id).update({ vendido:true }).then(fetchVehicles); }
    function deleteVehicle(id) { db.collection('inventario').doc(id).delete().then(fetchVehicles); }
    function editVehicle(id) {
      db.collection('inventario').doc(id).get().then(d => {
        const v = d.data(), f = document.getElementById('formularioAuto');
        ['marca','modelo','motor','anio','precio','kilometraje','color','tipo','descripcion']
          .forEach(k => f[k].value = v[k]||'');
        editingVehicleId = id;
        document.getElementById('btnCancelarEdicion').style.display = 'inline-block';
      });
    }

    // Clientes
    function fetchClients() {
      db.collection('clients').orderBy('fullName').get().then(snap => {
        clientsCache.length = 0;
        const tb = document.querySelector('#users-table tbody'); tb.innerHTML = '';
        snap.forEach(d => {
          const u = d.data(); clientsCache.push(u);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.fullName}</td><td>${u.email}</td><td>${u.phone}</td>
            <td><button onclick="navigator.clipboard.writeText('${u.phone}')">Copiar</button></td>`;
          tb.appendChild(tr);
        });
        document.getElementById('userCount').innerText = clientsCache.length;
        const sel = document.getElementById('orderClient'), filt = document.getElementById('clientFilter');
        sel.innerHTML = '<option value="">Selecciona cliente…</option>';
        filt.innerHTML = '<option value="">Todos los clientes</option>';
        clientsCache.forEach(c => {
          sel.innerHTML += `<option value="${c.email}">${c.fullName}</option>`;
          filt.innerHTML += `<option value="${c.fullName}">${c.fullName}</option>`;
        });
      });
    }

    // Pedidos
    function showOrderForm() {
      document.getElementById('orderFormTitle').innerText = editingOrderId?'Editar Pedido':'Nuevo Pedido';
      document.getElementById('orderFormContainer').style.display = 'block';
      document.getElementById('formularioOrder').reset();
      ['recogidaSection','hndSection','aduanaSection','entregaSection']
        .forEach(id => document.getElementById(id).style.display = 'none');
      ['valorGrua','valorBarco','textoEnvioHnd','textoAduana','fotosEntrega','precioFinal']
        .forEach(id => document.getElementById(id).disabled = true);
    }
    function hideOrderForm() {
      document.getElementById('orderFormContainer').style.display = 'none';
    }
    function fetchOrders() {
      db.collection('orders').orderBy('createdAt','desc').get().then(snap => {
        ordersCache.length = 0;
        snap.forEach(d => ordersCache.push({ id:d.id, data:d.data() }));
        renderOrders();
      });
    }
    function renderOrders() {
      const sf = document.getElementById('statusFilter').value;
      const cf = document.getElementById('clientFilter').value;
      const tb = document.querySelector('#orders-table tbody'); tb.innerHTML = '';
      ordersCache.forEach(o => {
        const d = o.data;
        if (sf && d.status !== sf) return;
        if (cf && d.clientName !== cf) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d.clientName}</td><td>${d.clientEmail}</td><td>${d.clientPhone}</td>
          <td><a href="${d.vehicleURL}" target="_blank">Ver</a></td>
          <td>${d.status}</td>
          <td class="actions">
            <button onclick="editOrder('${o.id}')">E</button>
            <button onclick="deleteOrder('${o.id}')">X</button>
          </td>`;
        tb.appendChild(tr);
      });
    }
    function editOrder(id) {
      const o = ordersCache.find(x=>x.id === id);
      if (!o) return;
      const d = o.data, f = document.getElementById('formularioOrder');
      f.orderClient.value = d.clientEmail;
      document.getElementById('orderClientPhone').value = d.clientPhone;
      f.orderVehicleURL.value = d.vehicleURL;
      f.orderStatus.value = d.status;
      if (d.copartInvoiceUrl) document.getElementById('recogidaSection').style.display = 'block';
      if (d.recogida?.done) {
        document.getElementById('chkRecogida').checked = true;
        document.getElementById('valorGrua').disabled = false; document.getElementById('valorGrua').value = d.recogida.valorGrua;
        document.getElementById('valorBarco').disabled = false; document.getElementById('valorBarco').value = d.recogida.valorBarco;
        document.getElementById('hndSection').style.display = 'block';
      }
      if (d.envioHnd?.done) {
        document.getElementById('chkHndArrived').checked = true;
        document.getElementById('textoEnvioHnd').disabled = false; document.getElementById('textoEnvioHnd').value = d.envioHnd.detail;
        document.getElementById('aduanaSection').style.display = 'block';
      }
      if (d.aduana?.done) {
        document.getElementById('chkAduana').checked = true;
        document.getElementById('textoAduana').disabled = false; document.getElementById('textoAduana').value = d.aduana.detail;
        document.getElementById('entregaSection').style.display = 'block';
      }
      if (d.entrega?.done) {
        document.getElementById('chkEntrega').checked = true;
        document.getElementById('precioFinal').disabled = false; document.getElementById('precioFinal').value = d.entrega.precioFinal;
        document.getElementById('fotosEntrega').disabled = false;
      }
      editingOrderId = id;
      showOrderForm();
    }
    function deleteOrder(id) {
      if (confirm('Eliminar este pedido?')) db.collection('orders').doc(id).delete().then(fetchOrders);
    }
    async function saveOrder(e) {
      e.preventDefault();
      const f = e.target;
      const client = clientsCache.find(c=>c.email===f.orderClient.value);
      let payload = {
        clientName: client.fullName,
        clientEmail: client.email,
        clientPhone: client.phone,
        vehicleURL: f.orderVehicleURL.value,
        status: f.orderStatus.value,
        copartPhotos: [],
        copartInvoiceUrl: null,
        recogida: { done: false, valorGrua: 0, valorBarco: 0 },
        envioHnd: { done: false, detail: '' },
        aduana: { done: false, detail: '' },
        entrega: { done: false, precioFinal: 0, deliveryPhotos: [] },
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      for (let file of f.orderCopartPhotos.files) {
        const snap = await storage.child(`orders/${editingOrderId||'new'}/copart/${file.name}`).put(file);
        payload.copartPhotos.push(await snap.ref.getDownloadURL());
      }
      if (f.orderCopartInvoice.files[0]) {
        const snap = await storage.child(`orders/${editingOrderId||'new'}/copart/receipt.pdf`).put(f.orderCopartInvoice.files[0]);
        payload.copartInvoiceUrl = await snap.ref.getDownloadURL();
      }
      if (f.chkRecogida.checked) {
        payload.recogida.done = true;
        payload.recogida.valorGrua = +f.valorGrua.value;
        payload.recogida.valorBarco = +f.valorBarco.value;
      }
      if (f.chkHndArrived.checked) {
        payload.envioHnd.done = true;
        payload.envioHnd.detail = f.textoEnvioHnd.value;
      }
      if (f.chkAduana.checked) {
        payload.aduana.done = true;
        payload.aduana.detail = f.textoAduana.value;
      }
      if (f.chkEntrega.checked) {
        payload.entrega.done = true;
        payload.entrega.precioFinal = +f.precioFinal.value;
        for (let file of f.fotosEntrega.files) {
          const snap = await storage.child(`orders/${editingOrderId||'new'}/delivery/${file.name}`).put(file);
          payload.entrega.deliveryPhotos.push(await snap.ref.getDownloadURL());
        }
      }
      if (editingOrderId) {
        await db.collection('orders').doc(editingOrderId).update(payload);
      } else {
        await db.collection('orders').add(payload);
      }
      hideOrderForm(); fetchOrders();
    }
  </script>
</body>
</html>
