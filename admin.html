<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel de Administración | SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); }

    /* Header / Footer */
    header, footer { background: var(--blue); color: #fff; padding: 1rem; text-align: center; }
    header .logo, footer .logo { font-size: 1.5rem; font-weight: bold; }
    header nav ul { list-style: none; display: flex; justify-content: center; gap: 1rem; margin-top: .5rem; }
    header nav a { color: #fff; text-decoration: none; }

    #adminApp { max-width: var(--max-width); margin: 1rem auto; display: none; }

    /* Pestañas */
    .tabs { display:flex; border-bottom: 2px solid var(--blue2); }
    .tab { flex:1; padding:.75rem; background:var(--blue2); color:#fff; text-align:center; cursor:pointer; font-weight:600; }
    .tab.active { background:var(--blue); }

    /* Secciones */
    .section { display:none; padding:1rem; background:#fff; border-radius:8px; box-shadow:0 2px 10px var(--shadow); margin-top:1rem; }
    .section.active { display:block; }

    /* Formularios y tablas */
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    form input, form select, form textarea, form button {
      width:100%; margin:.5rem 0; padding:.75rem; border:1px solid #ccc; border-radius:4px;
    }
    form button { background:var(--yellow); color:var(--blue); border:none; font-weight:600; cursor:pointer; }
    .preview img, img.thumb { width:60px; height:60px; object-fit:cover; margin:4px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; font-size:.9rem; margin-top:1rem; }
    th, td { padding:.5rem; border:1px solid #ddd; text-align:left; vertical-align:middle; }
    th { background:var(--blue2); color:#fff; }
    .actions button, .actions input { margin-right:4px; padding:2px 6px; font-size:.8rem; }
    .btn-sold { background:var(--yellow); color:var(--text); }
    .btn-edit { background:var(--blue); color:#fff; }
    .btn-delete { background:#e74c3c; color:#fff; }
    .btn-copy, #btnCopyAll { background:var(--blue); color:#fff; padding:4px 8px; font-size:.9rem; margin-bottom:.5rem; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="logo">SubastaCarHN</div>
    <nav>
      <ul>
        <li><a href="index.html">Inicio</a></li>
        <li><a href="inventario.html">Inventario</a></li>
        <li><a href="admin.html">Admin</a></li>
        <li><a href="#" onclick="firebase.auth().signOut()">Salir</a></li>
      </ul>
    </nav>
  </header>

  <!-- ADMIN APP -->
  <div id="adminApp">

    <!-- PESTAÑAS -->
    <div class="tabs">
      <div class="tab active" data-sec="add">Añadir</div>
      <div class="tab" data-sec="inv">Inventario</div>
      <div class="tab" data-sec="usr">Usuarios (<span id="userCount">0</span>)</div>
      <div class="tab" data-sec="ped">Pedidos</div>
    </div>

    <!-- SECCIÓN AÑADIR VEHÍCULO -->
    <div id="section-add" class="section active">
      <!-- ... aquí tu formulario de vehículo ... -->
    </div>

    <!-- SECCIÓN INVENTARIO -->
    <div id="section-inv" class="section">
      <!-- ... tu tabla de inventario ... -->
    </div>

    <!-- SECCIÓN USUARIOS -->
    <div id="section-usr" class="section">
      <button id="btnCopyAll" class="btn-copy">Copiar todos</button>
      <table id="users-table">
        <thead>
          <tr><th>Nombre</th><th>Email</th><th>Teléfono</th><th>Acción</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SECCIÓN PEDIDOS -->
    <div id="section-ped" class="section">
      <button id="btnNewOrder" class="btn-copy">+ Nuevo Pedido</button>
      <!-- Formulario de Pedido -->
      <form id="formOrder" style="display:none; margin-bottom:1rem;">
        <div class="form-grid">
          <select id="orderClient" required>
            <option value="">Selecciona cliente…</option>
          </select>
          <input id="orderUrl" placeholder="URL Copart" required/>
          <input id="orderPrice" type="number" placeholder="Precio estimado LPS" required/>
          <!-- aquí podrías añadir más campos si quisieras -->
        </div>
        <button id="btnSaveOrder" type="submit">Guardar Pedido</button>
        <button id="btnCancelOrder" type="button" style="background:#e74c3c;color:#fff;">Cancelar</button>
      </form>

      <!-- Filtros -->
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <select id="statusFilter">
          <option value="">Todos</option>
          <option value="Pendiente">Pendientes</option>
          <option value="Finalizado">Finalizados</option>
        </select>
        <select id="clientFilter">
          <option value="">Todos los clientes</option>
        </select>
      </div>

      <!-- Tabla de Pedidos -->
      <table id="orders-table">
        <thead>
          <tr>
            <th>Cliente</th><th>Email</th><th>Teléfono</th>
            <th>URL Copart</th><th>Precio</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <small>Flujo de gestión completo: Copart → Envío → Honduras → Aduana → Entrega</small>
    </div>

  </div>

  <!-- FOOTER -->
  <footer>
    <div class="logo">SubastaCarHN</div>
    <p>© 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Tu configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);

    const db = firebase.firestore();
    let editingOrderId = null;
    let clientsList = [];

    // PESTAÑAS
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('.tab, .section').forEach(el=>el.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-' + tab.dataset.sec).classList.add('active');
      });
    });

    // AUTH + INICIO
    firebase.auth().onAuthStateChanged(user=>{
      if(!user) return location='login.html';
      document.getElementById('adminApp').style.display='block';
      initApp();
    });

    function initApp(){
      loadClients();
      loadOrders();
      // botón + Nuevo Pedido
      document.getElementById('btnNewOrder').onclick = ()=>{
        editingOrderId = null;
        document.getElementById('formOrder').style.display='block';
        document.getElementById('orderClient').value = '';
        document.getElementById('orderUrl').value = '';
        document.getElementById('orderPrice').value = '';
      };
      document.getElementById('btnCancelOrder').onclick = ()=> {
        document.getElementById('formOrder').style.display='none';
      };
      document.getElementById('formOrder').onsubmit = saveOrder;

      // filtros tabla
      document.getElementById('statusFilter').onchange = loadOrders;
      document.getElementById('clientFilter').onchange = loadOrders;
    }

    // Carga lista de clientes para el select
    function loadClients(){
      db.collection('clients').orderBy('fullName').get().then(snap=>{
        const sel = document.getElementById('orderClient');
        sel.innerHTML = '<option value="">Selecciona cliente…</option>';
        clientsList = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        clientsList.forEach(c=>{
          const o = document.createElement('option');
          o.value = c.id;
          o.textContent = `${c.fullName} (${c.email})`;
          sel.appendChild(o);
        });
        // también para el filtro
        const cf = document.getElementById('clientFilter');
        cf.innerHTML = '<option value="">Todos los clientes</option>';
        clientsList.forEach(c=>{
          const o = document.createElement('option');
          o.value = c.fullName;
          o.textContent = c.fullName;
          cf.appendChild(o);
        });
      });
    }

    // Guarda nuevo pedido o edita existente
    function saveOrder(e){
      e.preventDefault();
      const cid = document.getElementById('orderClient').value;
      const client = clientsList.find(c=>c.id===cid);
      const data = {
        clientId: cid,
        clientName: client.fullName,
        clientEmail: client.email,
        clientPhone: client.phone,
        copartUrl: document.getElementById('orderUrl').value,
        negotiatedPrice: Number(document.getElementById('orderPrice').value),
        status: 'Pendiente',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const col = db.collection('orders');
      const op = editingOrderId
        ? col.doc(editingOrderId).update(data)
        : col.doc().set(data);
      op.then(()=>{
        document.getElementById('formOrder').style.display='none';
        loadOrders();
      });
    }

    // Carga tabla de pedidos
    function loadOrders(){
      const stFilter = document.getElementById('statusFilter').value;
      const clFilter = document.getElementById('clientFilter').value;
      db.collection('orders').orderBy('createdAt','desc').get().then(snap=>{
        const tbody = document.querySelector('#orders-table tbody');
        tbody.innerHTML = '';
        snap.forEach(doc=>{
          const o = doc.data(), id = doc.id;
          if(stFilter && o.status !== stFilter) return;
          if(clFilter && o.clientName !== clFilter) return;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o.clientName}</td>
            <td>${o.clientEmail}</td>
            <td>${o.clientPhone}</td>
            <td><a href="${o.copartUrl}" target="_blank">Ver</a></td>
            <td>${o.negotiatedPrice.toLocaleString('es-HN')} LPS</td>
            <td>${o.status}</td>
            <td class="actions">
              <button class="btn-edit" onclick="editOrder('${id}')">Editar</button>
              <button class="btn-delete" onclick="deleteOrder('${id}')">X</button>
            </td>`;
          tbody.appendChild(tr);
        });
        document.getElementById('userCount').textContent = snap.size;
      });
    }

    function editOrder(id){
      db.collection('orders').doc(id).get().then(doc=>{
        const o = doc.data();
        editingOrderId = id;
        document.getElementById('formOrder').style.display='block';
        document.getElementById('orderClient').value = o.clientId;
        document.getElementById('orderUrl').value = o.copartUrl;
        document.getElementById('orderPrice').value = o.negotiatedPrice;
      });
    }

    function deleteOrder(id){
      if(!confirm('¿Eliminar pedido?')) return;
      db.collection('orders').doc(id).delete().then(loadOrders);
    }
  </script>
</body>
</html>
