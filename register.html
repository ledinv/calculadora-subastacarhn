<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro – SubastaCarHN</title>
  <style>
    /* … tu CSS actual (idéntico al tuyo) … */
  </style>
</head>
<body>
  <!-- Header + menú -->
  <header>…</header>
  <ul id="menu-links">…</ul>

  <!-- Formulario -->
  <div class="layout">
    <div class="contenido-central">
      <h1>Crear cuenta</h1>
      <form id="registerForm">
        <label for="fullName">Nombre completo</label>
        <input type="text" id="fullName" required />

        <label for="email">Correo electrónico</label>
        <input type="email" id="email" required />

        <label for="phone">Teléfono / Celular</label>
        <input type="tel" id="phone"
               placeholder="9xxxxxxxx"
               pattern="[923]\d{7}"
               required />

        <!-- Contraseña -->
        <label for="password">Contraseña</label>
        <div class="pass-wrapper">
          <input type="password" id="password" minlength="8" required />
          <span class="toggle-eye" data-target="password">…SVG…</span>
        </div>
        <small id="passwordHelper" class="helper">
          La contraseña debe tener ≥8 caracteres, 1 mayúscula y 1 número.
        </small>

        <!-- Confirmar contraseña -->
        <label for="confirmPassword">Confirmar contraseña</label>
        <div class="pass-wrapper">
          <input type="password" id="confirmPassword" minlength="8" required />
          <span class="toggle-eye" data-target="confirmPassword">…SVG…</span>
        </div>
        <small id="confirmHelper" class="helper"></small>

        <button type="submit" class="styled-btn" id="submitBtn">
          <span id="btnText">Registrarse</span>
          <span id="btnSpinner" style="display:none;">⏳</span>
        </button>
      </form>
      <p style="text-align:center; margin-top:15px;">
        ¿Ya tienes cuenta? <a href="login.html">Iniciar Sesión</a>
      </p>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // — 1) Inicialización
    const firebaseConfig = {
      apiKey: "...",
      authDomain: "...",
      projectId: "...",
      /* resto de tu config */
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // — 2) Toggle menú
    function toggleMenu() {
      const m = document.getElementById('menu-links');
      m.style.display = m.style.display === 'block' ? 'none' : 'block';
    }

    // — 3) Toggle ojo contraseña
    document.querySelectorAll('.toggle-eye').forEach(icon => {
      icon.addEventListener('click', () => {
        const inp = document.getElementById(icon.dataset.target);
        const isPwd = inp.type === 'password';
        inp.type = isPwd ? 'text' : 'password';
        // (Aquí intercambias tu SVG de ojo abierto / cerrado)
      });
    });

    // — 4) Regex
    const passwordRegex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;

    // — 5) Envío del formulario
    document.getElementById('registerForm')
      .addEventListener('submit', async e => {
        e.preventDefault();

        // Deshabilita botón + spinner
        const btn     = document.getElementById('submitBtn');
        const txt     = document.getElementById('btnText');
        const spinner = document.getElementById('btnSpinner');
        btn.disabled = true; txt.style.display = 'none'; spinner.style.display = '';

        const name  = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const pass  = document.getElementById('password').value;
        const conf  = document.getElementById('confirmPassword').value;

        // Validaciones
        if (!passwordRegex.test(pass)) {
          alert('⚠️ La contraseña no cumple los requisitos mínimos.');
          document.getElementById('passwordHelper').classList.add('invalid');
          btn.disabled = false; spinner.style.display = 'none'; txt.style.display = '';
          return;
        }
        document.getElementById('passwordHelper').classList.remove('invalid');

        if (pass !== conf) {
          document.getElementById('confirmHelper').textContent = '⚠️ Las contraseñas no coinciden.';
          btn.disabled = false; spinner.style.display = 'none'; txt.style.display = '';
          return;
        }
        document.getElementById('confirmHelper').textContent = '';

        // Crear usuario + Firestore
        try {
          const cred = await auth.createUserWithEmailAndPassword(email, pass);
          await cred.user.updateProfile({ displayName: name });
          await cred.user.sendEmailVerification();

          // ** aquí usamos el UID como ID de documento **
          await db.collection('clients')
                  .doc(cred.user.uid)
                  .set({
                    fullName:  name,
                    email:     email,
                    phone:     phone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  });

          alert('✅ Cuenta creada. Revisa tu correo para confirmar.');
          window.location.href = 'login.html';

        } catch(err) {
          let msg = 'Error inesperado: ' + err.message;
          if (err.code === 'auth/email-already-in-use')    msg = '⚠️ Ese correo ya está registrado.';
          if (err.code === 'auth/invalid-email')           msg = '⚠️ Correo inválido.';
          if (err.code === 'auth/weak-password')           msg = '⚠️ Contraseña demasiado débil.';
          alert(msg);
          btn.disabled = false; spinner.style.display = 'none'; txt.style.display = '';
        }
      });
  </script>
</body>
</html>
