<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>SubastaCarHN – Perfil de Usuario</title>
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <meta name="theme-color" content="#002f6c">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    /* ...tus estilos (idénticos a los que ya tenías)... */
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-inner container">
      <a href="index.html" class="brand">SubastaCarHN</a>
      <nav class="nav-links">
        <a href="calculadora.html">Calculadora</a>
        <a href="cursos.html">Cursos</a>
        <span id="userGreeting"></span>
      </nav>
      <button class="menu-icon" onclick="toggleMenu()">☰</button>
    </div>
    <div id="mobile-menu-links" class="mobile-nav">
      <a href="calculadora.html">Calculadora</a>
      <a href="cursos.html">Cursos</a>
      <span id="mobileGreeting"></span>
      <a href="login.html">Iniciar Sesión</a>
    </div>
  </header>

  <main class="container">
    <!-- DATOS BÁSICOS + DIRECCIÓN -->
    <section class="card">
      <h2>Mis Datos</h2>
      <form id="profile-form">
        <!-- ...tus inputs aquí... -->
      </form>
    </section>
    <!-- resto de secciones SMS, contraseña, historial... -->
  </main>

  <footer>
    <!-- ...tu footer... -->
  </footer>

  <!-- Firebase + Lógica -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // 1) Inicializa Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // Toggle menú móvil
    function toggleMenu() {
      document.getElementById('mobile-menu-links').classList.toggle('open');
    }

    // Listener de auth
    auth.onAuthStateChanged(async user => {
      // 2) Redirige si no hay usuario
      if (!user) {
        return window.location.href = 'login.html';
      }
      // 3) Forzar recarga para obtener emailVerified actualizado
      await user.reload();
      if (!user.emailVerified) {
        alert('⚠️ Verifica tu correo antes de continuar.');
        await auth.signOut();
        return window.location.href = 'login.html';
      }

      // 4) Ya autenticado y verificado, carga datos
      const uid = user.uid;
      // Apunta a la colección correcta:
      const userRef = db.collection('clients').doc(uid);

      // Saluda en header
      const name = (user.displayName || user.email.split('@')[0]).replace(/^./, c => c.toUpperCase());
      const greet = `<a href="perfil.html">Hola, ${name}</a> | <a href="#" onclick="logout()">Cerrar sesión</a>`;
      document.getElementById('userGreeting').innerHTML  = greet;
      document.getElementById('mobileGreeting').innerHTML = greet;

      // Carga el perfil
      const doc = await userRef.get();
      if (doc.exists) {
        const d = doc.data();
        document.getElementById('displayName').value = d.fullName || '';
        document.getElementById('email').value       = user.email;
        document.getElementById('phone').value       = d.phone    || '';
        document.getElementById('street').value      = d.street   || '';
        document.getElementById('city').value        = d.city     || '';
        document.getElementById('country').value     = d.country  || '';
      } else {
        document.getElementById('email').value = user.email;
      }

      // Resto de tus listeners (SMS, password, historial) pueden ir aquí...
    });

    // Función de logout
    function logout() {
      auth.signOut().then(() => window.location.href = 'login.html');
    }
  </script>
</body>
</html>
