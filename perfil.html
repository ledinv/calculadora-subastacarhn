<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil – SubastaCarHN</title>

  <!-- Fuentes e íconos -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); line-height:1.6 }
    a { text-decoration:none; color:inherit }
    ul { list-style:none }
    .container { max-width:var(--max-width); margin:0 auto; padding:0 1rem }

    /* HEADER */
    .site-header {
      background:var(--blue);
      position: sticky; top:0; z-index:1000;
    }
    .header-inner { display:flex; align-items:center; justify-content:space-between; padding:.75rem }
    .brand { color:#fff; font-size:1.5rem; font-weight:700 }
    .nav-list { display:flex; gap:1rem; margin-left:auto }
    .nav-list a, .nav-list span { color:var(--yellow); font-weight:600; font-size:.95rem }
    .menu-icon {
      background:var(--yellow); color:var(--blue); border:none;
      padding:.5rem; border-radius:6px; cursor:pointer;
      box-shadow:0 2px 8px var(--shadow);
    }
    .mobile-nav {
      display:none; flex-direction:column; background:#fff; padding:1rem;
      box-shadow:0 2px 8px var(--shadow);
    }
    .mobile-nav.open { display:flex; }
    .mobile-nav a, .mobile-nav span {
      font-weight:700; padding:.75rem; border-radius:4px;
      transition:background .2s; color:var(--blue);
    }
    .mobile-nav a:hover, .mobile-nav span:hover { background:rgba(0,47,108,0.1) }
    @media (max-width:767px) { .nav-list { display:none; } }
    @media (min-width:768px) { .menu-icon { display:none; } }

    /* MAIN */
    main.layout { padding:2rem 1rem }
    .contenido-central {
      max-width:600px; margin:0 auto; background:#fff;
      padding:2rem; border-radius:15px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .contenido-central h1 { text-align:center; color:var(--blue); margin-bottom:1.5rem }

    /* PESTAÑAS */
    #tabs {
      display:flex; justify-content:space-around; margin-bottom:1.5rem;
    }
    .tab-btn {
      background:transparent; border:2px solid transparent; font-weight:600;
      padding:.5rem 1rem; cursor:pointer; font-size:1rem;
      color:var(--blue2); border-radius:6px;
      transition:border-color .2s;
    }
    .tab-btn.active {
      border-color:var(--blue2);
    }
    .tab-btn.active::after {
      content:""; position:absolute; left:25%; right:25%; bottom:0;
      height:4px; background:var(--yellow); border-radius:2px;
    }

    /* SECCIONES */
    .section { display:none; }
    .section.active { display:block; }

    /* PERFIL */
    label { display:block; font-weight:bold; color:var(--blue); margin-top:10px }
    input, textarea {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid var(--blue2); background:#f0f8ff;
      margin-top:5px; font-size:14px; box-sizing:border-box;
    }
    textarea { resize:vertical; }
    .readonly { background:#e4e4e4; color:#555; }
    small.note { font-size:12px; color:#666; display:block; margin:-.2rem 0 1rem; }
    .styled-btn {
      background:var(--yellow); color:var(--blue); font-weight:bold;
      border:none; border-radius:8px; padding:10px; margin-top:20px;
      width:100%; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .styled-btn:hover { background:#e6ac00; }
    .success-msg {
      background:#d4edda; color:#155724; border:1px solid #c3e6cb;
      padding:10px; border-radius:6px; text-align:center; margin-top:10px;
    }

    /* GESTIONES (estilo original) */
    .orders-grid {
      display:grid; gap:1rem;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      margin-top:2rem;
    }
    .order-card {
      border:1px solid #ddd; border-radius:6px; overflow:hidden;
      background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .accordion-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:.75rem 1rem; background:var(--blue2); color:#fff; cursor:pointer;
    }
    .status-badge {
      background:var(--yellow); color:var(--text);
      padding:2px 8px; border-radius:4px; font-size:.8rem;
    }
    .accordion-content {
      max-height:0; overflow:hidden;
      transition:max-height .3s ease, padding .3s ease;
      padding:0 1rem;
    }
    .accordion-content.open {
      padding:1rem; max-height:800px;
    }
    .tracker {
      list-style:none; display:flex; gap:.5rem;
      padding:0; margin-bottom:.75rem; flex-wrap:wrap;
    }
    .tracker li {
      position:relative; padding-left:1.2rem; font-size:.8rem;
    }
    .tracker li::before {
      content:''; position:absolute; left:0; top:.2rem;
      width:.8rem; height:.8rem; border-radius:50%; background:#ccc;
    }
    .tracker li.done::before { background:var(--yellow) }
    .tracker li.active::before { background:var(--blue) }
    .summary { list-style:none; padding:0; margin:0; font-size:.9rem; }
    .summary li { margin-bottom:.5rem; }
    .gallery {
      display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;
    }
    .gallery img {
      width:60px; height:60px; object-fit:cover;
      border:1px solid #ddd; border-radius:4px;
    }

    /* HISTORIAL */
    #historialContainer .hist-item {
      background:#f0f8ff; padding:1rem; border-radius:10px;
      margin-bottom:1rem; box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">SubastaCarHN</a>
      <ul class="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calculadora.html">Calculadora</a></li>
        <li><a href="inventario.html">Vehículos</a></li>
        <li><a href="cursos.html">Cursos</a></li>
        <li><a href="https://wa.me/50497330137" target="_blank">Soporte</a></li>
        <li><span id="userGreeting"></span></li>
      </ul>
      <button class="menu-icon" onclick="toggleMenu()">☰</button>
    </div>
    <nav id="mobile-menu-links" class="mobile-nav">
      <a href="index.html">Inicio</a>
      <a href="calculadora.html">Calculadora</a>
      <a href="inventario.html">Vehículos</a>
      <a href="cursos.html">Cursos</a>
      <a href="https://wa.me/50497330137" target="_blank">Soporte</a>
      <span id="mobileGreeting"></span>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="layout">
    <div class="contenido-central">
      <h1>Mi Perfil</h1>

      <!-- PESTAÑAS -->
      <div id="tabs">
        <button class="tab-btn" data-tab="perfil" onclick="showSection('perfil')">Perfil</button>
        <button class="tab-btn" data-tab="gestiones" onclick="showSection('gestiones')">Gestiones</button>
        <button class="tab-btn" data-tab="historial" onclick="showSection('historial')">Historial</button>
      </div>

      <!-- SECCIÓN PERFIL -->
      <section id="section-perfil" class="section">
        <form id="profileForm">
          <label for="name">Nombre completo</label>
          <input type="text" id="name" required />

          <label for="email">Correo electrónico</label>
          <input type="email" id="email" class="readonly" readonly />

          <label for="phone">Teléfono</label>
          <input type="tel" id="phone" class="readonly" readonly />

          <label for="address">Dirección</label>
          <input type="text" id="address" />

          <label for="dni">DNI</label>
          <input type="text" id="dni" />

          <label for="birthYear">Año de nacimiento</label>
          <input type="number" id="birthYear" min="1900" max="2100" />
          <small class="note">El DNI y el año de nacimiento te ayudarán a recuperar tu cuenta si pierdes el acceso.</small>

          <button type="submit" class="styled-btn">Guardar cambios</button>
          <button type="button" class="styled-btn" onclick="sendPasswordReset()">Cambiar contraseña</button>
          <button type="button" class="styled-btn" onclick="logout()">Cerrar sesión</button>

          <div id="successMsg" class="success-msg" style="display:none;">
            ✅ Tus datos han sido actualizados con éxito.
          </div>
        </form>
      </section>

      <!-- SECCIÓN GESTIONES -->
      <section id="section-gestiones" class="section">
        <button id="btnStartGestion" class="styled-btn">Comenzar gestión</button>
        <div id="depositForm" style="display:none; margin-top:1rem; background:#fff; padding:1rem; border-radius:8px;">
          <h2 style="margin-bottom:.5rem; color:var(--blue2);">Subir comprobante de depósito (5,000 LPS)</h2>
          <input type="file" id="depositFile" accept="application/pdf,image/*" />
          <button id="btnUploadDeposit" class="styled-btn" style="margin-top:.75rem;">Enviar comprobante</button>
        </div>
        <div id="depositSuccess" class="success-msg" style="display:none; margin-top:1rem;">
          ✅ Comprobante enviado. Pronto comenzaremos la gestión.
        </div>

        <h2 style="text-align:center; color:var(--blue); margin-top:2rem;">Mis Gestiones</h2>
        <div id="clientOrdersContainer" class="orders-grid"></div>
      </section>

      <!-- SECCIÓN HISTORIAL -->
      <section id="section-historial" class="section">
        <h2 style="text-align:center; color:var(--blue); margin-bottom:1rem;">Historial de Cálculos</h2>
        <div id="historialContainer"></div>
      </section>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer" style="background:var(--blue2); color:#fff; text-align:center; padding:1rem; margin-top:2rem;">
    <div class="container footer-inner">
      <nav class="footer-nav">
        <ul class="footer-list" style="display:flex; justify-content:center; gap:1.5rem; margin-bottom:1rem;">
          <li><a href="index.html" style="color:var(--yellow);">Inicio</a></li>
          <li><a href="calculadora.html" style="color:var(--yellow);">Calculadora</a></li>
          <li><a href="inventario.html" style="color:var(--yellow);">Vehículos</a></li>
          <li><a href="cursos.html" style="color:var(--yellow);">Cursos</a></li>
          <li><a href="contacto.html" style="color:var(--yellow);">Contacto</a></li>
        </ul>
      </nav>
      <div class="social-links" style="margin-bottom:1rem;">
        <a href="https://facebook.com/Subasta-Car-HN" target="_blank" style="color:var(--yellow); margin:0 .5rem;">Facebook</a> |
        <a href="https://instagram.com/subastacar1" target="_blank" style="color:var(--yellow); margin:0 .5rem;">Instagram</a> |
        <a href="https://tiktok.com/@tu_amigo_el_importador" target="_blank" style="color:var(--yellow); margin:0 .5rem;">TikTok</a>
      </div>
      <div class="footer-copy" style="font-size:.85rem; opacity:.8;">&copy; 2025 SubastaCarHN. Todos los derechos reservados.</div>
    </div>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Inicialización Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);
    const auth    = firebase.auth();
    const db      = firebase.firestore();
    const storage = firebase.storage().ref();

    // Menú móvil
    function toggleMenu() {
      document.getElementById('mobile-menu-links').classList.toggle('open');
    }

    // Mostrar sección/tab
    function showSection(name) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`section-${name}`).classList.add('active');
      document.querySelector(`.tab-btn[data-tab="${name}"]`).classList.add('active');
    }

    // Perfil e Historial
    async function cargarHistorial() {
      const uid = auth.currentUser.uid;
      const snap = await db.collection('clients').doc(uid)
        .collection('historial').orderBy('fecha','desc').limit(100).get();
      const cont = document.getElementById('historialContainer');
      if (snap.empty) {
        cont.innerHTML = '<p style="text-align:center;">Aún no hay cálculos guardados.</p>';
        return;
      }
      cont.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const fecha = d.fecha?.toDate().toLocaleString('es-HN') || 'Fecha desconocida';
        return `
          <div class="hist-item">
            <input type="text" value="${d.nombre||'Sin título'}"
              onchange="renombrarHistorial('${doc.id}', this.value)"
              style="font-weight:bold;border:none;background:transparent;color:var(--blue2);width:100%;"/>
            <small>${fecha}</small><br>
            <strong style="color:var(--blue2);">L ${d.total||'-'}</strong><br><br>
            <button class="styled-btn" onclick="verDetallesHistorial('${doc.id}')">Ver detalles</button>
          </div>`;
      }).join('');
    }
    async function renombrarHistorial(id, nombre) {
      await db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).update({ nombre });
      cargarHistorial();
    }

    // Gestión de depósitos y pedidos
    const btnStartGestion       = document.getElementById('btnStartGestion');
    const depositForm           = document.getElementById('depositForm');
    const depositFile           = document.getElementById('depositFile');
    const btnUploadDeposit      = document.getElementById('btnUploadDeposit');
    const depositSuccess        = document.getElementById('depositSuccess');
    const clientOrdersContainer = document.getElementById('clientOrdersContainer');
    const STEPS = ['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];

    btnStartGestion.onclick = () => {
      depositForm.style.display       = 'block';
      btnStartGestion.style.display   = 'none';
      depositSuccess.style.display    = 'none';
      depositForm.scrollIntoView({ behavior: 'smooth' });
    };

    btnUploadDeposit.onclick = async () => {
      if (!depositFile.files[0]) {
        alert('Selecciona un comprobante antes de enviar.');
        return;
      }
      btnUploadDeposit.disabled    = true;
      btnUploadDeposit.textContent = 'Subiendo…';
      try {
        const user = auth.currentUser;
        const file = depositFile.files[0];
        const snap = await storage
          .child(`orders/${user.uid}/deposit/${Date.now()}_${file.name}`)
          .put(file);
        const url = await snap.ref.getDownloadURL();
        const payload = {
          clientName:        user.displayName || user.email,
          clientEmail:       user.email,
          clientPhone:       document.getElementById('phone').value,
          vehicleURL:        null,
          precioEstimado:    null,
          depositReceiptUrl: url,
          depositAmount:     5000,
          copartInvoiceUrl:  null,
          copartPhotos:      [],
          recogida:          { valorGrua: 0, valorBarco: 0 },
          envioHnd:          { detail: '' },
          aduana:            { detail: '' },
          entrega:           { detail: '', precioFinal: 0, deliveryPhotos: [] },
          createdAt:         firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt:         firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('orders').add(payload);
        depositForm.style.display    = 'none';
        depositSuccess.style.display = 'block';
        fetchClientOrders();
      } catch (err) {
        console.error(err);
        alert('❌ Error al subir el comprobante. Intenta de nuevo.');
      } finally {
        btnUploadDeposit.disabled    = false;
        btnUploadDeposit.textContent = 'Enviar comprobante';
      }
    };

    function getDisplayStatus(o) {
      if (o.depositReceiptUrl)                       return 'Pago Pendiente';
      if (o.entrega?.deliveryPhotos?.length)         return 'Finalizado';
      if (o.aduana?.detail)                          return 'Aduana';
      if (o.recogida?.valorGrua || o.recogida?.valorBarco) return 'Enviado';
      if (o.copartInvoiceUrl)                        return 'Pagado';
      return 'Inicio';
    }

    async function fetchClientOrders() {
      const user = auth.currentUser;
      if (!user) return;
      clientOrdersContainer.innerHTML = '';
      const snap = await db.collection('orders')
        .where('clientEmail', '==', user.email)
        .orderBy('createdAt','desc')
        .get();
      if (snap.empty) {
        clientOrdersContainer.innerHTML = '<p style="text-align:center;">Aún no tienes gestiones iniciadas.</p>';
        return;
      }
      snap.docs.forEach(doc => {
        const o      = doc.data();
        const status = getDisplayStatus(o);
        const stepsHtml = STEPS.map((s,i) => {
          const idx = STEPS.indexOf(status);
          const cls = i < idx ? 'done' : (i === idx ? 'active' : '');
          return `<li class="${cls}">${s}</li>`;
        }).join('');
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div class="accordion-header" data-acc="${doc.id}">
            <div><strong>#${doc.id.slice(0,6)}</strong> ${o.clientName}</div>
            <div><span class="status-badge">${status}</span></div>
          </div>
          <div id="acc-${doc.id}" class="accordion-content">
            <ul class="tracker">${stepsHtml}</ul>
            <ul class="summary">
              <li><strong>Vehículo:</strong> ${o.vehicleURL
                ? `<a href="${o.vehicleURL}" target="_blank">Ver vehículo</a>`
                : '-'
              }</li>
              <li><strong>Estimado:</strong> ${o.precioEstimado ? `${o.precioEstimado} USD` : '-'}</li>
              <li><strong>Depósito:</strong> ${o.depositAmount || '-'} LPS</li>
              <li><strong>Comprobante:</strong> ${o.depositReceiptUrl
                ? `<a href="${o.depositReceiptUrl}" target="_blank">Ver comprobante</a>`
                : '-'
              }</li>
              <li><strong>Factura Copart:</strong> ${o.copartInvoiceUrl
                ? `<a href="${o.copartInvoiceUrl}" target="_blank">Ver PDF</a>`
                : '-'
              }</li>
              <li><strong>Fotos Copart:</strong> ${o.copartPhotos?.length
                ? `<a href="#" class="toggle-client-detail" data-detail="cp-${doc.id}">Ver fotos</a>
                   <div id="cp-${doc.id}" class="gallery" style="display:none;">
                     ${o.copartPhotos.map(u => `<img src="${u}" class="thumb"/>`).join('')}
                   </div>`
                : '-'
              }</li>
              <li><strong>Grúa:</strong> ${o.recogida.valorGrua || '-'} USD</li>
              <li><strong>Barco:</strong> ${o.recogida.valorBarco || '-'} USD</li>
              <li><strong>Llegada HND:</strong>
                <a href="#" class="toggle-client-detail" data-detail="hnd-${doc.id}">Ver</a>
                <div id="hnd-${doc.id}" style="display:none;margin:.5rem 0;">${o.envioHnd.detail || '-'}</div>
              </li>
              <li><strong>Aduana:</strong>
                <a href="#" class="toggle-client-detail" data-detail="adu-${doc.id}">Ver</a>
                <div id="adu-${doc.id}" style="display:none;margin:.5rem 0;">${o.aduana.detail || '-'}</div>
              </li>
              <li><strong>Entrega Final:</strong>
                <a href="#" class="toggle-client-detail" data-detail="ent-${doc.id}">Ver</a>
                <div id="ent-${doc.id}" style="display:none;margin:.5rem 0;">
                  ${o.entrega.detail || '-'}<br>
                  <strong>Precio final:</strong> ${o.entrega.precioFinal || '-'} LPS
                </div>
              </li>
              <li><strong>Fotos Entrega:</strong> ${o.entrega.deliveryPhotos?.length
                ? `<a href="#" class="toggle-client-detail" data-detail="dp-${doc.id}">Ver fotos</a>
                   <div id="dp-${doc.id}" class="gallery" style="display:none;">
                     ${o.entrega.deliveryPhotos.map(u => `<img src="${u}" class="thumb"/>`).join('')}
                   </div>`
                : '-'
              }</li>
              <li><strong>Últ. actualización:</strong> ${o.updatedAt?.toDate().toLocaleString('es-HN') || '-'}</li>
            </ul>
          </div>`;
        clientOrdersContainer.appendChild(card);
      });
      // acordeón y toggles
      document.querySelectorAll('.accordion-header').forEach(h => {
        h.onclick = () => {
          document.getElementById('acc-'+h.dataset.acc).classList.toggle('open');
        };
      });
      document.querySelectorAll('.toggle-client-detail').forEach(a => {
        a.onclick = e => {
          e.preventDefault();
          const tgt = document.getElementById(a.dataset.detail);
          tgt.style.display = tgt.style.display === 'none' ? 'block' : 'none';
        };
      });
    }

    // Autenticación y carga inicial
    auth.onAuthStateChanged(user => {
      if (!user) return window.location.href = 'login.html';
      // saludo
      document.getElementById('userGreeting').textContent   = `Hola, ${user.displayName||user.email}`;
      document.getElementById('mobileGreeting').textContent = `Hola, ${user.displayName||user.email}`;
      // perfil
      db.collection('clients').doc(user.uid).get().then(doc => {
        if (doc.exists) {
          const d = doc.data();
          document.getElementById('name').value      = d.fullName  || '';
          document.getElementById('email').value     = d.email     || user.email;
          document.getElementById('phone').value     = d.phone     || '';
          document.getElementById('address').value   = d.address   || '';
          document.getElementById('dni').value       = d.dni       || '';
          document.getElementById('birthYear').value = d.birthYear || '';
        }
      });
      // historial y gestiones
      cargarHistorial();
      fetchClientOrders();
      // inicializamos la pestaña visible
      showSection('perfil');
    });

    function sendPasswordReset() {
      auth.sendPasswordResetEmail(auth.currentUser.email)
        .then(() => alert('🔗 Enlace enviado al correo.'))
        .catch(() => alert('❌ Error al enviar enlace.'));
    }
    function logout() {
      auth.signOut().then(() => window.location.href = 'login.html');
    }
  </script>
</body>
</html>
