<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil ‚Äì SubastaCarHN</title>

  <!-- Fuentes e √≠conos -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', sans-serif; background: var(--light); color: var(--text); line-height: 1.6; }
    a { text-decoration: none; color: inherit; }
    ul { list-style: none; margin: 0; padding: 0; }
    .container { max-width: var(--max-width); margin: 0 auto; padding: 0 1rem; }

    /* Header */
    .site-header {
      background: linear-gradient(to right, var(--blue), var(--blue2));
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
    }
    .brand {
      color: #fff;
      font-size: 1.5rem;
      font-weight: 700;
    }
    .nav-list {
      display: flex;
      gap: 1rem;
      margin-left: auto;
    }
    .nav-list a, .nav-list span {
      color: var(--yellow);
      font-weight: 600;
      font-size: 0.95rem;
    }
    .menu-icon {
      background: var(--yellow);
      color: var(--blue);
      border: none;
      padding: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .mobile-nav {
      display: none;
      flex-direction: column;
      background: #fff;
      padding: 1rem;
      box-shadow: 0 2px 8px var(--shadow);
    }
    .mobile-nav.open { display: flex; gap: 0.5rem; }
    .mobile-nav a, .mobile-nav span {
      font-weight: 700;
      padding: 0.75rem;
      border-radius: 4px;
      transition: background 0.2s;
      color: var(--blue);
    }
    .mobile-nav a:hover, .mobile-nav span:hover {
      background: rgba(0,47,108,0.1);
    }
    @media (max-width: 767px) { .nav-list { display: none; } }
    @media (min-width: 768px) { .menu-icon { display: none; } }

    /* Main Layout */
    main.layout {
      padding: 2rem 1rem;
    }
    .contenido-central {
      max-width: 500px;
      margin: 0 auto;
      background: #fff;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .contenido-central h1 {
      text-align: center;
      color: var(--blue);
      margin-bottom: 1.5rem;
    }
    label {
      font-weight: bold;
      color: var(--blue);
      display: block;
      margin-top: 10px;
    }
    input {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--blue2);
      background: #f0f8ff;
      margin-top: 5px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .readonly {
      background: #e4e4e4;
      color: #555;
    }
    small.note {
      font-size: 12px;
      color: #666;
      display: block;
      margin-top: -0.20rem;
      margin-bottom: 1rem;
    }
    .styled-btn {
      background-color: var(--yellow);
      color: var(--blue);
      font-weight: bold;
      border: none;
      border-radius: 8px;
      padding: 10px;
      margin-top: 20px;
      width: 100%;
      cursor: pointer;
      font-size: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .styled-btn:hover { background-color: #e6ac00; }
    .success-msg {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      text-align: center;
    }

    /* Footer */
    .site-footer {
      background: var(--blue2);
      color: #fff;
      text-align: center;
      padding: 1rem 0;
      margin-top: 2rem;
    }
    .footer-nav .footer-list {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    .footer-nav .footer-list a, .social-links a {
      color: var(--yellow);
      font-weight: 500;
    }
    .footer-copy {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    /* Reutilizamos estilos de admin para las tarjetas */
    .orders-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      margin-top: 2rem;
    }
    .order-card {
      border:1px solid #ddd;
      border-radius:6px;
      overflow:hidden;
      background:#fff;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .accordion-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:.75rem 1rem;
      background:var(--blue2);
      color:#fff;
      cursor:pointer;
    }
    .status-badge {
      background:var(--yellow);
      color:var(--text);
      padding:2px 8px;
      border-radius:4px;
      font-size:.8rem;
    }
    .accordion-content {
      max-height:0;
      overflow:hidden;
      transition:max-height .3s ease, padding .3s ease;
      padding:0 1rem;
    }
    .accordion-content.open {
      padding:1rem;
      max-height:800px;
    }
    .tracker {
      list-style:none;
      display:flex;
      gap:.5rem;
      padding:0;
      margin-bottom:.75rem;
      flex-wrap:wrap;
    }
    .tracker li {
      position:relative;
      padding-left:1.2rem;
      font-size:.8rem;
    }
    .tracker li::before {
      content:'';
      position:absolute;
      left:0;
      top:.2rem;
      width:.8rem;
      height:.8rem;
      border-radius:50%;
      background:#ccc;
    }
    .tracker li.done::before { background:var(--yellow); }
    .tracker li.active::before { background:var(--blue); }
    .summary { list-style:none; padding:0; margin:0; font-size:.9rem; }
    .summary li { margin-bottom:.5rem; }
    .gallery { display:flex; flex-wrap:wrap; gap:4px; margin-top:4px; }
    .gallery img { width:60px; height:60px; object-fit:cover; border:1px solid #ddd; border-radius:4px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">SubastaCarHN</a>
      <ul class="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calculadora.html">Calculadora</a></li>
        <li><a href="inventario.html">Veh√≠culos</a></li>
        <li><a href="cursos.html">Cursos</a></li>
        <li><a href="https://wa.me/50497330137" target="_blank">Soporte</a></li>
        <li><span id="userGreeting"></span></li>
      </ul>
      <button class="menu-icon" onclick="toggleMenu()">‚ò∞</button>
    </div>
    <nav id="mobile-menu-links" class="mobile-nav">
      <a href="index.html">Inicio</a>
      <a href="calculadora.html">Calculadora</a>
      <a href="inventario.html">Veh√≠culos</a>
      <a href="cursos.html">Cursos</a>
      <a href="https://wa.me/50497330137" target="_blank">Soporte</a>
      <span id="mobileGreeting"></span>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="layout">
    <div class="contenido-central">
      <h1>Mi Perfil</h1>
      <form id="profileForm">
        <label for="name">Nombre completo</label>
        <input type="text" id="name" required />

        <label for="email">Correo electr√≥nico</label>
        <input type="email" id="email" class="readonly" readonly />

        <label for="phone">Tel√©fono</label>
        <input type="tel" id="phone" class="readonly" readonly />

        <label for="address">Direcci√≥n</label>
        <input type="text" id="address" />

        <label for="dni">DNI</label>
        <input type="text" id="dni" />

        <label for="birthYear">A√±o de nacimiento</label>
        <input type="number" id="birthYear" min="1900" max="2100" />
        <small class="note">El DNI y el a√±o de nacimiento te ayudar√°n a recuperar tu cuenta si pierdes el acceso.</small>

        <button type="submit" class="styled-btn">Guardar cambios</button>
        <button type="button" class="styled-btn" onclick="sendPasswordReset()">Cambiar contrase√±a</button>
        <button type="button" class="styled-btn" onclick="logout()">Cerrar sesi√≥n</button>

        <div id="successMsg" class="success-msg" style="display:none;">
          ‚úÖ Tus datos han sido actualizados con √©xito.
        </div>
      </form>

      <!-- === Inicio: Nueva Gesti√≥n de Pedido === -->
      <button id="btnStartGestion" class="styled-btn">Comenzar gesti√≥n</button>

      <div id="depositForm" style="display:none; margin-top:1rem; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom:.5rem;color:var(--blue2)">Subir comprobante de dep√≥sito (5,000 LPS)</h2>
        <input type="file" id="depositFile" accept="application/pdf,image/*" />
        <button id="btnUploadDeposit" class="styled-btn" style="margin-top:.75rem;">Enviar comprobante</button>
      </div>

      <div id="depositSuccess" class="success-msg" style="display:none; margin-top:1rem;">
        ‚úÖ Comprobante enviado. Pronto comenzaremos la gesti√≥n.
      </div>
      <!-- === Fin: Nueva Gesti√≥n de Pedido === -->

      <hr style="margin: 2rem 0; border: none; border-top: 2px dashed #ccc;" />

      <!-- === Inicio: Secci√≥n Mis Gestiones === -->
      <h2 style="text-align:center; color: var(--blue); margin-bottom:1rem;">Mis Gestiones</h2>
      <div id="clientOrdersContainer" class="orders-grid" style="max-width:800px; margin:0 auto;"></div>
      <!-- === Fin: Secci√≥n Mis Gestiones === -->

      <h2 style="text-align:center; color: var(--blue);">Historial de C√°lculos</h2>
      <div id="historialContainer" style="margin-top: 1rem;"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <nav class="footer-nav">
        <ul class="footer-list">
          <li><a href="index.html">Inicio</a></li>
          <li><a href="calculadora.html">Calculadora</a></li>
          <li><a href="inventario.html">Veh√≠culos</a></li>
          <li><a href="cursos.html">Cursos</a></li>
          <li><a href="contacto.html">Contacto</a></li>
        </ul>
      </nav>
      <div class="social-links">
        <a href="https://facebook.com/Subasta-Car-HN" target="_blank">Facebook</a> |
        <a href="https://instagram.com/subastacar1" target="_blank">Instagram</a> |
        <a href="https://tiktok.com/@tu_amigo_el_importador" target="_blank">TikTok</a>
      </div>
      <div class="footer-copy">&copy; 2025 SubastaCarHN. Todos los derechos reservados.</div>
    </div>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    };
    firebase.initializeApp(firebaseConfig);

    const auth    = firebase.auth();
    const db      = firebase.firestore();
    const storage = firebase.storage().ref();

    // Men√∫ m√≥vil
    function toggleMenu() {
      document.getElementById('mobile-menu-links').classList.toggle('open');
    }

    // Funciones de perfil e historial
    async function cargarHistorial() {
      const uid = auth.currentUser.uid;
      const snap = await db.collection('clients').doc(uid)
        .collection('historial').orderBy('fecha','desc').limit(100).get();
      const cont = document.getElementById('historialContainer');
      if (snap.empty) return cont.innerHTML = '<p style="text-align:center;">A√∫n no hay c√°lculos guardados.</p>';
      cont.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const fecha = d.fecha?.toDate().toLocaleString('es-HN') || 'Fecha desconocida';
        return `
          <div id="historial-${doc.id}" style="background:#f0f8ff;padding:1rem;border-radius:10px;margin-bottom:1rem;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <input type="text" value="${d.nombre||'Sin t√≠tulo'}" 
              onchange="renombrarHistorial('${doc.id}', this.value)" 
              style="font-weight:bold;border:none;background:transparent;color:#002f6c;width:100%;"/>
            <small>${fecha}</small><br>
            <strong style="color:#004aad;">${d.total||'-'}</strong><br><br>
            <button class="styled-btn" onclick="verDetallesHistorial('${doc.id}')">Ver detalles</button>
            <button class="styled-btn" onclick="descargarHistorialPDF('${doc.id}')">Descargar PDF</button>
            <button class="styled-btn" onclick="eliminarHistorial('${doc.id}')">Eliminar</button>
          </div>`;
      }).join('');
    }
    async function renombrarHistorial(id, nombre) {
      await db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).update({ nombre })
        .then(cargarHistorial)
        .catch(()=>alert('‚ùå No se pudo renombrar.'));
    }
    async function eliminarHistorial(id) {
      if (!confirm('¬øSeguro que deseas eliminar este historial?')) return;
      await db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).delete()
        .then(cargarHistorial)
        .catch(()=>alert('‚ùå No se pudo eliminar.'));
    }
    function verDetallesHistorial(id) {
      document.querySelectorAll('.detalle-abierto').forEach(e=>e.remove());
      db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).get()
        .then(doc => {
          if (!doc.exists) return alert('‚ùå No se encontr√≥ este c√°lculo.');
          const data = doc.data();
          const cont = document.getElementById(`historial-${id}`);
          const detalle = document.createElement('div');
          detalle.classList.add('detalle-abierto');
          detalle.innerHTML = `
            <div style="margin-top:1rem;border:1px dashed #ccc;border-radius:10px;padding:10px;">
              <table style="width:100%;border-collapse:collapse;">
                <tr><th>Concepto</th><th>Valor</th></tr>
                ${data.detalles.map(i=>`<tr><td style="border:1px solid #ddd;padding:6px;">${i.titulo}</td><td style="border:1px solid #ddd;padding:6px;">${i.valor}</td></tr>`).join('')}
              </table>
              <button class="styled-btn" onclick="this.parentElement.parentElement.remove()">Cerrar</button>
            </div>`;
          cont.appendChild(detalle);
        });
    }
    function descargarHistorialPDF(id) {
      db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).get()
        .then(doc => {
          if (!doc.exists) return alert('‚ùå No se encontr√≥ este c√°lculo.');
          const d = doc.data();
          const w = window.open('', '_blank', 'width=800,height=600');
          w.document.write(`
            <html><head><title>${d.nombre}</title>
            <style>body{font-family:Arial;margin:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ccc;padding:8px;}</style>
            </head><body>
            <h2 style="text-align:center;">${d.nombre}</h2>
            <p><strong>Total Final:</strong> ${d.total}</p>
            <table><tr><th>Concepto</th><th>Valor</th></tr>
              ${d.detalles.map(i=>`<tr><td>${i.titulo}</td><td>${i.valor}</td></tr>`).join('')}
            </table></body></html>
          `);
          setTimeout(() => w.print(), 500);
        });
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî Nuevas funciones de Gesti√≥n ‚Äî‚Äî‚Äî‚Äî‚Äî
    const btnStartGestion  = document.getElementById('btnStartGestion');
    const depositForm      = document.getElementById('depositForm');
    const depositFile      = document.getElementById('depositFile');
    const btnUploadDeposit = document.getElementById('btnUploadDeposit');
    const depositSuccess   = document.getElementById('depositSuccess');
    const clientOrdersContainer = document.getElementById('clientOrdersContainer');
    const STEPS = ['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];

    btnStartGestion.onclick = () => {
      depositForm.style.display     = 'block';
      btnStartGestion.style.display = 'none';
      depositSuccess.style.display  = 'none';
      window.scrollTo({ top: depositForm.offsetTop - 20, behavior: 'smooth' });
    };

    btnUploadDeposit.onclick = async () => {
      if (!depositFile.files[0]) {
        return alert('Selecciona un comprobante antes de enviar.');
      }
      try {
        btnUploadDeposit.disabled    = true;
        btnUploadDeposit.textContent = 'Subiendo‚Ä¶';

        const user = auth.currentUser;
        const file = depositFile.files[0];
        const path = `orders/${user.uid}/deposit/${Date.now()}_${file.name}`;
        const snap = await storage.child(path).put(file);
        const url  = await snap.ref.getDownloadURL();

        const payload = {
          clientName        : user.displayName || user.email,
          clientEmail       : user.email,
          clientPhone       : document.getElementById('phone').value,
          depositReceiptUrl : url,
          depositAmount     : 5000,
          createdAt         : firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt         : firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('orders').add(payload);

        depositForm.style.display    = 'none';
        depositSuccess.style.display = 'block';
        fetchClientOrders();
      } catch (err) {
        console.error(err);
        alert('‚ùå Error al subir el comprobante. Intenta de nuevo.');
      } finally {
        btnUploadDeposit.disabled    = false;
        btnUploadDeposit.textContent = 'Enviar comprobante';
      }
    };

    function getDisplayStatus(order) {
      if (order.entrega?.deliveryPhotos?.length) return 'Finalizado';
      if (order.aduana?.detail)              return 'Aduana';
      if (order.recogida?.valorGrua || order.recogida?.valorBarco) return 'Enviado';
      if (order.copartInvoiceUrl)            return 'Pagado';
      if (order.depositReceiptUrl)           return 'Pago Pendiente';
      return 'Inicio';
    }

    async function fetchClientOrders() {
      const user = auth.currentUser;
      if (!user) return;
      clientOrdersContainer.innerHTML = '';
      const snap = await db.collection('orders')
        .where('clientEmail', '==', user.email)
        .orderBy('createdAt', 'desc')
        .get();

      if (snap.empty) {
        clientOrdersContainer.innerHTML = '<p style="text-align:center;">A√∫n no tienes gestiones iniciadas.</p>';
        return;
      }

      snap.docs.forEach(doc => {
        const d = doc.data();
        const status = getDisplayStatus(d);
        const stepsHtml = STEPS.map((s,i) => {
          const cls = i < STEPS.indexOf(status) ? 'done'
                     : (i === STEPS.indexOf(status) ? 'active' : '');
          return `<li class="${cls}">${s}</li>`;
        }).join('');
        const copartGallery = d.copartPhotos?.length
          ? `<a href="#" class="toggle-client-detail" data-detail="cp-${doc.id}">Ver fotos Copart</a>
             <div id="cp-${doc.id}" class="gallery" style="display:none;">
               ${d.copartPhotos.map(u=>`<img src="${u}" class="thumb"/>`).join('')}
             </div>` : '-';
        const deliveryGallery = d.entrega?.deliveryPhotos?.length
          ? `<a href="#" class="toggle-client-detail" data-detail="dp-${doc.id}">Ver fotos Entrega</a>
             <div id="dp-${doc.id}" class="gallery" style="display:none;">
               ${d.entrega.deliveryPhotos.map(u=>`<img src="${u}" class="thumb"/>`).join('')}
             </div>` : '-';

        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div class="accordion-header" data-acc="${doc.id}">
            <div><strong>#${doc.id.slice(0,6)}</strong> ${d.clientName}</div>
            <div><span class="status-badge">${status}</span></div>
          </div>
          <div id="acc-${doc.id}" class="accordion-content">
            <ul class="tracker">${stepsHtml}</ul>
            <ul class="summary">
              <li><strong>Dep√≥sito (LPS):</strong> ${d.depositAmount}</li>
              <li><strong>Factura Copart:</strong> ${d.copartInvoiceUrl
                ? `<a href="${d.copartInvoiceUrl}" target="_blank">Ver PDF</a>` : '-'
              }</li>
              <li><strong>Fotos Copart:</strong> ${copartGallery}</li>
              <li><strong>Gr√∫a (USD):</strong> ${d.recogida?.valorGrua||'-'}</li>
              <li><strong>Barco (USD):</strong> ${d.recogida?.valorBarco||'-'}</li>
              <li><strong>Llegada HND:</strong>
                <a href="#" class="toggle-client-detail" data-detail="hnd-${doc.id}">Ver</a>
                <div id="hnd-${doc.id}" style="display:none;margin:.5rem 0;">${d.envioHnd?.detail||'-'}</div>
              </li>
              <li><strong>Aduana:</strong>
                <a href="#" class="toggle-client-detail" data-detail="adu-${doc.id}">Ver</a>
                <div id="adu-${doc.id}" style="display:none;margin:.5rem 0;">${d.aduana?.detail||'-'}</div>
              </li>
              <li><strong>Entrega Final:</strong>
                <a href="#" class="toggle-client-detail" data-detail="ent-${doc.id}">Ver</a>
                <div id="ent-${doc.id}" style="display:none;margin:.5rem 0;">${d.entrega?.detail||'-'}</div>
              </li>
              <li><strong>Fotos Entrega:</strong> ${deliveryGallery}</li>
              <li><strong>√öltima actualizaci√≥n:</strong> ${d.updatedAt?.toDate().toLocaleString('es-HN')||'-'}</li>
            </ul>
          </div>`;
        clientOrdersContainer.appendChild(card);
      });

      // Acorde√≥n y toggles
      clientOrdersContainer.querySelectorAll('.accordion-header').forEach(h => {
        h.onclick = () => document.getElementById('acc-'+h.dataset.acc).classList.toggle('open');
      });
      clientOrdersContainer.querySelectorAll('.toggle-client-detail').forEach(a => {
        a.onclick = e => {
          e.preventDefault();
          const tgt = document.getElementById(a.dataset.detail);
          tgt.style.display = tgt.style.display==='none'?'block':'none';
        };
      });
    }

    // Control de estado y carga inicial
    auth.onAuthStateChanged(async user => {
      if (!user) return window.location.href = 'login.html';
      document.getElementById('userGreeting').textContent   = `Hola, ${user.displayName || user.email}`;
      document.getElementById('mobileGreeting').textContent = `Hola, ${user.displayName || user.email}`;

      // Cargar perfil
      const doc = await db.collection('clients').doc(user.uid).get();
      if (doc.exists) {
        const d = doc.data();
        document.getElementById('name').value      = d.fullName || '';
        document.getElementById('email').value     = d.email    || user.email;
        document.getElementById('phone').value     = d.phone    || '';
        document.getElementById('address').value   = d.address  || '';
        document.getElementById('dni').value       = d.dni      || '';
        document.getElementById('birthYear').value = d.birthYear|| '';
      }
      // Cargar historial y gestiones
      cargarHistorial();
      fetchClientOrders();
    });

    // Recuperar contrase√±a y cerrar sesi√≥n
    function sendPasswordReset() {
      auth.sendPasswordResetEmail(auth.currentUser.email)
        .then(() => alert('üîó Enlace enviado al correo.'))
        .catch(() => alert('‚ùå Error al enviar enlace.'));
    }
    function logout() {
      auth.signOut().then(() => window.location.href = 'login.html');
    }
  </script>
</body>
</html>
