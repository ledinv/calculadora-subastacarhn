<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil – SubastaCarHN</title>

  <!-- Fuentes e íconos -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1000px;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); line-height:1.5 }
    a { text-decoration:none; color:inherit }
    ul { list-style:none }
    header.site-header {
      background:var(--blue); padding:1rem;
      position:sticky; top:0; z-index:1000;
    }
    .header-inner { max-width:var(--max-width); margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .brand { color:#fff; font-size:1.75rem; font-weight:700 }
    .nav-list { display:flex; gap:1rem }
    .nav-list a { color:var(--yellow); font-weight:600 }
    .menu-icon {
      display:none; background:var(--yellow); color:var(--blue);
      border:none; padding:.5rem; border-radius:6px; cursor:pointer;
    }
    @media(max-width:767px) {
      .nav-list { display:none }
      .menu-icon { display:block }
    }
    .mobile-nav {
      display:none; position:absolute; top:100%; left:0; right:0;
      background:#fff; box-shadow:0 2px 8px var(--shadow); flex-direction:column;
    }
    .mobile-nav.open { display:flex }
    .mobile-nav a { padding:1rem; border-bottom:1px solid #eee; color:var(--blue); font-weight:600 }

    main { max-width:var(--max-width); margin:2rem auto; padding:0 1rem }
    .tabs { display:flex; border-bottom:2px solid var(--blue2); }
    .tab {
      flex:1; padding:.75rem; background:var(--blue2); color:#fff;
      text-align:center; cursor:pointer; font-weight:600;
    }
    .tab.active { background:var(--blue); }
    section { display:none; margin-top:1rem }
    section.active { display:block }

    /* PERFIL */
    form.profile-form {
      background:#fff; padding:2rem; border-radius:8px;
      box-shadow:0 4px 12px var(--shadow);
    }
    .profile-form h2 { margin-bottom:1rem; color:var(--blue) }
    .profile-form label { display:block; margin-top:1rem; font-weight:600; }
    .profile-form input {
      width:100%; padding:.75rem; margin-top:.25rem;
      border:1px solid var(--blue2); border-radius:4px;
    }
    .profile-form input.readonly { background:#e4e4e4 }
    .profile-form button {
      margin-top:1.5rem; width:100%; padding:.75rem;
      background:var(--yellow); color:var(--blue); border:none;
      border-radius:4px; font-weight:600; cursor:pointer;
    }
    .profile-form .btn-secondary {
      background:transparent; border:2px solid var(--yellow);
      color:var(--yellow); margin-top:.5rem;
    }
    .success-msg {
      margin-top:1rem; padding:.75rem; background:#d4edda;
      color:#155724; border-radius:4px; text-align:center;
    }

    /* GESTIÓN */
    .styled-btn {
      background:var(--yellow); color:var(--blue); border:none;
      padding:.75rem; border-radius:4px; cursor:pointer;
      font-weight:600; width:100%; margin-top:1rem;
    }
    .orders-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:1rem; margin-top:1rem;
    }
    .order-card {
      background:#fff; border:1px solid #ddd; border-radius:6px;
      overflow:hidden; box-shadow:0 2px 6px var(--shadow);
    }
    .accordion-header {
      background:var(--blue2); color:#fff; padding:.75rem 1rem;
      cursor:pointer; display:flex; justify-content:space-between;
      align-items:center;
    }
    .status-badge {
      background:var(--yellow); color:var(--text);
      padding:2px 6px; border-radius:4px; font-size:.8rem;
    }
    .accordion-content {
      max-height:0; overflow:hidden;
      transition:max-height .3s ease, padding .3s ease;
      padding:0 1rem;
    }
    .accordion-content.open {
      padding:1rem; max-height:600px;
    }
    .tracker { list-style:none; display:flex; gap:.5rem; flex-wrap:wrap; padding:0; margin-bottom:1rem }
    .tracker li {
      position:relative; padding-left:1.2rem; font-size:.8rem;
    }
    .tracker li::before {
      content:''; position:absolute; left:0; top:.2rem;
      width:.8rem; height:.8rem; border-radius:50%; background:#ccc;
    }
    .tracker li.done::before { background:var(--yellow) }
    .tracker li.active::before { background:var(--blue) }
    .summary { list-style:none; padding:0; font-size:.9rem }
    .summary li { margin-bottom:.5rem }

    /* HISTORIAL */
    .hist-card {
      background:#fff; padding:1rem; border-radius:6px;
      box-shadow:0 2px 6px var(--shadow); margin-bottom:1rem;
    }
    .hist-card input {
      width:100%; border:none; background:transparent;
      font-weight:600; color:var(--blue2); margin-bottom:.5rem;
    }
    .hist-card small { display:block; color:#666; margin-bottom:.5rem }

    /* FOOTER */
    footer.site-footer {
      background:var(--blue2); color:#fff; text-align:center;
      padding:1rem; margin-top:2rem;
    }
    footer.site-footer a { color:var(--yellow); margin:0 .5rem }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="brand">SubastaCarHN</a>
      <ul class="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calculadora.html">Calculadora</a></li>
        <li><a href="inventario.html">Vehículos</a></li>
        <li><a href="cursos.html">Cursos</a></li>
        <li><a href="#" onclick="logout()">Cerrar sesión</a></li>
      </ul>
      <button class="menu-icon" onclick="toggleMenu()">☰</button>
    </div>
    <nav id="mobile-nav" class="mobile-nav">
      <a href="index.html">Inicio</a>
      <a href="calculadora.html">Calculadora</a>
      <a href="inventario.html">Vehículos</a>
      <a href="cursos.html">Cursos</a>
      <a href="#" onclick="logout()">Cerrar sesión</a>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main>

    <!-- TABS -->
    <div class="tabs">
      <div class="tab active" data-sec="perfil">Perfil</div>
      <div class="tab" data-sec="gestion">Gestión</div>
      <div class="tab" data-sec="historial">Historial</div>
    </div>

    <!-- PERFIL -->
    <section id="perfil" class="active">
      <form id="profileForm" class="profile-form">
        <h2>Mi Perfil</h2>
        <label for="name">Nombre completo</label>
        <input type="text" id="name" required />

        <label for="email">Correo electrónico</label>
        <input type="email" id="email" class="readonly" readonly />

        <label for="phone">Teléfono</label>
        <input type="tel" id="phone" class="readonly" readonly />

        <label for="address">Dirección</label>
        <input type="text" id="address" />

        <label for="dni">DNI</label>
        <input type="text" id="dni" />

        <label for="birthYear">Año de nacimiento</label>
        <input type="number" id="birthYear" min="1900" max="2100" />

        <button type="submit">Guardar cambios</button>
        <button type="button" class="btn-secondary" onclick="sendPasswordReset()">Cambiar contraseña</button>
        <button type="button" class="btn-secondary" onclick="logout()">Cerrar sesión</button>

        <div id="successMsg" class="success-msg" style="display:none;">
          ✅ Tus datos han sido actualizados con éxito.
        </div>
      </form>
    </section>

    <!-- GESTIÓN -->
    <section id="gestion">
      <h2>Gestión de Vehículos</h2>
      <button id="btnStartGestion" class="styled-btn">Comenzar gestión</button>
      <div id="depositForm" style="display:none; margin-top:1rem;">
        <label>Subir comprobante de depósito (5,000 LPS)</label>
        <input type="file" id="depositFile" accept="application/pdf,image/*" />
        <button id="btnUploadDeposit" class="styled-btn">Enviar comprobante</button>
      </div>
      <div id="depositSuccess" class="success-msg" style="display:none;">
        ✅ Comprobante enviado. Pronto comenzaremos la gestión.
      </div>
      <h3 style="margin-top:1.5rem;">Mis Gestiones</h3>
      <div id="clientOrdersContainer" class="orders-grid"></div>
    </section>

    <!-- HISTORIAL -->
    <section id="historial">
      <h2>Historial de Cálculos</h2>
      <div id="historialContainer"></div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <a href="index.html">Inicio</a> •
    <a href="calculadora.html">Calculadora</a> •
    <a href="inventario.html">Vehículos</a> •
    <a href="cursos.html">Cursos</a>
    <p>&copy; 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Toggle mobile nav
    function toggleMenu() {
      document.getElementById('mobile-nav').classList.toggle('open');
    }

    // Initialize Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web=e3eabb4dcd898c2ffe8cf7"
    });
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage().ref();

    // TAB functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.sec).classList.add('active');
      };
    });

    // Auth state & load initial data
    auth.onAuthStateChanged(async user => {
      if (!user) return location = 'login.html';
      loadProfile(user.uid);
      cargarHistorial();
      fetchClientOrders();
    });

    // Load and handle profile form
    async function loadProfile(uid) {
      const doc = await db.collection('clients').doc(uid).get();
      const data = doc.exists ? doc.data() : {};
      document.getElementById('name').value = data.fullName || '';
      document.getElementById('email').value = data.email || '';
      document.getElementById('phone').value = data.phone || '';
      document.getElementById('address').value = data.address || '';
      document.getElementById('dni').value = data.dni || '';
      document.getElementById('birthYear').value = data.birthYear || '';
    }
    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      const user = auth.currentUser;
      await db.collection('clients').doc(user.uid).update({
        fullName: document.getElementById('name').value,
        address: document.getElementById('address').value,
        dni: document.getElementById('dni').value,
        birthYear: document.getElementById('birthYear').value
      });
      const msg = document.getElementById('successMsg');
      msg.style.display = 'block';
      setTimeout(() => msg.style.display = 'none', 3000);
    };
    function sendPasswordReset() {
      auth.sendPasswordResetEmail(auth.currentUser.email)
        .then(() => alert('🔗 Enlace enviado al correo.'));
    }
    function logout() {
      auth.signOut().then(() => location = 'login.html');
    }

    // Gestión: deposit upload
    document.getElementById('btnStartGestion').onclick = () => {
      document.getElementById('depositForm').style.display = 'block';
    };
    document.getElementById('btnUploadDeposit').onclick = async () => {
      const file = document.getElementById('depositFile').files[0];
      if (!file) return alert('Selecciona un comprobante.');
      const user = auth.currentUser;
      const snap = await storage.child(`orders/${user.uid}/deposit/${Date.now()}_${file.name}`).put(file);
      const url = await snap.ref.getDownloadURL();
      await db.collection('orders').add({
        clientName: user.displayName || user.email,
        clientEmail: user.email,
        clientPhone: document.getElementById('phone').value,
        depositReceiptUrl: url,
        depositAmount: 5000,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('depositSuccess').style.display = 'block';
      fetchClientOrders();
    };

    // Fetch and render client orders
    async function fetchClientOrders() {
      const user = auth.currentUser;
      const snap = await db.collection('orders')
        .where('clientEmail', '==', user.email)
        .orderBy('createdAt', 'desc')
        .get();
      const container = document.getElementById('clientOrdersContainer');
      container.innerHTML = '';
      snap.forEach(doc => {
        const o = doc.data();
        const status = o.depositReceiptUrl ? 'Pago Pendiente' : 'Finalizado';
        const card = document.createElement('div');
        card.className = 'order-card';
        card.innerHTML = `
          <div class="accordion-header">
            <span>#${doc.id.slice(0,6)}</span>
            <span class="status-badge">${status}</span>
          </div>
          <div class="accordion-content">
            <ul class="summary">
              <li><strong>Depósito:</strong> ${o.depositAmount} LPS</li>
              <li><strong>Comprobante:</strong> <a href="${o.depositReceiptUrl}" target="_blank">Ver</a></li>
            </ul>
          </div>`;
        card.querySelector('.accordion-header').onclick = () => {
          card.querySelector('.accordion-content').classList.toggle('open');
        };
        container.appendChild(card);
      });
    }

    // Historial: load, rename
    async function cargarHistorial() {
      const user = auth.currentUser;
      const snap = await db.collection('clients').doc(user.uid)
        .collection('historial').orderBy('fecha','desc').limit(100).get();
      const cont = document.getElementById('historialContainer');
      if (snap.empty) {
        cont.innerHTML = '<p style="text-align:center;">Aún no hay cálculos guardados.</p>';
        return;
      }
      cont.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const fecha = d.fecha?.toDate().toLocaleString('es-HN') || '';
        return `
          <div class="hist-card" id="historial-${doc.id}">
            <input type="text" value="${d.nombre||'Sin título'}"
              onchange="renombrarHistorial('${doc.id}',this.value)" />
            <small>${fecha}</small><br>
            <strong>L ${d.total||'-'}</strong>
          </div>`;
      }).join('');
    }
    async function renombrarHistorial(id,nuevo) {
      try {
        await db.collection('clients').doc(auth.currentUser.uid)
          .collection('historial').doc(id).update({ nombre:nuevo });
        const cont = document.getElementById(`historial-${id}`);
        const msg = document.createElement('div');
        msg.className = 'success-msg'; msg.textContent = '✅ Renombrado';
        cont.appendChild(msg);
        setTimeout(()=>msg.remove(),3000);
      } catch {
        alert('❌ No se pudo renombrar');
      }
    }
  </script>
</body>
</html>
