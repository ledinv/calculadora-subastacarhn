<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mi Perfil – SubastaCarHN</title>

  <!-- Fuentes e íconos -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
    }
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0 }
    body { font-family:'Montserrat',sans-serif; background:var(--light); color:var(--text); line-height:1.6 }
    a { text-decoration:none; color:inherit }
    ul { list-style:none }
    .container { max-width:var(--max-width); margin:0 auto; padding:0 1rem }

    /* Header */
    .site-header {
      background:var(--blue);
      position: sticky; top:0; z-index:1000;
    }
    .header-inner { display:flex; align-items:center; justify-content:space-between; padding:.75rem }
    .brand { color:#fff; font-size:1.5rem; font-weight:700 }
    .nav-list { display:flex; gap:1rem; margin-left:auto }
    .nav-list a, .nav-list span { color:var(--yellow); font-weight:600; font-size:.95rem }
    .menu-icon {
      background:var(--yellow); color:var(--blue); border:none;
      padding:.5rem; border-radius:6px; cursor:pointer;
      box-shadow:0 2px 8px var(--shadow);
    }
    .mobile-nav {
      display:none; flex-direction:column; background:#fff; padding:1rem;
      box-shadow:0 2px 8px var(--shadow);
    }
    .mobile-nav.open { display:flex; }
    .mobile-nav a, .mobile-nav span {
      font-weight:700; padding:.75rem; border-radius:4px;
      transition:background .2s; color:var(--blue);
    }
    .mobile-nav a:hover, .mobile-nav span:hover { background:rgba(0,47,108,0.1) }
    @media (max-width:767px) { .nav-list { display:none; } }
    @media (min-width:768px) { .menu-icon { display:none; } }

    /* Main Layout */
    main.layout { padding:2rem 1rem }
    .contenido-central {
      max-width:500px; margin:0 auto; background:#fff;
      padding:2rem; border-radius:15px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
    }
    .contenido-central h1 { text-align:center; color:var(--blue); margin-bottom:1.5rem }
    label { display:block; font-weight:bold; color:var(--blue); margin-top:10px }
    input, textarea {
      width:100%; padding:8px; border-radius:8px;
      border:1px solid var(--blue2); background:#f0f8ff;
      margin-top:5px; font-size:14px; box-sizing:border-box;
    }
    .readonly { background:#e4e4e4; color:#555; }
    small.note { font-size:12px; color:#666; display:block; margin:-.2rem 0 1rem; }
    .styled-btn {
      background:var(--yellow); color:var(--blue); font-weight:bold;
      border:none; border-radius:8px; padding:10px; margin-top:20px;
      width:100%; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);
    }
    .styled-btn:hover { background:#e6ac00; }
    .success-msg {
      background:#d4edda; color:#155724; border:1px solid #c3e6cb;
      padding:10px; border-radius:6px; text-align:center; margin-top:10px;
    }

    /* Tabs moderno */
    .tabs {
      display:flex; border-bottom:2px solid var(--blue2); margin-top:2rem;
    }
    .tab {
      flex:1; padding:.75rem; background:var(--blue2);
      color:#fff; text-align:center; cursor:pointer; font-weight:600;
    }
    .tab.active { background:var(--blue); }
    .section { display:none; }
    .section.active { display:block; margin-top:1rem; }

    /* Gestión de Vehículos dentro de sección */
    .orders-grid {
      display:grid; gap:1rem;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      margin-top:1rem;
    }
    .order-card {
      border:1px solid #ddd; border-radius:6px; overflow:hidden;
      background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .accordion-header {
      display:flex; justify-content:space-between; align-items:center;
      padding:.75rem 1rem; background:var(--blue2); color:#fff; cursor:pointer;
    }
    .status-badge {
      background:var(--yellow); color:var(--text);
      padding:2px 8px; border-radius:4px; font-size:.8rem;
    }
    .accordion-content {
      max-height:0; overflow:hidden;
      transition:max-height .3s ease, padding .3s ease;
      padding:0 1rem;
    }
    .accordion-content.open {
      padding:1rem; max-height:800px;
    }
    .tracker {
      list-style:none; display:flex; gap:.5rem;
      padding:0; margin-bottom:.75rem; flex-wrap:wrap;
    }
    .tracker li {
      position:relative; padding-left:1.2rem; font-size:.8rem;
    }
    .tracker li::before {
      content:''; position:absolute; left:0; top:.2rem;
      width:.8rem; height:.8rem; border-radius:50%; background:#ccc;
    }
    .tracker li.done::before { background:var(--yellow) }
    .tracker li.active::before { background:var(--blue) }
    .summary { list-style:none; padding:0; margin:0; font-size:.9rem; }
    .summary li { margin-bottom:.5rem; }
    .gallery {
      display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;
    }
    .gallery img {
      width:60px; height:60px; object-fit:cover;
      border:1px solid #ddd; border-radius:4px;
    }

    /* Footer */
    .site-footer {
      background:var(--blue2); color:#fff; text-align:center;
      padding:1rem; margin-top:2rem;
    }
    .site-footer a { color:var(--yellow); text-decoration:none; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">SubastaCarHN</a>
      <ul class="nav-list">
        <li><a href="index.html">Inicio</a></li>
        <li><a href="calculadora.html">Calculadora</a></li>
        <li><a href="inventario.html">Vehículos</a></li>
        <li><a href="cursos.html">Cursos</a></li>
        <li><a href="#" onclick="logout()">Cerrar sesión</a></li>
      </ul>
      <button class="menu-icon" onclick="toggleMenu()">☰</button>
    </div>
    <nav id="mobile-menu-links" class="mobile-nav">
      <a href="index.html">Inicio</a>
      <a href="calculadora.html">Calculadora</a>
      <a href="inventario.html">Vehículos</a>
      <a href="cursos.html">Cursos</a>
      <a href="#" onclick="logout()">Cerrar sesión</a>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="layout">
    <div class="contenido-central">

      <!-- Perfil -->
      <h1>Mi Perfil</h1>
      <form id="profileForm">
        <label for="name">Nombre completo</label>
        <input type="text" id="name" required />

        <label for="email">Correo electrónico</label>
        <input type="email" id="email" class="readonly" readonly />

        <label for="phone">Teléfono</label>
        <input type="tel" id="phone" class="readonly" readonly />

        <label for="address">Dirección</label>
        <input type="text" id="address" />

        <label for="dni">DNI</label>
        <input type="text" id="dni" />

        <label for="birthYear">Año de nacimiento</label>
        <input type="number" id="birthYear" min="1900" max="2100" />
        <small class="note">El DNI y el año de nacimiento te ayudarán a recuperar tu cuenta si pierdes el acceso.</small>

        <button type="submit" class="styled-btn">Guardar cambios</button>
        <button type="button" class="styled-btn" onclick="sendPasswordReset()">Cambiar contraseña</button>
        <button type="button" class="styled-btn" onclick="logout()">Cerrar sesión</button>

        <div id="successMsg" class="success-msg" style="display:none;">
          ✅ Tus datos han sido actualizados con éxito.
        </div>
      </form>

      <!-- Tabs para secciones -->
      <div class="tabs">
        <div class="tab active" data-sec="gestion">Gestión</div>
        <div class="tab" data-sec="historial">Historial</div>
      </div>

      <!-- Sección Gestión -->
      <div id="section-gestion" class="section active">
        <button id="btnStartGestion" class="styled-btn">Comenzar gestión</button>
        <div id="depositForm" style="display:none; margin-top:1rem;">
          <h3>Subir comprobante de depósito (5,000 LPS)</h3>
          <input type="file" id="depositFile" accept="application/pdf,image/*" />
          <button id="btnUploadDeposit">Enviar comprobante</button>
        </div>
        <div id="depositSuccess" class="success-msg" style="display:none;">
          ✅ Comprobante enviado. Pronto comenzaremos la gestión.
        </div>
        <h4 style="margin-top:2rem; color:var(--blue);">Mis Gestiones</h4>
        <div id="clientOrdersContainer" class="orders-grid"></div>
      </div>

      <!-- Sección Historial -->
      <div id="section-historial" class="section">
        <h4 style="color:var(--blue);">Historial de Cálculos</h4>
        <div id="historialContainer" style="margin-top:1rem;"></div>
      </div>

    </div>
  </main>

  <!-- FOOTER -->
  <footer class="site-footer">
    <a href="index.html">Inicio</a> •
    <a href="calculadora.html">Calculadora</a> •
    <a href="inventario.html">Vehículos</a> •
    <a href="cursos.html">Cursos</a>
    <p>&copy; 2025 SubastaCarHN. Todos los derechos reservados.</p>
  </footer>

  <!-- Firebase SDKs y lógica -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.app().storage("gs://subastacarhn-40554.firebasestorage.app").ref();

    // Menú móvil
    function toggleMenu() {
      document.getElementById('mobile-menu-links').classList.toggle('open');
    }

    // Gestión de depósito
    const btnStartGestion  = document.getElementById('btnStartGestion');
    const depositForm      = document.getElementById('depositForm');
    const depositFile      = document.getElementById('depositFile');
    const btnUploadDeposit = document.getElementById('btnUploadDeposit');
    const depositSuccess   = document.getElementById('depositSuccess');

    btnStartGestion.onclick = () => {
      depositForm.style.display = 'block';
      btnStartGestion.style.display = 'none';
      depositSuccess.style.display = 'none';
      depositForm.scrollIntoView({ behavior: 'smooth' });
    };

    btnUploadDeposit.onclick = async () => {
      if (!depositFile.files[0]) {
        alert('Selecciona un comprobante antes de enviar.');
        return;
      }
      btnUploadDeposit.disabled = true;
      btnUploadDeposit.textContent = 'Subiendo...';
      try {
        const user = auth.currentUser;
        const file = depositFile.files[0];
        const filePath = `orders/${user.uid}/deposit/${Date.now()}_${file.name}`;
        const snap = await storage.child(filePath).put(file);
        const url = await snap.ref.getDownloadURL();
        const payload = {
          clientName: user.displayName||user.email,
          clientEmail: user.email,
          clientPhone: document.getElementById('phone').value,
          precioEstimado: null,
          depositReceiptUrl: url,
          depositAmount: 5000,
          copartPhotos: [],
          recogida: { valorGrua:0, valorBarco:0 },
          envioHnd: { detail:'' },
          aduana: { detail:'' },
          entrega: { detail:'', precioFinal:0, deliveryPhotos:[] },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('orders').add(payload);
        depositForm.style.display = 'none';
        depositSuccess.style.display = 'block';
        fetchClientOrders();
      } catch (err) {
        console.error(err);
        alert('❌ Error al subir el comprobante: '+err.message);
      } finally {
        btnUploadDeposit.disabled = false;
        btnUploadDeposit.textContent = 'Enviar comprobante';
      }
    };

    // Perfil y autenticación
    auth.onAuthStateChanged(async user => {
      if (!user) return window.location='login.html';
      document.getElementById('userGreeting').textContent   = `Hola, ${user.displayName||user.email}`;
      document.getElementById('mobileGreeting').textContent = `Hola, ${user.displayName||user.email}`;
      const doc = await db.collection('clients').doc(user.uid).get();
      if (doc.exists) {
        const d = doc.data();
        document.getElementById('name').value      = d.fullName||'';
        document.getElementById('email').value     = d.email   ||user.email;
        document.getElementById('phone').value     = d.phone   ||'';
        document.getElementById('address').value   = d.address ||'';
        document.getElementById('dni').value       = d.dni     ||'';
        document.getElementById('birthYear').value = d.birthYear||'';
      }
      cargarHistorial();
      fetchClientOrders();
    });

    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      const user = auth.currentUser;
      const data = {
        fullName: document.getElementById('name').value,
        address : document.getElementById('address').value,
        dni     : document.getElementById('dni').value,
        birthYear: document.getElementById('birthYear').value
      };
      await db.collection('clients').doc(user.uid).update(data);
      const msg = document.getElementById('successMsg');
      msg.style.display = 'block';
      setTimeout(()=>msg.style.display='none',3000);
    };

    function sendPasswordReset() {
      auth.sendPasswordResetEmail(auth.currentUser.email)
        .then(()=>alert('🔗 Enlace enviado al correo.'))
        .catch(()=>alert('❌ Error al enviar enlace.'));
    }
    function logout() {
      auth.signOut().then(()=>window.location='login.html');
    }

    // Historial
    async function cargarHistorial() {
      const uid = auth.currentUser.uid;
      const snap = await db.collection('clients').doc(uid)
        .collection('historial').orderBy('fecha','desc').limit(100).get();
      const cont = document.getElementById('historialContainer');
      if (snap.empty) {
        cont.innerHTML = '<p style="text-align:center;">Aún no hay cálculos guardados.</p>';
        return;
      }
      cont.innerHTML = snap.docs.map(doc => {
        const d = doc.data();
        const fecha = d.fecha?.toDate().toLocaleString('es-HN')||'Fecha desconocida';
        return `
          <div style="background:#f0f8ff;padding:1rem;border-radius:10px;margin-bottom:1rem;box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <input type="text" value="${d.nombre||'Sin título'}"
              onchange="renombrarHistorial('${doc.id}',this.value)"
              style="font-weight:bold;border:none;background:transparent;color:var(--blue2);width:100%;"/>
            <small>${fecha}</small><br>
            <strong style="color:var(--blue2);">L ${d.total||'-'}</strong><br><br>
            <button class="styled-btn" onclick="verDetallesHistorial('${doc.id}')">Ver detalles</button>
          </div>
        `;
      }).join('');
    }

    async function renombrarHistorial(id,nombre) {
      try {
        await db.collection('clients').doc(auth.currentUser.uid)
          .collection('historial').doc(id).update({ nombre });
        // confirmación
        const cont = document.getElementById(`historial-${id}`);
        const msg = document.createElement('div');
        msg.className='success-msg';
        msg.textContent='✅ Nombre actualizado';
        cont.appendChild(msg);
        setTimeout(()=>msg.remove(),3000);
      } catch {
        alert('❌ No se pudo renombrar.');
      }
    }

    function verDetallesHistorial(id) {
      document.querySelectorAll('.detalle-abierto').forEach(e=>e.remove());
      db.collection('clients').doc(auth.currentUser.uid)
        .collection('historial').doc(id).get()
        .then(doc=>{
          if(!doc.exists) return alert('❌ No se encontró este cálculo.');
          const d=doc.data();
          const cont=document.getElementById(`historial-${id}`);
          const detalle=document.createElement('div');
          detalle.classList.add('detalle-abierto');
          detalle.innerHTML=`
            <div style="margin-top:1rem;border:1px dashed #ccc;border-radius:10px;padding:10px;">
              <table style="width:100%;border-collapse:collapse;">
                <tr><th>Concepto</th><th>Valor</th></tr>
                ${d.detalles.map(i=>`
                  <tr><td style="border:1px solid #ddd;padding:6px;">${i.titulo}</td>
                      <td style="border:1px solid #ddd;padding:6px;">${i.valor}</td></tr>
                `).join('')}
              </table>
              <button class="styled-btn" onclick="this.closest('.detalle-abierto').remove()">Cerrar</button>
            </div>
          `;
          cont.appendChild(detalle);
        });
    }

    // Gestión de órdenes
    function getDisplayStatus(o) {
      if (o.depositReceiptUrl) return 'Pago Pendiente';
      if (o.entrega?.deliveryPhotos?.length) return 'Finalizado';
      if (o.aduana?.detail) return 'Aduana';
      if (o.recogida?.valorGrua||o.recogida?.valorBarco) return 'Enviado';
      return 'Inicio';
    }
    async function fetchClientOrders() {
      const user=auth.currentUser;
      if(!user)return;
      const STEPS=['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];
      const cont=document.getElementById('clientOrdersContainer');
      cont.innerHTML='';
      const snap=await db.collection('orders')
        .where('clientEmail','==',user.email)
        .orderBy('createdAt','desc').get();
      if(snap.empty){
        cont.innerHTML='<p style="text-align:center;">Aún no tienes gestiones iniciadas.</p>';
        return;
      }
      snap.docs.forEach(doc=>{
        const o=doc.data(), status=getDisplayStatus(o);
        const steps=o? STEPS.map((s,i)=>{
          const cls=i<STEPS.indexOf(status)?'done':i===STEPS.indexOf(status)?'active':'';
          return `<li class="${cls}">${s}</li>`;
        }).join(''): '';
        const card=document.createElement('div');
        card.className='order-card';
        card.innerHTML=`
          <div class="accordion-header" data-acc="${doc.id}">
            <div><strong>#${doc.id.slice(0,6)}</strong> ${o.clientName}</div>
            <div><span class="status-badge">${status}</span></div>
          </div>
          <div id="acc-${doc.id}" class="accordion-content">
            <ul class="tracker">${steps}</ul>
            <ul class="summary">
              <li><strong>Depósito:</strong> ${o.depositAmount||'-'} LPS</li>
              <li><strong>Comprobante:</strong> ${o.depositReceiptUrl
                ? `<a href="${o.depositReceiptUrl}" target="_blank">Ver comprobante</a>`:'-'}</li>
            </ul>
          </div>
        `;
        cont.appendChild(card);
      });
      document.querySelectorAll('.accordion-header').forEach(h=>h.onclick=()=>{
        const acc=document.getElementById('acc-'+h.dataset.acc);
        acc.classList.toggle('open');
      });
    }

    // Lógica de pestañas
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.onclick=()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-'+tab.dataset.sec).classList.add('active');
      };
    });
  </script>
</body>
</html>
