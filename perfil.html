<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Perfil – SubastaCarHN</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <meta name="theme-color" content="#002f6c" />
  <style>
    :root {
      --blue: #002f6c;
      --blue2: #004aad;
      --yellow: #ffc20e;
      --text: #333;
      --light: #f9f9f9;
      --shadow: rgba(0,0,0,0.1);
      --max-width: 1200px;
      --card-radius: 8px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', sans-serif; background: var(--light); color: var(--text); }
    a { text-decoration: none; color: inherit; }
    .container { max-width: var(--max-width); margin: 0 auto; padding: 1rem; }
    header, footer { background: var(--blue); color: #fff; }
    header .nav, footer .nav { display: flex; justify-content: center; gap: 1rem; padding: 1rem 0; }
    header .nav a, footer .nav a { color: var(--yellow); font-weight: 600; }
    main { padding: 1rem 0; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 2px solid var(--blue2); margin-bottom: 1rem; }
    .tab { flex: 1; text-align: center; padding: 0.75rem; cursor: pointer; background: var(--blue2); color: #fff; font-weight: 600; }
    .tab.active { background: var(--blue); }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Cards */
    .card { background: #fff; border-radius: var(--card-radius); box-shadow: 0 2px 8px var(--shadow); margin-bottom: 1rem; overflow: hidden; }
    .card-header { background: var(--blue2); color: #fff; padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .card-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; padding: 0 1rem; }
    .card-body.open { padding: 1rem; max-height: 800px; }
    .status-badge { background: var(--yellow); color: var(--text); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    .tracker { list-style: none; display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 0; margin-bottom: 1rem; }
    .tracker li { position: relative; padding-left: 1.2rem; font-size: 0.8rem; }
    .tracker li::before { content: ''; position: absolute; left: 0; top: 0.2rem; width: 0.8rem; height: 0.8rem; border-radius: 50%; background: #ccc; }
    .tracker li.done::before { background: var(--yellow); }
    .tracker li.active::before { background: var(--blue); }

    .btn { background: var(--yellow); color: var(--blue); border: none; padding: 0.75rem 1rem; border-radius: var(--card-radius); cursor: pointer; font-weight: 600; }
    form .grid { display: grid; gap: 0.75rem; }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    input, select, textarea { width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>SubastaCarHN</h1>
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="calculadora.html">Calculadora</a>
        <a href="inventario.html">Vehículos</a>
        <a href="cursos.html">Cursos</a>
        <span id="userGreeting"></span>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-sec="perfil">Perfil</div>
      <div class="tab" data-sec="gestion">Gestión</div>
      <div class="tab" data-sec="historial">Historial</div>
    </div>

    <!-- Sección Perfil -->
    <section id="section-perfil" class="section active">
      <div class="card">
        <div class="card-header">Mi Perfil</div>
        <div class="card-body open">
          <form id="profileForm" class="grid grid-2">
            <label>Nombre<input type="text" id="name" required></label>
            <label>Email<input type="email" id="email" readonly></label>
            <label>Teléfono<input type="tel" id="phone" readonly></label>
            <label>Dirección<input id="address"></label>
            <label>DNI<input id="dni"></label>
            <label>Año nacimiento<input type="number" id="birthYear" min="1900" max="2100"></label>
            <div></div>
            <button type="submit" class="btn">Guardar cambios</button>
            <button type="button" class="btn" onclick="sendPasswordReset()">Cambiar contraseña</button>
            <button type="button" class="btn" onclick="logout()">Cerrar sesión</button>
          </form>
        </div>
      </div>
    </section>

    <!-- Sección Gestión -->
    <section id="section-gestion" class="section">
      <div class="card">
        <div class="card-header">Nueva Gestión</div>
        <div class="card-body open grid">
          <button id="btnStartGestion" class="btn">Comenzar gestión (5,000 LPS)</button>
          <div id="depositForm" style="display:none;" class="grid grid-2">
            <input type="file" id="depositFile" accept="application/pdf,image/*">
            <button id="btnUploadDeposit" class="btn">Enviar comprobante</button>
          </div>
          <div id="depositSuccess" class="card-body open" style="display:none;">✅ Comprobante subido</div>
        </div>
      </div>

      <h2>Mis Gestiones</h2>
      <div id="orders" class="orders-grid"></div>
    </section>

    <!-- Sección Historial -->
    <section id="section-historial" class="section">
      <div class="card">
        <div class="card-header">Historial de Cálculos</div>
        <div class="card-body open" id="historialContainer"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <nav class="nav">
        <a href="index.html">Inicio</a>
        <a href="calculadora.html">Calculadora</a>
        <a href="inventario.html">Vehículos</a>
      </nav>
    </div>
  </footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script>
    // Inicializar Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyA5BuOwgEUYK1JMwJD0PL0k0rcAST_Koms",
      authDomain: "subastacarhn-40554.firebaseapp.com",
      projectId: "subastacarhn-40554",
      storageBucket: "subastacarhn-40554.appspot.com",
      messagingSenderId: "536785797974",
      appId: "1:536785797974:web:e3eabb4dcd898c2ffe8cf7",
      measurementId: "G-QM5N60K8C0"
    });
    const auth = firebase.auth(), db = firebase.firestore(), storage = firebase.storage().ref();

    // Helpers
    const STEPS = ['Inicio','Pago Pendiente','Pagado','Enviado','Aduana','Finalizado'];
    const $ = s => document.querySelector(s);

    // Pestañas
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('section-' + tab.dataset.sec).classList.add('active');
      };
    });

    // Listener acordeones
    document.addEventListener('click', e => {
      if (e.target.classList.contains('card-header')) {
        e.target.nextElementSibling.classList.toggle('open');
      }
    });

    // Autenticación
    auth.onAuthStateChanged(user => {
      if (!user) return location = 'login.html';
      $('#userGreeting').textContent = `Hola, ${user.displayName || user.email}`;
      loadProfile(user);
      loadOrders(user);
      loadHistorial(user);
    });

    // Perfil
    function loadProfile(u) {
      db.collection('clients').doc(u.uid).get().then(doc => {
        if (!doc.exists) return;
        const d = doc.data();
        $('#name').value = d.fullName || '';
        $('#email').value = d.email || u.email;
        $('#phone').value = d.phone || '';
        $('#address').value = d.address || '';
        $('#dni').value = d.dni || '';
        $('#birthYear').value = d.birthYear || '';
      });
    }
    $('#profileForm').onsubmit = e => {
      e.preventDefault();
      const u = auth.currentUser;
      db.collection('clients').doc(u.uid).set({
        fullName: $('#name').value,
        address: $('#address').value,
        dni: $('#dni').value,
        birthYear: parseInt($('#birthYear').value) || null
      }, { merge: true }).then(() => alert('Perfil actualizado'));
    };
    function sendPasswordReset() { auth.sendPasswordResetEmail(auth.currentUser.email).then(() => alert('Enlace enviado')); }
    function logout() { auth.signOut().then(() => location = 'login.html'); }

    // Gestión de depósitos y pedidos
    $('#btnStartGestion').onclick = () => $('#depositForm').style.display = 'grid';
    $('#btnUploadDeposit').onclick = async () => {
      const file = $('#depositFile').files[0]; if (!file) return alert('Selecciona comprobante');
      $('#btnUploadDeposit').disabled = true;
      try {
        const u = auth.currentUser;
        const snap = await storage.child(`orders/${u.uid}/deposit/${Date.now()}_${file.name}`).put(file);
        const url = await snap.ref.getDownloadURL();
        await db.collection('orders').add({
          clientName: u.displayName || u.email,
          clientEmail: u.email,
          depositReceiptUrl: url,
          depositAmount: 5000,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        $('#depositSuccess').style.display = 'block';
        loadOrders(u);
      } catch (err) { console.error(err); alert('Error al subir'); }
      finally { $('#btnUploadDeposit').disabled = false; }
    };

    // Mostrar órdenes
    async function loadOrders(u) {
      const snap = await db.collection('orders')
        .where('clientEmail','==',u.email)
        .orderBy('createdAt','desc')
        .get();
      const c = $('#orders'); c.innerHTML = '';
      if (snap.empty) { c.innerHTML = '<p style="text-align:center;">No tienes gestiones.</p>'; return; }
      snap.docs.forEach(doc => {
        const o = doc.data();
        const status = getStatus(o);
        const card = document.createElement('div'); card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            #${doc.id.slice(0,6)} ${o.clientName}
            <span class="status-badge">${status}</span>
          </div>
          <div class="card-body">
            <ul class="tracker">
              ${STEPS.map(s => {
                const idx = STEPS.indexOf(status);
                const cls = STEPS.indexOf(s) < idx ? 'done'
                          : STEPS.indexOf(s) === idx ? 'active'
                          : '';
                return `<li class="${cls}">${s}</li>`;
              }).join('')}
            </ul>
          </div>`;
        c.appendChild(card);
      });
    }
    function getStatus(o) {
      if (o.depositReceiptUrl) return 'Pago Pendiente';
      if (o.entrega?.deliveryPhotos?.length) return 'Finalizado';
      if (o.aduana?.detail) return 'Aduana';
      if (o.recogida?.valorGrua || o.recogida?.valorBarco) return 'Enviado';
      if (o.copartInvoiceUrl) return 'Pagado';
      return 'Inicio';
    }

    // Historial cálculos
    async function loadHistorial(u) {
      const snap = await db.collection('clients').doc(u.uid)
        .collection('historial').orderBy('fecha','desc').limit(100).get();
      const cont = $('#historialContainer'); cont.innerHTML = '';
      if (snap.empty) { cont.innerHTML = '<p style="text-align:center;">Sin cálculos.</p>'; return; }
      snap.docs.forEach(doc => {
        const d = doc.data();
        const fecha = d.fecha?.toDate().toLocaleString('es-HN') || 'Fecha';
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `
          <div class="card-header">${d.nombre||'Sin título'}<span>${fecha}</span></div>
          <div class="card-body open">
            <strong>Total: L ${d.total||'-'}</strong>
          </div>`;
        cont.append(div);
      });
    }
  </script>
</body>
</html>
