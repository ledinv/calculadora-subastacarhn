<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora – SubastaCarHN</title>

  <!-- Favicons -->
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <!-- Estilo -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Script de tarifas -->
  <script defer src="gruas.js"></script>
  <!-- Script principal -->
  <script defer src="script.js"></script>
</head>
<body>
  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <div id="content" style="display:none;">
    <h1 class="titulo">Calculadora de Importación de Vehículos</h1>
    <p class="soporte">¿Necesitás ayuda? <a href="https://wa.me/50497330137" target="_blank">Soporte gratuito</a> al <span class="verde">+504 9733-0137</span></p>

    <div class="layout">
      <!-- Imagen izquierda -->
      <div class="banner">
        <img src="https://raw.githubusercontent.com/ledinv/calculadora-subastacarhn/main/lateral%20izquierdo.jpeg" alt="Banner Izquierdo" />
      </div>

      <!-- Calculadora -->
      <div class="contenido-central">
        <label for="c1">Monto de Oferta $:</label>
        <input type="number" id="c1" />

        <label for="c7">Precio de Barco $:</label>
        <input type="number" id="c7" />

        <label for="c8">Precio de Grua $:</label>
        <input type="number" id="c8" />

        <label for="e2">Tipo de Cambio:</label>
        <input type="number" id="e2" value="25.90" readonly />

        <label for="c13">VIN:</label>
        <select id="c13" onchange="bloquearMotorPorVin()">
          <option value="OTROS" selected>OTROS</option>
          <option value="1,4,5">1,4,5</option>
        </select>

        <label for="c14">Tipo de Vehículo:</label>
        <select id="c14">
          <option value="OTROS">TURISMO / CAMIONETAS</option>
          <option value="PICK UP">PICK UP</option>
          <option value="HIBRIDO">HIBRIDO</option>
          <option value="CAMION">CAMION</option>
          <option value="BUS">BUS</option>
          <option value="MAQUINARIA">MAQUINARIA</option>
          <option value="MOTO">MOTO</option>
        </select>

        <label for="motor">Tipo de Motor:</label>
        <select id="motor">
          <option value="">Seleccionar...</option>
          <option value="1.5 Inferior">1.5 Inferior</option>
          <option value="Superior 1.5">Superior 1.5</option>
        </select>

        <button type="button" class="styled-btn" onclick="calcular()">Calcular</button>
        <button type="button" class="styled-btn" onclick="reiniciar()">Reiniciar</button>

        <!-- Resultados -->
        <div id="results" style="margin-top: 1rem;"></div>
      </div>

      <!-- Consulta de Grúa y Barco -->
      <div class="contenido-central">
        <h3 style="text-align:center;">Consulta Automática de Grúa y Barco</h3>

        <label for="estadoSelect">Estado:</label>
        <select id="estadoSelect" onchange="cargarCiudades()"></select>

        <label for="ciudadSelect">Ciudad:</label>
        <select id="ciudadSelect"></select>

        <label for="vehiculoSelect">Tipo de vehículo:</label>
        <select id="vehiculoSelect">
          <option value="Turismos Pequeños">Turismos Pequeños</option>
          <option value="Turismos Grande">Turismos Grande</option>
          <option value="Camionetas Regulares">Camionetas Regulares</option>
          <option value="Camionetas Grandes">Camionetas Grandes</option>
          <option value="Camionetas XL">Camionetas XL</option>
          <option value="Motos Regulares">Motos Regulares</option>
          <option value="Marcas Exclusivas">Marcas Exclusivas</option>
          <option value="Cabina Sencilla (no excediendo 16')">Cabina Sencilla</option>
          <option value="Cabina y Media (baja)">Cabina y Media (baja)</option>
          <option value="Cabina y Media (alto) y doble cabina">Cabina y Media (alto)</option>
          <option value="Extra Grandes (más de 17'3'')">Extra Grandes</option>
        </select>

        <button onclick="buscarRuta()" class="styled-btn" style="margin-top:1rem;">Buscar</button>

        <div id="resultadoGrua" style="margin-top:1rem; display:none;">
          <p id="precioBarco"></p>
          <p id="precioGrua"></p>
        </div>

        <div id="mensajeError" style="color:red; display:none; margin-top:1rem;">
          No se encontró una coincidencia para tu búsqueda.
        </div>

        <div style="margin-top:1rem; text-align:center;">
          <a href="https://wa.me/50497330137?text=Hola,%20quiero%20coordinar%20una%20revisión%20de%20grúa%20y%20barco" class="styled-btn" target="_blank">
            Coordina con nosotros
          </a>
        </div>
      </div>
    </div>

    <!-- Soporte flotante -->
    <a href="https://wa.me/50497330137" class="soporte-gratis" target="_blank">Cotízalo ya</a>
  </div>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <!-- Inicializar carga de estados -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      cargarEstados();
    });
  </script>

  <!-- Auto-relleno desde la extensión (VIN/CAFTA, monto, tipo de vehículo, motor) -->
  <script>
  (function () {
    const q = new URLSearchParams(location.search);
    const get = (k) => q.get(k) || "";

    const vin       = get("vin");
    const make      = get("make");
    const model     = get("model");
    const value_usd = get("value_usd");
    const est_mid   = get("est_mid");
    const motorURL  = get("motor"); // opcional

    function setVal(id, v) {
      const el = document.getElementById(id);
      if (!el || v === "") return;
      el.value = v;
      el.dispatchEvent(new Event("input",  { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));
    }

    // 1) VIN/CAFTA primero
    let cafta = "OTROS";
    if (vin && ["1","4","5"].includes(vin.trim()[0])) cafta = "1,4,5";
    setVal("c13", cafta);
    if (typeof window.bloquearMotorPorVin === "function") {
      try { window.bloquearMotorPorVin(); } catch(e){}
    }

    // 2) Monto
    const oferta = value_usd || est_mid || "";
    setVal("c1", oferta);

    // 3) Tipo de vehículo
    const txt = `${make||""} ${model||""}`.toLowerCase();
    const isPickup = /silverado|sierra|f-150|f150|ram|tundra|tacoma|frontier|ranger|colorado|maverick|hilux|l200|d-?max|navara|ridgeline/.test(txt);
    setVal("c14", isPickup ? "PICK UP" : "OTROS");

    // 4) Motor SOLO si VIN = OTROS
    (function () {
      const motorEl = document.getElementById("motor");
      if (!motorEl) return;
      if (cafta !== "OTROS") { motorEl.value = ""; motorEl.dispatchEvent(new Event("change",{bubbles:true})); return; }
      let motorValue = motorURL || "";
      if (!motorValue) {
        const m = /(\d\.\d)/.exec(model || "");
        if (m) {
          const litros = parseFloat(m[1]);
          motorValue = (litros <= 1.5) ? "1.5 Inferior" : "Superior 1.5";
        }
      }
      if (motorValue) setVal("motor", motorValue);
    })();

    // 5) Calcular solo si requisitos básicos listos
    function ready() {
      const c1    = document.getElementById("c1")?.value;
      const c13   = document.getElementById("c13")?.value;
      const motor = document.getElementById("motor")?.value;
      if (!c1) return false;
      if (c13 === "OTROS" && !motor) return false;
      return true;
    }
    setTimeout(() => {
      if (typeof window.calcular === "function" && ready()) window.calcular();
    }, 400);
  })();
  </script>

  <!-- Auto-grúa desde ?location (toma SIEMPRE el precio más alto) + Barco fijo 900 -->
  <script>
  (function () {
    /* ====== Utilidades ====== */
    const rmAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slug  = s => rmAcc(String(s||'').toLowerCase()).replace(/[^a-z0-9]+/g,' ').trim();

    // Normaliza nombres de ciudad (quita direcciones, marcas y sublotes; homologa "ft"->"fort")
    function normCity(s) {
      let x = slug(s)
        .replace(/\b(copart|iaai|auction|facility|location|manheim|sublot|sublote)\b/g,'')
        .replace(/\b(central|north|south|east|west|norte|sur|este|oeste)\b/g,'')
        .replace(/\bft\b\.?/g,'fort')
        .replace(/\s+/g,' ')
        .trim();
      const ALIASES = {
        'wpb': 'west palm beach',
        'west palm': 'west palm beach',
        'ft lauderdale': 'fort lauderdale',
        'newburg': 'newburgh'
      };
      return ALIASES[x] || x;
    }

    // Parse de la cadena de ubicación que manda la extensión
    function parseCityState(s) {
      if (!s) return { city:'', stateRaw:'' };
      // "City (ST)"
      let m = s.match(/^\s*([^()]+)\(\s*([A-Za-z]{2})\s*\)\s*$/);
      if (m) return { city: m[1].trim(), stateRaw: m[2].toUpperCase() };
      // "ST - City"
      if (s.includes(' - ')) {
        const p = s.split(' - ');
        return { stateRaw: p[0].trim(), city: p.slice(1).join(' - ').trim() };
      }
      // "City, ST"
      if (s.includes(',')) {
        const p = s.split(',');
        return { city: p[0].trim(), stateRaw: p[1].trim() };
      }
      // "City ST" (sigla)
      m = slug(s).match(/\b([a-z]{2})$/);
      if (m) return { city: s.replace(new RegExp(m[1]+'$','i'), '').trim(), stateRaw: m[1].toUpperCase() };
      return { city: s.trim(), stateRaw: '' };
    }

    const STATES = {
      AL:'Alabama', AK:'Alaska', AZ:'Arizona', AR:'Arkansas', CA:'California', CO:'Colorado', CT:'Connecticut',
      DE:'Delaware', FL:'Florida', GA:'Georgia', HI:'Hawaii', ID:'Idaho', IL:'Illinois', IN:'Indiana', IA:'Iowa',
      KS:'Kansas', KY:'Kentucky', LA:'Louisiana', ME:'Maine', MD:'Maryland', MA:'Massachusetts', MI:'Michigan',
      MN:'Minnesota', MS:'Mississippi', MO:'Missouri', MT:'Montana', NE:'Nebraska', NV:'Nevada', NH:'New Hampshire',
      NJ:'New Jersey', NM:'New Mexico', NY:'New York', NC:'North Carolina', ND:'North Dakota', OH:'Ohio', OK:'Oklahoma',
      OR:'Oregon', PA:'Pennsylvania', RI:'Rhode Island', SC:'South Carolina', SD:'South Dakota', TN:'Tennessee',
      TX:'Texas', UT:'Utah', VT:'Vermont', VA:'Virginia', WA:'Washington', WV:'West Virginia', WI:'Wisconsin', WY:'Wyoming'
    };

    // Lee los tarifarios (cuando ya cargó gruas.js)
    function getPortTarifs() {
      const F = (typeof tarifarioGruasPuertoFlorida  !== 'undefined') ? tarifarioGruasPuertoFlorida  : {};
      const T = (typeof tarifarioGruasPuertoTexas    !== 'undefined') ? tarifarioGruasPuertoTexas    : {};
      const D = (typeof tarifarioGruasPuertoDelaware !== 'undefined') ? tarifarioGruasPuertoDelaware : {};
      return [
        { name: 'Florida',  data: F },
        { name: 'Texas',    data: T },
        { name: 'Delaware', data: D }
      ];
    }

    function getAllStateNames() {
      const set = new Set();
      for (const p of getPortTarifs()) Object.keys(p.data).forEach(s => set.add(s));
      return Array.from(set);
    }

    function resolveStateName(token) {
      if (!token) return '';
      const t = token.trim();
      const code = t.toUpperCase();
      if (code.length === 2 && STATES[code]) return STATES[code]; // NY -> New York
      const wanted = slug(t);
      const hit = getAllStateNames().find(n => slug(n) === wanted);
      return hit || '';
    }

    // Devuelve el precio MÁS ALTO (y de qué puerto/ciudad salió) para ese estado+ciudad
    function getMaxGruaPrice(stateName, cityInput) {
      const ports = getPortTarifs();
      const cityN = normCity(cityInput || '');
      let best = { price:null, bestCity:null, bestPort:null, bestState:null };

      const stateNames = stateName ? [stateName] : getAllStateNames(); // si no viene estado, busco en todos

      for (const sName of stateNames) {
        for (const port of ports) {
          const table = port.data[sName];
          if (!table) continue;
          for (const [cityKey, price] of Object.entries(table)) {
            const ck = normCity(cityKey);
            if (!cityN || ck.includes(cityN) || cityN.includes(ck)) {
              const p = Number(price);
              if (best.price == null || p > best.price) {
                best = { price: p, bestCity: cityKey, bestPort: port.name, bestState: sName };
              }
            }
          }
        }
      }
      return best;
    }

    // Selección flexible en selects
    function matchOptionFlexible(sel, needle){
      if (!sel || !needle) return null;
      const n = slug(needle);
      for (const o of [...sel.options]) {
        const v = slug(o.value||''), t = slug(o.text||'');
        if ((v && (v.includes(n)||n.includes(v))) || (t && (t.includes(n)||n.includes(t)))) return o;
      }
      return null;
    }

    function waitFor(test, done, tries=60, ms=120){
      const t=setInterval(()=>{ if(test()){clearInterval(t); done();} else if(--tries<=0){clearInterval(t);} },ms);
    }

    // Rellena #c8 y, si se puede, refleja Estado/Ciudad en la UI + buscarRuta()
    function applyGruaToForm(stateName, cityExact, price) {
      const c8 = document.getElementById('c8');
      if (c8 && price != null) {
        c8.value = price;
        c8.dispatchEvent(new Event('input',  { bubbles:true }));
        c8.dispatchEvent(new Event('change', { bubbles:true }));
      }

      const estadoSel = document.getElementById('estadoSelect');
      const ciudadSel = document.getElementById('ciudadSelect');

      if (estadoSel && stateName) {
        const opt = matchOptionFlexible(estadoSel, stateName);
        if (opt) {
          estadoSel.value = opt.value;
          estadoSel.dispatchEvent(new Event('change', { bubbles:true })); // llenará ciudades

          waitFor(() => ciudadSel && ciudadSel.options && ciudadSel.options.length > 1, () => {
            const cOpt = matchOptionFlexible(ciudadSel, cityExact);
            if (cOpt) {
              ciudadSel.value = cOpt.value;
              ciudadSel.dispatchEvent(new Event('change', { bubbles:true }));
            }
            // tipo de vehiculo sugerido
            const tipo = document.getElementById('c14')?.value || 'OTROS';
            const vehSel = document.getElementById('vehiculoSelect');
            if (vehSel) {
              const target = (tipo === 'PICK UP') ? 'Camionetas Regulares' : 'Turismos Pequeños';
              const vOpt = matchOptionFlexible(vehSel, target);
              if (vOpt) vehSel.value = vOpt.value;
            }
            if (typeof window.buscarRuta === 'function') window.buscarRuta();
          });
        }
      }

      if (typeof window.calcular === 'function') setTimeout(() => window.calcular(), 120);
    }

    /* ====== (A) Barco fijo = 900 ====== */
    document.addEventListener('DOMContentLoaded', () => {
      const barco = document.getElementById('c7');
      if (barco) {
        barco.value = '900';
        barco.dispatchEvent(new Event('input',  { bubbles:true }));
        barco.dispatchEvent(new Event('change', { bubbles:true }));
      }
    });

    /* ====== (B) Tomar ?location=, buscar MAX y poner en #c8 ====== */
    document.addEventListener('DOMContentLoaded', () => {
      const q = new URLSearchParams(location.search);
      const locationRaw = q.get('location') || '';   // ej: "Taunton (MA)" | "NY - Newburgh" | "Miami, FL" | "fl - miami central"
      if (!locationRaw) return;

      const { city, stateRaw } = parseCityState(locationRaw);
      const stateName = resolveStateName(stateRaw);
      const { price, bestCity, bestState } = getMaxGruaPrice(stateName, city);

      if (price != null) {
        applyGruaToForm(bestState || stateName, bestCity || city, price);
      }
    });

    /* ====== (C) Al usar “Buscar”, también actualizar #c8 con el MAX ====== */
    document.addEventListener('DOMContentLoaded', () => {
      const original = window.buscarRuta;
      if (typeof original === 'function') {
        window.buscarRuta = function () {
          const r = original.apply(this, arguments);
          try {
            const est = document.getElementById('estadoSelect')?.value || '';
            const ciu = document.getElementById('ciudadSelect')?.value || '';
            const { price, bestCity, bestState } = getMaxGruaPrice(est, ciu);
            if (price != null) applyGruaToForm(bestState || est, bestCity || ciu, price);
          } catch(_) {}
          return r;
        };
      }

      // y si el usuario cambia el estado/ciudad manualmente, refrescamos #c8
      const estSel = document.getElementById('estadoSelect');
      const ciuSel = document.getElementById('ciudadSelect');
      if (estSel) estSel.addEventListener('change', () => setTimeout(() => {
        const est = estSel.value, ciu = ciuSel?.value || '';
        const { price, bestCity, bestState } = getMaxGruaPrice(est, ciu);
        if (price != null) applyGruaToForm(bestState || est, bestCity || ciu, price);
      }, 100));
      if (ciuSel) ciuSel.addEventListener('change', () => {
        const est = estSel?.value || '', ciu = ciuSel.value;
        const { price, bestCity, bestState } = getMaxGruaPrice(est, ciu);
        if (price != null) applyGruaToForm(bestState || est, bestCity || ciu, price);
      });
    });

  })();
  </script>
</body>
</html>
