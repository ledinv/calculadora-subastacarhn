<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora – SubastaCarHN</title>

  <!-- Favicons -->
  <link rel="manifest" href="Img/site.webmanifest">
  <link rel="apple-touch-icon" sizes="180x180" href="Img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="Img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="Img/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="192x192" href="Img/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="Img/android-chrome-512x512.png">
  <meta name="theme-color" content="#002f6c">

  <!-- Estilo -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Script de tarifas -->
  <script defer src="gruas.js"></script>
  <!-- Script principal -->
  <script defer src="script.js"></script>
</head>
<body>
  <!-- HEADER -->
  <div id="header-placeholder"></div>

  <div id="content" style="display:none;">
    <h1 class="titulo">Calculadora de Importación de Vehículos</h1>
    <p class="soporte">¿Necesitás ayuda? <a href="https://wa.me/50497330137" target="_blank">Soporte gratuito</a> al <span class="verde">+504 9733-0137</span></p>

    <div class="layout">
      <!-- Imagen izquierda -->
      <div class="banner">
        <img src="https://raw.githubusercontent.com/ledinv/calculadora-subastacarhn/main/lateral%20izquierdo.jpeg" alt="Banner Izquierdo" />
      </div>

      <!-- Calculadora -->
      <div class="contenido-central">
        <label for="c1">Monto de Oferta $:</label>
        <input type="number" id="c1" />

        <label for="c7">Precio de Barco $:</label>
        <input type="number" id="c7" />

        <label for="c8">Precio de Grua $:</label>
        <input type="number" id="c8" />

        <label for="e2">Tipo de Cambio:</label>
        <input type="number" id="e2" value="25.90" readonly />

        <label for="c13">VIN:</label>
        <select id="c13" onchange="bloquearMotorPorVin()">
          <option value="OTROS" selected>OTROS</option>
          <option value="1,4,5">1,4,5</option>
        </select>

        <label for="c14">Tipo de Vehículo:</label>
        <select id="c14">
          <option value="OTROS">TURISMO / CAMIONETAS</option>
          <option value="PICK UP">PICK UP</option>
          <option value="HIBRIDO">HIBRIDO</option>
          <option value="CAMION">CAMION</option>
          <option value="BUS">BUS</option>
          <option value="MAQUINARIA">MAQUINARIA</option>
          <option value="MOTO">MOTO</option>
        </select>

        <label for="motor">Tipo de Motor:</label>
        <select id="motor">
          <option value="">Seleccionar...</option>
          <option value="1.5 Inferior">1.5 Inferior</option>
          <option value="Superior 1.5">Superior 1.5</option>
        </select>

        <button type="button" class="styled-btn" onclick="calcular()">Calcular</button>
        <button type="button" class="styled-btn" onclick="reiniciar()">Reiniciar</button>

        <!-- Resultados -->
        <div id="results" style="margin-top: 1rem;"></div>
      </div>

      <!-- Consulta de Grúa y Barco -->
      <div class="contenido-central">
        <h3 style="text-align:center;">Consulta Automática de Grúa y Barco</h3>

        <label for="estadoSelect">Estado:</label>
        <select id="estadoSelect" onchange="cargarCiudades()"></select>

        <label for="ciudadSelect">Ciudad:</label>
        <select id="ciudadSelect"></select>

        <label for="vehiculoSelect">Tipo de vehículo:</label>
        <select id="vehiculoSelect">
          <option value="Turismos Pequeños">Turismos Pequeños</option>
          <option value="Turismos Grande">Turismos Grande</option>
          <option value="Camionetas Regulares">Camionetas Regulares</option>
          <option value="Camionetas Grandes">Camionetas Grandes</option>
          <option value="Camionetas XL">Camionetas XL</option>
          <option value="Motos Regulares">Motos Regulares</option>
          <option value="Marcas Exclusivas">Marcas Exclusivas</option>
          <option value="Cabina Sencilla (no excediendo 16')">Cabina Sencilla</option>
          <option value="Cabina y Media (baja)">Cabina y Media (baja)</option>
          <option value="Cabina y Media (alto) y doble cabina">Cabina y Media (alto)</option>
          <option value="Extra Grandes (más de 17'3'')">Extra Grandes</option>
        </select>

        <button onclick="buscarRuta()" class="styled-btn" style="margin-top:1rem;">Buscar</button>

        <div id="resultadoGrua" style="margin-top:1rem; display:none;">
          <p id="precioBarco"></p>
          <p id="precioGrua"></p>
        </div>

        <div id="mensajeError" style="color:red; display:none; margin-top:1rem;">
          No se encontró una coincidencia para tu búsqueda.
        </div>

        <div style="margin-top:1rem; text-align:center;">
          <a href="https://wa.me/50497330137?text=Hola,%20quiero%20coordinar%20una%20revisión%20de%20grúa%20y%20barco" class="styled-btn" target="_blank">
            Coordina con nosotros
          </a>
        </div>
      </div>
    </div>

    <!-- Soporte flotante -->
    <a href="https://wa.me/50497330137" class="soporte-gratis" target="_blank">Cotízalo ya</a>
  </div>

  <!-- FOOTER -->
  <div id="footer-placeholder"></div>

  <!-- Inicializar carga de estados -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      cargarEstados();
    });
  </script>

  <!-- Auto-relleno desde la extensión (NUEVO: evita el error de motor cuando VIN es CAFTA) -->
  <script>
  (function () {
    const q = new URLSearchParams(location.search);
    const get = (k) => q.get(k) || "";

    const vin       = get("vin");
    const make      = get("make");
    const model     = get("model");
    const value_usd = get("value_usd");
    const est_mid   = get("est_mid");
    const motorURL  = get("motor"); // opcional

    function setVal(id, v) {
      const el = document.getElementById(id);
      if (!el || v === "") return;
      el.value = v;
      el.dispatchEvent(new Event("input",  { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));
    }

    // 1) VIN/CAFTA primero
    let cafta = "OTROS";
    if (vin && ["1","4","5"].includes(vin.trim()[0])) cafta = "1,4,5";
    setVal("c13", cafta);
    if (typeof window.bloquearMotorPorVin === "function") {
      try { window.bloquearMotorPorVin(); } catch(e){}
    }

    // 2) Monto
    const oferta = value_usd || est_mid || "";
    setVal("c1", oferta);

    // 3) Tipo de vehículo
    const txt = `${make||""} ${model||""}`.toLowerCase();
    const isPickup = /silverado|sierra|f-150|f150|ram|tundra|tacoma|frontier|ranger|colorado|maverick|hilux|l200|d-?max|navara|ridgeline/.test(txt);
    setVal("c14", isPickup ? "PICK UP" : "OTROS");

    // 4) Motor SOLO si VIN = OTROS
    (function () {
      const motorEl = document.getElementById("motor");
      if (!motorEl) return;
      if (cafta !== "OTROS") { motorEl.value = ""; motorEl.dispatchEvent(new Event("change",{bubbles:true})); return; }
      let motorValue = motorURL || "";
      if (!motorValue) {
        const m = /(\d\.\d)/.exec(model || "");
        if (m) {
          const litros = parseFloat(m[1]);
          motorValue = (litros <= 1.5) ? "1.5 Inferior" : "Superior 1.5";
        }
      }
      if (motorValue) setVal("motor", motorValue);
    })();

    // 5) Calcular solo si requisitos básicos listos
    function ready() {
      const c1    = document.getElementById("c1")?.value;
      const c13   = document.getElementById("c13")?.value;
      const motor = document.getElementById("motor")?.value;
      if (!c1) return false;
      if (c13 === "OTROS" && !motor) return false;
      return true;
    }
    setTimeout(() => {
      if (typeof window.calcular === "function" && ready()) window.calcular();
    }, 400);
  })();
  </script>

  <!-- Barco fijo = $900 + Grúa por ciudad (versión robusta, soporta "fl - miami central") -->
  <script>
  (function () {
    // ===== 1) BARCO FIJO = 900 USD =====
    document.addEventListener('DOMContentLoaded', () => {
      const barco = document.getElementById('c7');
      if (barco) {
        barco.value = '900';
        barco.dispatchEvent(new Event('input',  { bubbles: true }));
        barco.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });

    // ===== 2) GRÚA SEGÚN CIUDAD (usa gruas.js -> buscarRuta) =====
    const q = new URLSearchParams(location.search);
    const locationRaw = q.get('location') || ''; // ej: "fl - miami central" | "Miami, FL"
    if (!locationRaw) return;

    // ---- Helpers de normalización ----
    const rmAcc = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const slug  = s => rmAcc(String(s).toLowerCase()).replace(/[^a-z0-9]+/g,' ').trim();

    const CITY_ALIASES = {
      'miami central':'miami','miami north':'miami','miami south':'miami',
      'orlando north':'orlando','orlando south':'orlando',
      'tampa south':'tampa','jacksonville east':'jacksonville','jacksonville west':'jacksonville',
      'ft lauderdale':'fort lauderdale','fort lauderdale':'fort lauderdale',
      'west palm':'west palm beach','wpb':'west palm beach',
      'newburg':'newburgh'
    };

    function normalizeCity(s) {
      let x = slug(s)
        .replace(/\b(copart|iaai|auction|auto|facility|location)\b/g,'')
        .replace(/\b(central|north|south|east|west|norte|sur|este|oeste)\b/g,'')
        .replace(/\s+/g,' ')
        .trim();
      if (CITY_ALIASES[x]) return CITY_ALIASES[x];
      return x;
    }

    function parseCityState(s) {
      // Soporta "FL - Miami Central", "Miami, FL", "miami central fl"
      if (s.includes(' - ')) {
        const parts = s.split(' - ');
        return { state: slug(parts[0]).toUpperCase(), city: normalizeCity(parts.slice(1).join(' - ')) };
      }
      if (s.includes(',')) {
        const parts = s.split(',');
        return { city: normalizeCity(parts[0]), state: slug(parts[1]).toUpperCase() };
      }
      const m = slug(s).match(/\b([a-z]{2})$/);
      if (m) return { city: normalizeCity(s.replace(new RegExp(m[1]+'$','i'),'')), state: m[1].toUpperCase() };
      return { city: normalizeCity(s), state: '' };
    }

    function findOptionMatch(sel, needleRaw) {
      if (!sel || !needleRaw) return null;
      const n = slug(needleRaw);
      for (const o of [...sel.options]) {
        const val = slug(o.value || '');
        const txt = slug(o.text  || '');
        if (val && (val.includes(n) || n.includes(val))) return o;
        if (txt && (txt.includes(n) || n.includes(txt))) return o;
      }
      return null;
    }

    function numberFromText(txt) {
      if (!txt) return null;
      const clean = String(txt).replace(/[^\d.,]/g,'').replace(/,/g,'');
      const m = clean.match(/(\d+(\.\d+)?)/);
      return m ? m[1] : null;
    }

    const { city, state } = parseCityState(locationRaw);

    // Copiar GRÚA a #c8 cuando gruas.js muestre resultados
    document.addEventListener('DOMContentLoaded', () => {
      const resDiv = document.getElementById('resultadoGrua');
      if (!resDiv) return;
      const mo = new MutationObserver(() => {
        const gruaTxt = document.getElementById('precioGrua')?.textContent || '';
        const nGrua   = numberFromText(gruaTxt);
        const c8      = document.getElementById('c8');
        if (nGrua && c8) {
          c8.value = nGrua;
          c8.dispatchEvent(new Event('input',  { bubbles: true }));
          c8.dispatchEvent(new Event('change', { bubbles: true }));
          if (typeof window.calcular === 'function') {
            setTimeout(() => window.calcular(), 200);
          }
        }
      });
      mo.observe(resDiv, { subtree: true, childList: true, characterData: true });
    });

    // Seleccionar Estado/Ciudad y ejecutar buscarRuta()
    function waitFor(testFn, onReady, tries = 40, everyMs = 200) {
      const t = setInterval(() => {
        if (testFn()) { clearInterval(t); onReady(); }
        else if (--tries <= 0) { clearInterval(t); }
      }, everyMs);
    }

    function applyLocationAndSearch() {
      const estadoSel = document.getElementById('estadoSelect');
      const ciudadSel = document.getElementById('ciudadSelect');
      if (!estadoSel || !ciudadSel) return;

      if (state) {
        const estOpt = findOptionMatch(estadoSel, state) || findOptionMatch(estadoSel, state === 'FL' ? 'florida' : state);
        if (estOpt) {
          estadoSel.value = estOpt.value;
          estadoSel.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }

      waitFor(() => ciudadSel.options && ciudadSel.options.length > 0, () => {
        if (city) {
          const ciuOpt = findOptionMatch(ciudadSel, city);
          if (ciuOpt) {
            ciudadSel.value = ciuOpt.value;
            ciudadSel.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }

        // Ajuste simple: #c14 PICK UP -> Camionetas Regulares; resto -> Turismos Pequeños
        const tipo = document.getElementById('c14')?.value || 'OTROS';
        const vehSel = document.getElementById('vehiculoSelect');
        if (vehSel) {
          const target = (tipo === 'PICK UP') ? 'Camionetas Regulares' : 'Turismos Pequeños';
          const vehOpt = findOptionMatch(vehSel, target);
          if (vehOpt) vehSel.value = vehOpt.value;
        }

        if (typeof window.buscarRuta === 'function') {
          window.buscarRuta();
        }
      });
    }

    waitFor(
      () => document.getElementById('estadoSelect')?.options?.length > 0,
      applyLocationAndSearch
    );
  })();
  </script>
</body>
</html>
